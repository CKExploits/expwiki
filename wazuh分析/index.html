<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Wazuh分析 - expwiki</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Wazuh\u5206\u6790";
    var mkdocs_page_input_path = "wazuh\u5206\u6790.md";
    var mkdocs_page_url = "/wazuh\u5206\u6790/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> expwiki</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../acknowledgements/">Acknowledgements</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2018-1000001-01/">Cve 2018 1000001 01</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2018-1000001/">Cve 2018 1000001</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2019-12735-01/">Cve 2019 12735 01</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2019-12735/">Cve 2019 12735</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../lynis分析/">Lynis分析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../vuls分析/">Vuls分析</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Wazuh分析</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#wazuh">wazuh分析</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#1">1.简介</a></li>
        
            <li><a class="toctree-l3" href="#2">2.架构概述</a></li>
        
            <li><a class="toctree-l3" href="#3">3.具体功能</a></li>
        
            <li><a class="toctree-l3" href="#4">4.应用部署</a></li>
        
            <li><a class="toctree-l3" href="#5">5.代码分析</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../wazuh性能分析/">Wazuh性能分析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../漏洞利用知识库模版/">漏洞利用知识库模版</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">expwiki</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Wazuh分析</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="wazuh">wazuh分析</h1>
<h3 id="1">1.简介</h3>
<p>Wazuh是一个是一个开源的系统安全检测平台，它是基于另一个开源项目OSSEC HIDS发展出来的，在OSSEC的基础上集成了Elastic Stack和OpenSCAP，并增加了很多新的特性，功能更加全面。</p>
<h3 id="2">2.架构概述</h3>
<p>Wazuh的架构由Agent、Server、Elastic Stack三大部分组成。</p>
<h4 id="21-agent">2.1 Agent</h4>
<p>Agent主要功能：</p>
<ul>
<li>运行在被监控的终端机器(Monitored Endpoint)，支持Windows、Linux、Solaris, BSD,  Mac系统。收集系统和应用程序的数据，并发送到Wazuh server。</li>
<li>另外，未安装Agent的设备(Agentless devices, 防火墙，路由器，交换机等)，也可以向Wazuh server发送日志和配置信息供其分析。</li>
</ul>
<p>Agent包含的子模块：</p>
<ul>
<li>Rootcheck  rootkit检测、恶意软件检测、系统异常检测、系统配置安全检查</li>
<li>Log Collector  读取系统日志、应用日志、系统事件日志等。</li>
<li>Syscheck  文件完整性检查(FIM)、Windows注册表监控等。</li>
<li>OpenSCAP  扫描系统，寻找不符合OVAL、XCCDF、CIS benchmarks等标准的软件漏洞、系统配置</li>
<li>Agent Daemon  用于汇总其他组件的结果、压缩加密发送到Wazuh server。运行在chroot、是Agent唯一要联网的组件。</li>
</ul>
<h4 id="22-server"><strong>2.2</strong>  Server</h4>
<p>主要功能: 接收Agent传输的数据，分析数据，产生警报，还包括通信加密，Agent的认证等功能。</p>
<p>Server包含的子模块:</p>
<ul>
<li>Registration service 用于注册和认证Agents</li>
<li>Remote daemon service 用来接收Agents上传的数据</li>
<li>Analysis daemon 分析各种格式数据、匹配规则、产生警报等</li>
<li>RESTful API 提供管理、配置Agents，查看Agents状态的接口，以及Kibana可视化需要的接口</li>
</ul>
<h4 id="23-elastic-stack"><strong>2.3</strong> Elastic Stack</h4>
<p>包括Elasticsearch、Kibana、Logstash等套件，用来处理Server收集到的所有数据。</p>
<ul>
<li>Elasticsearch 用于全文检索</li>
<li>Logstach 处理日志数据</li>
<li>Kibana 用于Web可视化</li>
<li>Filebeat 用于日志数据的传输</li>
</ul>
<h4 id="24">2.4 模块间通信</h4>
<p>2.4.1 MessageQueue</p>
<p>各个模块会通过Unix-domain socket绑定到文件作为消息队列来进行进程间通信Agent的MQ位于/var/ossec/queue目录下</p>
<h3 id="3">3.具体功能</h3>
<h4 id="31">3.1 功能列表</h4>
<ul>
<li>日志收集(Log data collection)</li>
</ul>
<p>通过配置文件，配置具体要监控的日志文件</p>
<ul>
<li>文件完整性监控(FIM, File integrity monitoring)   </li>
</ul>
<p>监控文件内容、权限、用户、属性的改动。由syscheck模块完成3.4之后的版本还增加了对修改文件的进程和用户的监控功能(Auditing who-data)。</p>
<ul>
<li>恶意软件和异常行为检测(Anomaly and malware detection)    </li>
</ul>
<p>检测恶意软件，和恶意行为。主要通过进程监控、文件监控、隐藏端口、系统调用监控等手段。由rootcheck和syscheck完成。</p>
<ul>
<li>配置安全评估(Security Configuration Assessment, SCA)</li>
</ul>
<p>主要依据SCAP、CIS Benchmark 等标准安全策略对系统配置进行安全评估(依赖OpenSCAP，CIS-CAT)</p>
<ul>
<li>安全策略监控(Monitoring security policies)</li>
</ul>
<p>主要依赖Rootcheck、OpenSCAP、CIS-CAT对系统安全策略监控</p>
<ul>
<li>监控系统调用(Monitoring system calls)</li>
</ul>
<p>依赖Linux Audit System ，包括记录某个进程的系统调用等功能。</p>
<ul>
<li>命令监控(Command monitoring)</li>
</ul>
<p>可以监控没有日志产生的行为，比如监控命令的输出并转换成日志</p>
<ul>
<li>漏洞检测(Vulnerability detection)</li>
</ul>
<p>通过下载公开的漏洞信息建立数据库，与Agent的扫描信息(应用及其版本、补丁)匹配，判断系统是否存在漏洞。</p>
<ul>
<li>VirusTotal集成(VirusTotal integration)</li>
</ul>
<p>集成了VirusTotal，用来检测恶意文档和病毒。</p>
<h4 id="32">3.2 大致流程</h4>
<p>Agent上面只是做简单的日志收集，比如进程列表、安装包列表、文件Hash、日志等等，然后解析成统一的格式上传到服务器，服务端基于这些数据，匹配自己的规则来判断有没有安全风险，通过警告的方式发布(到邮件，Web管理面板等)</p>
<h3 id="4">4.应用部署</h3>
<h4 id="41">4.1 安装部署</h4>
<p>https://documentation.wazuh.com/3.10/installation-guide/index.html</p>
<h4 id="42">4.2 功能测试</h4>
<p>4.2.1 通过Wazuh-api查看Agent上安装的Package列表</p>
<pre><code>curl -u foo:bar -k -X GET &quot;http://127.0.0.1:55000/syscollector/001/packages?pretty&amp;limit=2&amp;offset=10&amp;sort=-name&quot; 

</code></pre>

<pre><code>root@ubuntu:/var/ossec/etc/shared# curl -u foo:bar -k -X GET &quot;http://127.0.0.1:55000/syscollector/001/packages?pretty&amp;limit=2&amp;offset=10&amp;sort=-name&quot;
{
   &quot;error&quot;: 0,
   &quot;data&quot;: {
      &quot;items&quot;: [
         {
            &quot;scan&quot;: {
               &quot;id&quot;: 447451738,
               &quot;time&quot;: &quot;2020/03/04 17:58:52&quot;
            },
            &quot;format&quot;: &quot;deb&quot;,
            &quot;priority&quot;: &quot;optional&quot;,
            &quot;name&quot;: &quot;anacron&quot;,
            &quot;architecture&quot;: &quot;amd64&quot;,
            &quot;version&quot;: &quot;2.3-24&quot;,
            &quot;size&quot;: 105,
            &quot;vendor&quot;: &quot;Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;&quot;,
            &quot;description&quot;: &quot;cron-like program that doesn't go by time&quot;,
            &quot;section&quot;: &quot;admin&quot;
         },
         {
            &quot;scan&quot;: {
               &quot;id&quot;: 447451738,
               &quot;time&quot;: &quot;2020/03/04 17:58:52&quot;
            },
            &quot;format&quot;: &quot;deb&quot;,
            &quot;priority&quot;: &quot;optional&quot;,
            &quot;name&quot;: &quot;apg&quot;,
            &quot;architecture&quot;: &quot;amd64&quot;,
            &quot;version&quot;: &quot;2.2.3.dfsg.1-5&quot;,
            &quot;size&quot;: 134,
            &quot;vendor&quot;: &quot;Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;&quot;,
            &quot;description&quot;: &quot;Automated Password Generator - Standalone version&quot;,
            &quot;section&quot;: &quot;admin&quot;
         }
      ],
      &quot;totalItems&quot;: 1627
   }
}

</code></pre>

<p>4.2.2 通过Wazuh-api查看Agent上进程列表</p>
<pre><code>root@ubuntu:/var/ossec/etc/shared# curl -u foo:bar -k -X GET &quot;http://127.0.0.1:55000/syscollector/001/processes?pretty&amp;limit=2&amp;offset=10&amp;sort=-name&quot;
{
   &quot;error&quot;: 0,
   &quot;data&quot;: {
      &quot;items&quot;: [
         {
            &quot;scan&quot;: {
               &quot;id&quot;: 1897014416,
               &quot;time&quot;: &quot;2020/03/04 17:59:09&quot;
            },
            &quot;share&quot;: 0,
            &quot;pgrp&quot;: 658,
            &quot;egroup&quot;: &quot;root&quot;,
            &quot;utime&quot;: 11,
            &quot;size&quot;: 1137,
            &quot;stime&quot;: 21,
            &quot;euser&quot;: &quot;root&quot;,
            &quot;cmd&quot;: &quot;/usr/sbin/acpid&quot;,
            &quot;suser&quot;: &quot;root&quot;,
            &quot;fgroup&quot;: &quot;root&quot;,
            &quot;session&quot;: 658,
            &quot;processor&quot;: 0,
            &quot;ppid&quot;: 1,
            &quot;rgroup&quot;: &quot;root&quot;,
            &quot;nice&quot;: 0,
            &quot;nlwp&quot;: 1,
            &quot;priority&quot;: 20,
            &quot;sgroup&quot;: &quot;root&quot;,
            &quot;pid&quot;: &quot;658&quot;,
            &quot;tty&quot;: 0,
            &quot;state&quot;: &quot;S&quot;,
            &quot;vm_size&quot;: 4548,
            &quot;resident&quot;: 0,
            &quot;tgid&quot;: 658,
            &quot;ruser&quot;: &quot;root&quot;,
            &quot;name&quot;: &quot;acpid&quot;,
            &quot;start_time&quot;: 659
         },
         ...
      ],
      &quot;totalItems&quot;: 328
   }
}

</code></pre>

<p>4.2.3 通过Wazuh-api查看Agent的系统调用情况</p>
<p>使用auditctl添加rules</p>
<pre><code>auditctl -a always,exit -F arch=b64 -S execve -F euid=0 -F key=audit-wazuh-c
auditctl -a always,exit -F arch=b64 -S execve -F euid=0 -F key=audit-wazuh-c

</code></pre>

<p>agent配置System calls monitoring 并重启</p>
<pre><code>&lt;localfile&gt;
  &lt;log_format&gt;audit&lt;/log_format&gt;
  &lt;location&gt;/var/log/audit/audit.log&lt;/location&gt;
&lt;/localfile&gt;

</code></pre>

<p>在Server的Alters日志中查看结果</p>
<pre><code>** Alert 1584080579.5902420: - audit,audit_command,gdpr_IV_30.1.g,
2020 Mar 12 23:22:59 (ubuntu-virtual-machine) 192.168.1.15-&gt;/var/log/audit/audit.log
Rule: 80792 (level 3) -&gt; 'Audit: Command: /bin/cat'
type=SYSCALL msg=audit(1584080579.013:3751): arch=c000003e syscall=59 success=yes exit=0 a0=55ad181dcb80 a1=55ad181dcc20 a2=55ad181aa130 a3=55ad18191010 items=2 ppid=5022 pid=9174 auid=1000 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts2 ses=5 comm=&quot;cat&quot; exe=&quot;/bin/cat&quot; key=&quot;audit-wazuh-c&quot; type=EXECVE msg=audit(1584080579.013:3751): argc=2 a0=&quot;cat&quot; a1=&quot;audit-keys&quot; type=CWD msg=audit(1584080579.013:3751): cwd=&quot;/var/ossec/etc/lists&quot; type=PATH msg=audit(1584080579.013:3751): item=0 name=&quot;/bin/cat&quot; inode=1048601 dev=08:01 mode=0100755 ouid=0 ogid=0 rdev=00:00 nametype=NORMAL cap_fp=0 cap_fi=0 cap_fe=0 cap_fver=0 cap_frootid=0 type=PATH msg=audit(1584080579.013:3751): item=1 name=&quot;/lib64/ld-linux-x86-64.so.2&quot; inode=398521 dev=08:01 mode=0100755 ouid=0 ogid=0 rdev=00:00 nametype=NORMAL cap_fp=0 cap_fi=0 cap_fe=0 cap_fver=0 cap_frootid=0 type=PROCTITLE msg=audit(1584080579.013:3751): proctitle=6361740061756469742D6B657973
audit.type: SYSCALL
audit.id: 3751
audit.arch: c000003e
audit.syscall: 59
audit.success: yes
audit.exit: 0
audit.ppid: 5022
audit.pid: 9174
audit.auid: 1000
audit.uid: 0
audit.gid: 0
audit.euid: 0
audit.suid: 0
audit.fsuid: 0
audit.egid: 0
audit.sgid: 0
audit.fsgid: 0
audit.tty: pts2
audit.session: 5
audit.command: cat
audit.exe: /bin/cat
audit.key: audit-wazuh-c
audit.execve.a0: cat
audit.execve.a1: audit-keys
audit.cwd: /var/ossec/etc/lists
audit.file.name: /bin/cat
audit.file.inode: 1048601
audit.file.mode: 0100755

</code></pre>

<h3 id="5">5.代码分析</h3>
<h4 id="51">5.1 代码结构分析</h4>
<p>​        <img alt="img" src="https://uploader.shimo.im/f/ySI7jElBxJMnpNBK.png!thumbnail" />      </p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../wazuh性能分析/" class="btn btn-neutral float-right" title="Wazuh性能分析">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../vuls分析/" class="btn btn-neutral" title="Vuls分析"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../vuls分析/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../wazuh性能分析/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>

</body>
</html>
