<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Wazuh性能分析 - expwiki</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Wazuh\u6027\u80fd\u5206\u6790";
    var mkdocs_page_input_path = "wazuh\u6027\u80fd\u5206\u6790.md";
    var mkdocs_page_url = "/wazuh\u6027\u80fd\u5206\u6790/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> expwiki</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../acknowledgements/">Acknowledgements</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2018-1000001-01/">Cve 2018 1000001 01</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2018-1000001/">Cve 2018 1000001</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2019-12735-01/">Cve 2019 12735 01</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2019-12735/">Cve 2019 12735</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../lynis分析/">Lynis分析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../vuls分析/">Vuls分析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../wazuh分析/">Wazuh分析</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Wazuh性能分析</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#wazuh">wazuh性能分析</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#1">1.概述</a></li>
        
            <li><a class="toctree-l3" href="#2">2.环境</a></li>
        
            <li><a class="toctree-l3" href="#3">3.测试</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../漏洞利用知识库模版/">漏洞利用知识库模版</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">expwiki</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Wazuh性能分析</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="wazuh">wazuh性能分析</h1>
<h3 id="1">1.概述</h3>
<p>测试目标：分析wazuh使用审计(auditd)记录系统调用功能给系统带来的性能损失。</p>
<p>结论如下：</p>
<ul>
<li>进程运行时耗：开启wazuh的审计记录系统调用的功能后，进程的执行速度会降低83.77%之多，且性能损失主要来自auditd。</li>
<li>CPU占用率：在单核CPU系统上，系统内核CPU占用率平均会增加6.8%，用户态基本无影响</li>
</ul>
<p>​        <img alt="img" src="https://uploader.shimo.im/f/5voz0PYcreswdYXO.png!thumbnail" />      </p>
<p>​        <img alt="img" src="https://uploader.shimo.im/f/K8O8fkHruiYfFW5F.png!thumbnail" />      </p>
<h3 id="2">2.环境</h3>
<p>系统信息:</p>
<pre><code>&quot;data&quot;: {
      &quot;os&quot;: {
         &quot;codename&quot;: &quot;Bionic Beaver&quot;,
         &quot;major&quot;: &quot;18&quot;,
         &quot;minor&quot;: &quot;04&quot;,
         &quot;name&quot;: &quot;Ubuntu&quot;,
         &quot;platform&quot;: &quot;ubuntu&quot;,
         &quot;version&quot;: &quot;18.04.3 LTS (Bionic Beaver)&quot;
      },
      &quot;hostname&quot;: &quot;ubuntu-virtual-machine&quot;,
      &quot;version&quot;: &quot;#32~18.04.1-Ubuntu SMP Mon Feb 3 14:05:59 UTC 2020&quot;,
      &quot;architecture&quot;: &quot;x86_64&quot;,
      &quot;release&quot;: &quot;5.3.0-40-generic&quot;,
      &quot;sysname&quot;: &quot;Linux&quot;
}

</code></pre>

<p>硬件信息:</p>
<pre><code>&quot;data&quot;: {
      &quot;cpu&quot;: {
         &quot;cores&quot;: 1,
         &quot;mhz&quot;: 2495.391,
         &quot;name&quot;: &quot;Intel(R) Core(TM) i7-7660U CPU @ 2.50GHz&quot;
      },
      &quot;ram&quot;: {
         &quot;free&quot;: 3167704,
         &quot;total&quot;: 4002256,
         &quot;usage&quot;: 21
      }
}

</code></pre>

<h3 id="3">3.测试</h3>
<h4 id="_1">测试一</h4>
<p>测试方案：对比开启审计前后，执行相同程序所使用的时间。测试程序(开启子进程执行若干次 cat call_syscalls.py &gt; /dev/null 命令): </p>
<pre><code># python3
# call_syscalls.py
import subprocess
import sys
import time

def main():
    loop = int(sys.argv[1]) if len(sys.argv) &gt; 1 else 3000
    start_time = time.time()
    for i in range(loop):
        cmd = &quot;cat {} &gt;/dev/null&quot;.format(sys.argv[0])
        proc = subprocess.Popen(cmd, shell=True)
        proc.wait()
    end_time = time.time()
    print('Done after {}s.'.format(int(end_time - start_time)))


if __name__ == '__main__':
    main()

</code></pre>

<p>执行一次的系统调用统计情况：</p>
<pre><code>root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# strace -f -c -o strace_log python3 call_syscalls.py 1
Done after 0s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# cat strace_log 
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 41.49    0.000407           2       230        33 stat
 19.16    0.000188           2        83         2 openat
 12.84    0.000126           6        21           brk
  9.28    0.000091           1       119           read
  6.01    0.000059           0       136           fstat
  5.10    0.000050           1        91           close
  3.06    0.000030           0        61         6 lseek
  2.45    0.000024           1        20           getdents
  0.61    0.000006           0        58           mmap
  0.00    0.000000           0         2           write
  0.00    0.000000           0         9           lstat
  0.00    0.000000           0        24           mprotect
  0.00    0.000000           0        16           munmap
  0.00    0.000000           0        77           rt_sigaction
  0.00    0.000000           0         1           rt_sigprocmask
  0.00    0.000000           0         1           rt_sigreturn
  0.00    0.000000           0        14         3 ioctl
  0.00    0.000000           0        15        15 access
  0.00    0.000000           0         3           dup
  0.00    0.000000           0         2           dup2
  0.00    0.000000           0         2           getpid
  0.00    0.000000           0         2           clone
  0.00    0.000000           0         3           execve
  0.00    0.000000           0         2           wait4
  0.00    0.000000           0         5           fcntl
  0.00    0.000000           0         1           getcwd
  0.00    0.000000           0         4         2 readlink
  0.00    0.000000           0         1           sysinfo
  0.00    0.000000           0         2           getuid
  0.00    0.000000           0         2           getgid
  0.00    0.000000           0         3           geteuid
  0.00    0.000000           0         2           getegid
  0.00    0.000000           0         1           getppid
  0.00    0.000000           0         3           sigaltstack
  0.00    0.000000           0         3           arch_prctl
  0.00    0.000000           0         1           futex
  0.00    0.000000           0         2           getdents64
  0.00    0.000000           0         1           set_tid_address
  0.00    0.000000           0         1           fadvise64
  0.00    0.000000           0         2           set_robust_list
  0.00    0.000000           0         1           pipe2
  0.00    0.000000           0         1           prlimit64
  0.00    0.000000           0         1           getrandom
------ ----------- ----------- --------- --------- ----------------
100.00    0.000981                  1029        61 total
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# 

</code></pre>

<p>辅助程序(用于设置和删除审计的规则，对所有系统调用做监控):</p>
<pre><code># python3
# test_ctl.py
import subprocess
import sys

def start():
    audit_cmd = &quot;auditctl -a always,exit -F arch=b64 -F key=audit-wazuh-c -S &quot;
    res = subprocess.check_output(&quot;ausyscall --dump&quot;, shell=True).decode()
    audit_cmd += &quot;,&quot;.join(line.split()[1] for line in res.split('\n')[1:] if line.strip())
    proc = subprocess.Popen(audit_cmd, shell=True)
    proc.wait()
    print(subprocess.check_output(&quot;auditctl -l&quot;, shell=True).decode())


def stop():
    proc = subprocess.Popen(&quot;auditctl -D&quot;, shell=True)
    proc.wait()



def main():
    if len(sys.argv) &gt; 1:
        if sys.argv[1] == &quot;start&quot;:
            print(&quot;Start&quot;)
            start()
        elif sys.argv[1] == &quot;stop&quot;:
            print(&quot;Stop&quot;)
            stop()
        else:
            exit()
    else:
        exit()


if __name__ == '__main__':
    main()

</code></pre>

<p>执行测试：</p>
<p>1.不开启审计，不启动wazuh Agent</p>
<pre><code>root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# auditctl -l
No rules
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# service wazuh-agent stop
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 6s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 6s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 6s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 7s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 6s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# 

</code></pre>

<p>执行5000次循环，5次的平均执行时间为6.2秒</p>
<p>2.开启审计，监控所有系统调用，并开启wazuh Agent的系统调用监控功能(已经提取配置好)</p>
<pre><code>root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# service wazuh-agent start
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 test_ctl.py start
Start
-a always,exit -F arch=b64 -S read,write,open,close,stat,fstat,lstat,poll,lseek,mmap,mprotect,munmap,brk,rt_sigaction,rt_sigprocmask,rt_sigreturn,ioctl,pread,pwrite,readv,writev,access,pipe,select,sched_yield,mremap,msync,mincore,madvise,shmget,(省略...),statx -F key=audit-wazuh-c


root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 39s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 40s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 40s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 38s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 34s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools

</code></pre>

<p>执行5000次循环，5次的平均执行时间为38.2秒</p>
<p>3.在第二次的基础上关闭wazuh agent服务(只开启审计的监控系统调用功能)</p>
<pre><code>root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# service wazuh-agent stop
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 33s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 32s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 30s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 30s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# python3 call_syscalls.py 5000
Done after 31s.
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# 

</code></pre>

<p>执行5000次循环，5次的平均执行时间为31.2秒</p>
<h4 id="_2">测试二</h4>
<p>测试方案：与测试一相同，区别是把测试程序改为C语言程序，测试opne、read、close三个系统调用的时耗</p>
<p>测试程序：</p>
<pre><code>#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;sys/time.h&gt;

int main(){
    struct timeval start;
    struct timeval end;
    long time_use = 0;

    gettimeofday(&amp;start,NULL);
    for(int i=0;i&lt;1000000;i++){
        char tmp[10];
        int fd = open(&quot;run.c&quot;, O_RDWR);
        if(read(fd, tmp, 10) != 10){
            printf(&quot;error\n&quot;);
            return -1;
        }
        if(close(fd) != 0){
            printf(&quot;error\n&quot;);
            return -1;
        }
    }
    gettimeofday(&amp;end,NULL);
    time_use= end.tv_sec - start.tv_sec;
    printf(&quot;Done after %lds\n&quot;, time_use);
}

</code></pre>

<p>运行结果：</p>
<p>开启审计前</p>
<pre><code>root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run 
Done after 5s
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run 
Done after 5s
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run 
Done after 5s
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run 
Done after 6s
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run 
Done after 7s

</code></pre>

<p>开启审计后</p>
<pre><code>root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run
Done after 19s
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run
Done after 20s
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run
Done after 21s
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run
Done after 21s
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run
Done after 21s

</code></pre>

<p>性能损失率：70.0%</p>
<h4 id="_3">测试三</h4>
<p>测试方案：与测试一相同，区别是把测试程序改为C语言程序，测试mmap和munmap两个系统调用的时耗</p>
<p>测试程序：</p>
<pre><code>#include &lt;sys/types.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;stdio.h&gt;
#include &lt;sys/time.h&gt;


int main(){
    struct timeval start;
    struct timeval end;
    float time_use = 0;

    int fd = open(&quot;run_mmap.c&quot;, O_RDONLY);
    if(fd &lt; 0){
        printf(&quot;error\n&quot;);
        return -1;
    }


    gettimeofday(&amp;start,NULL);
    for(int i; i&lt;20000000; i++){


        void *addr = mmap(NULL, 10, PROT_READ, MAP_PRIVATE, fd, 0);
        if(addr == MAP_FAILED){
            printf(&quot;error\n&quot;);
            return -1;
        }
        if(munmap(addr, 10) != 0){
            printf(&quot;error\n&quot;);
            return -1;
        }

    }
    gettimeofday(&amp;end,NULL);
    time_use=(end.tv_sec-start.tv_sec)*1000000+(end.tv_usec-start.tv_usec);
    //time_use= end.tv_sec-start.tv_sec;
    if(close(fd) != 0){
        printf(&quot;error\n&quot;);
        return -1;
    }
    printf(&quot;Done after %fμs\n&quot;, time_use);

}

</code></pre>

<p>开启审计前:</p>
<pre><code>root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run_mmap 
Done after 18826420.000000μs
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run_mmap 
Done after 19980384.000000μs
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run_mmap 
Done after 19807356.000000μs
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run_mmap 
Done after 21779724.000000μs
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run_mmap 
Done after 21440176.000000μs

</code></pre>

<p>开启审计后：</p>
<pre><code>root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run_mmap 
Done after 80555072.000000μs
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run_mmap 
Done after 75856544.000000μs
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run_mmap 
Done after 81079392.000000μs
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run_mmap 
Done after 90686256.000000μs
root@ubuntu-virtual-machine:/home/ubuntu/Desktop/tools# ./run_mmap 
Done after 78594544.000000μs


</code></pre>

<p>性能损失率：75.0%</p>
<h4 id="_4">测试四</h4>
<pre><code>测试方案：在测试一结论基础上，使用vmstat对比CPU使用率
执行测试：
1.不开启审计，不启动wazuh Agent
本次测试共进行了四次，vmstate的结果如下:
第一次：用户态CPU占用率平均值19.2%，内核态75.5%
第二次：用户态CPU占用率平均值21.4%，内核态74.2%
第三次：用户态CPU占用率平均值25%，内核态74.5%
第四次：用户态CPU占用率平均值21.4%，内核态72.5%

2.开启审计，监控所有系统调用，并开启wazuh Agent的系统调用监控功能(已经提取配置好)
本次测试共进行了四次，vmstate的结果如下:
第一次：用户态CPU占用率平均值18%，内核态82%
第二次：用户态CPU占用率平均值21.5%，内核态78.5%
第三次：用户态CPU占用率平均值21.2%，内核态82.5%
第四次：用户态CPU占用率平均值17.5%，内核态81.5%

</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../漏洞利用知识库模版/" class="btn btn-neutral float-right" title="漏洞利用知识库模版">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../wazuh分析/" class="btn btn-neutral" title="Wazuh分析"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../wazuh分析/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../漏洞利用知识库模版/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>

</body>
</html>
