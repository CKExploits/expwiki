# Docker runc容器逃逸漏洞分析(CVE-2019-5736) 

## 0. 作者

invincible1944@gmail.com


## 1. 背景介绍  

- 漏洞相关软件：`Docker < 18.09.2/runc < 1.0-rc6`

- docker/runc简介
    - runc是一个根据OCI（Open Container Initiative）标准创建并运行容器的CLI tool。
    - OCI (Open Container Initiative)开放容器计划是Linux基金会的一个项目，旨在为操作系统级虚拟化（最重要的是Linux容器）设计开放标准。
    - Docker是基于runc的容器管理平台，容器的创建，运行，销毁等等操作都通过调用runc完成。


- 漏洞危害
    - 当运行一个恶意构造的容器时，容器内运行的恶意进程能够修改宿主机中的runc可执行文件，当再次使用Docker命令时，会以root权限加载并执行修改后的runc可执行文件，从而实现容器逃逸。
  

- 相关背景知识  
见附件：cve-2019-5736-01

## 2. 漏洞分析
- 漏洞原理：由于namespace隔离不完全，容器内进程可以通过/proc/self/exe符号链接，修改容器外的runc可执行文件，从而借助runc执行任意代码，实现容器逃逸。  

- 漏洞所属软件链接，版本，模块，目录，文件，代码行
    - 漏洞软件版本：`runc < 1.0-rc6`
    - 漏洞代码位置：`runc/libcontainer/nsenter/nsexec.c -> nsexec()`  
    - [runc 源码库](https://github.com/opencontainers/runc/releases)  

- 漏洞所属类型：容器逃逸漏洞

- 漏洞补丁：[merge branch 'cve-2019-5736'](https://github.com/opencontainers/runc/commit/6635b4f0c6af3810594d2770f662f34ddc15b40d)

- 漏洞CVE号：[CVE-2019-5736](https://nvd.nist.gov/vuln/detail/CVE-2019-5736)

## 3. POC

##### a. POC原理
  通过修改容器内的libseccomp包的源码，注入恶意代码；runc在运行容器时，会加载libseccomp包，恶意代码以此在容器中执行，并获取容器外runc进程的pid，然后通过符号链接`/proc/self/exe`，写入任意内容到runc的二进制文件。
  具体见附件：cve-2018-1000001-01  

##### b. POC源码
github：[PoC](https://github.com/q3k/cve-2019-5736-poc)  
复现环境PoC见附件：cve-2018-1000001-01  

##### c. 复现步骤
- 复现环境
    - 环境清单
            - 系统版本: Ubuntu 18.04.4 LTS (Bionic Beaver)  
            - docker版本: Docker version 17.12.1-ce, build 7390fc6
            - runc版本: runc version 1.0.0-rc4+dev
            - 虚拟机软件：VMwareFusion 专业版 11.5.1 (15018442)
            - 虚拟机软件：QEMU emulator version 4.2.0
    - 环境搭建：见附件：cve-2018-1000001-01  

- Step1 - 构建恶意容器
```
# 下载并解压Poc
root# ls -l
total 16
-rwxr-xr-x 1 invincible invincible 624 Apr  8 00:36 Dockerfile
-rwxr-xr-x 1 invincible invincible 249 Feb 11  2019 README
-rwxr-xr-x 1 invincible invincible 672 Apr  8 00:38 stage1.c
-rwxr-xr-x 1 invincible invincible 390 Feb 11  2019 stage2.c

# 这一步需要一些时间
root# docker bulid -t cve .
Sending build context to Docker daemon  6.144kB
Step 1/8 : FROM ubuntu:18.04
...
```
- Step2 - 运行容器
```
root# docker run cve
HAX2: argv: /proc/self/fd/3
HAX2: fd: 4
HAX2: res: 13, 0
```
- 查看PoC 效果
```
root# strings /usr/bin/docker-runc | tail -n 2
.debug_gdb_scripts
cve-2019-5736
```

## 4. EXP

##### a. EXP原理
  同PoC原理类似，只是将覆盖runc可执行文件的内容修改为能够建立远程会话的恶意二进制文件。  

  具体见附件：cve-2018-1000001-01  

##### b. EXP源码 
  exp-db: [exp](https://www.exploit-db.com/exploits/46359)  
  见附件：cve-2018-1000001-01  

##### c. 复现步骤
- 搭建复现环境，与POC中的环境相同
- 步骤一 
```
```

### d. 利用核心要素
- 在容器内获取runc进程的pid
- 将/proc/self/exe修改为恶意二进制文件


## 5. 防护建议

结合漏洞原理和利用原理，从防护产品研发的角度，提出：

a. 如何检测这个/类漏洞

b. 如何防御这个/类漏洞

c. 有没有哪种通用的缓解措施可以阻断这个/类漏洞

## 6.参考

[https://bestwing.me/CVE-2019-5736-Docker-escape.html](https://bestwing.me/CVE-2019-5736-Docker-escape.html)
[https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html](https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html)



