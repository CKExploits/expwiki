<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Vuls分析 - expwiki</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Vuls\u5206\u6790";
    var mkdocs_page_input_path = "vuls\u5206\u6790.md";
    var mkdocs_page_url = "/vuls\u5206\u6790/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> expwiki</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../acknowledgements/">Acknowledgements</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2018-1000001-01/">Cve 2018 1000001 01</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2018-1000001/">Cve 2018 1000001</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2019-12735-01/">Cve 2019 12735 01</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../cve-2019-12735/">Cve 2019 12735</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../lynis分析/">Lynis分析</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Vuls分析</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#vuls">Vuls分析</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#1">1. 简介</a></li>
        
            <li><a class="toctree-l3" href="#2">2. 架构概述</a></li>
        
            <li><a class="toctree-l3" href="#3">3.功能描述</a></li>
        
            <li><a class="toctree-l3" href="#4">4.代码分析</a></li>
        
            <li><a class="toctree-l3" href="#5">5.特点分析</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../wazuh分析/">Wazuh分析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../wazuh性能分析/">Wazuh性能分析</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../漏洞利用知识库模版/">漏洞利用知识库模版</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">expwiki</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Vuls分析</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="vuls">Vuls分析</h1>
<h3 id="1">1. 简介</h3>
<p>vulns是一个基于go语言的开源漏洞扫描项目，它能对目标主机的安装包、库文件进行漏洞检测，另外还支持Wordpress漏洞检测。</p>
<h3 id="2">2. 架构概述</h3>
<p>Vuln的架构可以分为三个模块：扫描模块，数据库模块，报告生成模块。</p>
<ul>
<li>扫描模块包含：scanPackages、postScan、scanWordPress、scanLibraries几大功能。</li>
<li>数据库模块：主要是存储漏洞库，用于生成报告。</li>
<li>报告生成模块：根据扫描模块的结果，结合漏洞数据库的信息生成报告。</li>
</ul>
<h3 id="3">3.功能描述</h3>
<p><strong>scanPackages</strong></p>
<p>通过执行dpkg，apt-get等命令，获取系统的所有安装包，并通过拉取软件包changelog，以正则匹配的方式提取其中的漏洞相关信息。</p>
<p><strong>postScan</strong></p>
<p>搜集安装的packages对当前运行的进程的影响。</p>
<p>通过执行shell指令，读取/proc/pid/目录下的数据，获取当前运行的进程列表、进程对应的二进制文件、进程加载的文件，进而获取进程加载的package信息，然后根据包名完善scanPackages阶段获取的base.Packages字典的信息，补充Package对象的AffectedProcs字段，即该package影响的进程。</p>
<p><strong>scanWordPress</strong></p>
<p>主要是通过执行wp命令获取Wordpress 版本信息，安装的主题相关信息，安装的插件相关信息。</p>
<p><strong>scanLibraries</strong></p>
<p>基于 aquasecurity项目提供的fanal等开源库对python、ruby、rust、php、node语言的工程项目中的依赖包中提取依赖的库，根据提取的信息匹配漏洞库判断是否存在漏洞。</p>
<h3 id="4">4.代码分析</h3>
<h4 id="41">4.1 代码架构</h4>
<p><img alt="图片" src="https://uploader.shimo.im/f/RFscDPty870fZejX.png!thumbnail" /></p>
<h4 id="42">4.2 代码分析</h4>
<p><strong>核心的扫描逻辑</strong></p>
<pre><code>func GetScanResults(scannedAt time.Time, timeoutSec int) (results models.ScanResults, err error) {
    parallelExec(func(o osTypeInterface) (err error) {
        if !(config.Conf.LibsOnly || config.Conf.WordPressOnly) {
            if err = o.preCure(); err != nil {
                return err
            }
            if err = o.scanPackages(); err != nil {
                return err
            }
            if err = o.postScan(); err != nil {
                return err
            }
        }
        if err = o.scanWordPress(); err != nil {
            return xerrors.Errorf(&quot;Failed to scan WordPress: %w&quot;, err)
        }
        if err = o.scanLibraries(); err != nil {
            return xerrors.Errorf(&quot;Failed to scan Library: %w&quot;, err)
        }
        return nil
    }, timeoutSec)
...
</code></pre>

<p><strong>postScan的主要执行函数</strong></p>
<pre><code>func (o *debian) dpkgPs() error {
    stdout, err := o.ps()
    ...
    pidNames := o.parsePs(stdout)
    pidLoadedFiles := map[string][]string{}


    for pid := range pidNames {
        ...
        stdout, err = o.lsProcExe(pid)
        ...
        s, err := o.parseLsProcExe(stdout)
        ...
        pidLoadedFiles[pid] = append(pidLoadedFiles[pid], s)
        stdout, err = o.grepProcMap(pid)
        ...
        ss := o.parseGrepProcMap(stdout)
        pidLoadedFiles[pid] = append(pidLoadedFiles[pid], ss...)
    }


    pidListenPorts := map[string][]string{}
    stdout, err = o.lsOfListen()
    ...
    portPid := o.parseLsOf(stdout)
    for port, pid := range portPid {
        pidListenPorts[pid] = append(pidListenPorts[pid], port)
    }


    for pid, loadedFiles := range pidLoadedFiles {
        o.log.Debugf(&quot;dpkg -S %#v&quot;, loadedFiles)
        pkgNames, err := o.getPkgName(loadedFiles)
        ...
        procName := &quot;&quot;
        if _, ok := pidNames[pid]; ok {
            procName = pidNames[pid]
        }
        proc := models.AffectedProcess{
            PID:         pid,
            Name:        procName,
            ListenPorts: pidListenPorts[pid],
        }
        for _, n := range pkgNames {
            p, ok := o.Packages[n]
            ...
            p.AffectedProcs = append(p.AffectedProcs, proc)
            o.Packages[p.Name] = p
        }
    }
    return nil
}
</code></pre>

<p>postScan 函数调用的子函数主要执行了下面的命令：</p>
<pre><code>LANGUAGE=en_US.UTF-8 ps --no-headers --ppid 2 -p 2 --deselect -o pid,comm
执行ps命令，输出格式为 pid  processname
root@ubuntu:/var/ossec/bin# ps --no-headers --ppid 2 -p 2 --deselect -o pid,comm     
   1 systemd
   419 systemd-journal
   460 systemd-udevd
   ...


ls -l /proc/%s/exe&quot;, pid
获得进程的可执行文件的完整路径
`cat /proc/%s/maps 2&gt;/dev/null | grep -v &quot; 00:00 &quot; | awk '{print $6}' | sort -n | uniq`, pid
从进程的内存map中提取加载的文件
ls -i -P -n|grep LISTEN 
获取正在监听网络端口的进程的PID和监听的端口号
dpkg -S paths  
获取文件对应的package信息
</code></pre>

<p><strong>scanPackage的主要执行函数</strong></p>
<p>scanPackages -&gt; scanInstalledPackages </p>
<pre><code>const dpkgQuery = `dpkg-query -W -f=&quot;\${binary:Package},\${db:Status-Abbrev},\${Version},\${Source},\${source:Version}\n&quot;`


func (o *debian) scanInstalledPackages() (models.Packages, models.Packages, models.SrcPackages, error) {
    updatable := models.Packages{}
    r := o.exec(dpkgQuery, noSudo)
    ...
    installed, srcPacks, err := o.parseInstalledPackages(r.Stdout)
    ...
    updatableNames, err := o.getUpdatablePackNames()
    ...
    for _, name := range updatableNames {
        for _, pack := range installed {
            if pack.Name == name {
                updatable[name] = pack
                break
            }
        }
    }
    // Fill the candidate versions of upgradable packages
    err = o.fillCandidateVersion(updatable)
    ...
    installed.MergeNewVersion(updatable)
    return installed, updatable, srcPacks, nil
}
</code></pre>

<p>scanInstalledPackages函数主要是通过执行下面的指令获取系统安装的package并对结果解析</p>
<pre><code>root@ubuntu:/var/ossec/bin# dpkg-query -W -f=&quot;\${binary:Package},\${db:Status-Abbrev},\${Version},\${Source},\${source:Version}\n&quot;
accountsservice,ii ,0.6.45-1ubuntu1,,0.6.45-1ubuntu1
acl,ii ,2.2.52-3build1,,2.2.52-3build1
acpi-support,ii ,0.142,,0.142
acpid,ii ,1:2.0.28-1ubuntu1,,1:2.0.28-1ubuntu1
...
</code></pre>

<p>scanPackages -&gt; scanUnsecurePackages -&gt; scanChangelogs -&gt;  getChangelogCache -&gt; <strong>fetchParseChangelog</strong> -&gt; getCveIDsFromChangelog -&gt;  <strong>parseChangelog</strong></p>
<pre><code>
func (o *debian) fetchParseChangelog(pack models.Package) ([]DetectedCveID, *models.Package, error) {
    cmd := &quot;&quot;
    switch o.Distro.Family {
    case config.Ubuntu, config.Raspbian:
        cmd = fmt.Sprintf(`PAGER=cat apt-get -q=2 changelog %s`, pack.Name)
    case config.Debian:
        cmd = fmt.Sprintf(`PAGER=cat aptitude -q=2 changelog %s`, pack.Name)
    }
    ...
    r := o.exec(cmd, noSudo)
    ...
    cveIDs, clogFilledPack := o.getCveIDsFromChangelog(stdout, pack.Name, pack.Version)
    ...
    return cveIDs, clogFilledPack, nil
}

var cveRe = regexp.MustCompile(`(CVE-\d{4}-\d{4,})`)

func (o *debian) parseChangelog(changelog, name, ver string, confidence models.Confidence) ([]DetectedCveID, *models.Package, error) {
    ...
    buf, cveIDs := []string{}, []string{}
    scanner := bufio.NewScanner(strings.NewReader(changelog))
    found := false
    for scanner.Scan() {
        line := scanner.Text()
        buf = append(buf, line)
        if matches := cveRe.FindAllString(line, -1); 0 &lt; len(matches) {
            for _, m := range matches {
                cveIDs = util.AppendIfMissing(cveIDs, m)
            }
        }
        ...
    }
    ...
    pack := o.Packages[name]
    pack.Changelog = clog

    cves := []DetectedCveID{}
    for _, id := range cveIDs {
        cves = append(cves, DetectedCveID{id, confidence})
    }

    return cves, &amp;pack, nil
</code></pre>

<p>}</p>
<p>fetchParseChangelog 执行下面的命令获取package的changelog</p>
<pre><code>PAGER=cat apt-get -q=2 changelog pack.Name
</code></pre>

<p>parseChangelog 函数对changelog做正则匹配提取相关的漏洞信息</p>
<p><strong>scanWordPress主要执行函数</strong></p>
<pre><code>func (l *base) detectWordPress() (*models.WordPressPackages, error) {
    ver, err := l.detectWpCore()
    ...
    themes, err := l.detectWpThemes()
    ...
    plugins, err := l.detectWpPlugins()
    ...
    pkgs := models.WordPressPackages{
        models.WpPackage{
            Name:    models.WPCore,
            Version: ver,
            Type:    models.WPCore,
        },
    }
    pkgs = append(pkgs, themes...)
    pkgs = append(pkgs, plugins...)
    return &amp;pkgs, nil
}
</code></pre>

<p>主要执行了下面几个命令:</p>
<pre><code>&quot;sudo -u osuser -i -- /path/to/wp core version --path=DocRoot --allow-root&quot;
获取wp的版本信息
&quot;sudo -u osuser -i -- /path/to/wp theme list --path=DocRoot --format=json --allow-root 2&gt;/dev/null&quot;
获取wp theme列表
&quot;sudo -u osuser -i -- /path/to/wp plugin list --path=DocRoot --format=json --allow-root 2&gt;/dev/null&quot;
获取wp theme列表
</code></pre>

<h3 id="5">5.特点分析</h3>
<ul>
<li>核心功能：漏洞扫描，主要是依据package的changelog中提供的信息来判断主机安装的package版本是否有漏洞，然后通过正在运行的进程中提取依赖的包来判断是否有正在运行的进程受到漏洞的影响。</li>
<li>扩展性方面: 可以通过增加库文件的方式扩展，但需要同时修改核心文件，耦合性比较高</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../wazuh分析/" class="btn btn-neutral float-right" title="Wazuh分析">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../lynis分析/" class="btn btn-neutral" title="Lynis分析"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../lynis分析/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../wazuh分析/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../js/theme.js"></script>

</body>
</html>
